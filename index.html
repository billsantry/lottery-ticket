<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<title>NOT A LOTTERY TICKET: 8-BIT FUTURES</title>

<!-- Open Graph (LinkedIn Preview) -->
<meta property="og:type" content="website">
<meta property="og:title" content="NOT A LOTTERY TICKET: 8-BIT FUTURES">
<meta property="og:description" content="A retro strategy game inspired by Peter Thiel‚Äôs 'You Are Not a Lottery Ticket.' Choose a worldview. Allocate resources. Shape your future across 12 years.">
<meta property="og:url" content="https://lottery.billsantry.com/">
<meta property="og:image" content="https://lottery.billsantry.com/preview.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:alt" content="Screenshot of NOT A LOTTERY TICKET gameplay">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="NOT A LOTTERY TICKET: 8-BIT FUTURES">
<meta name="twitter:description" content="Choose a worldview. Allocate resources. Shape your future across 12 years.">
<meta name="twitter:image" content="https://lottery.billsantry.com/preview.png">
  
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

:root {
  --bg: #0a0a14;
  --panel: #101028;
  --panel-hi: #181840;
  --border: #2a2a5a;
  --text: #c8c8e0;
  --dim: #5a5a7a;
  --accent: #ffcc00;
  --do: #00e5ff;
  --io: #ff6ec7;
  --dp: #76ff03;
  --ip: #ff9100;
  --danger: #ff1744;
  --success: #00e676;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: #000;
  color: var(--text);
  font-family: 'Press Start 2P', monospace;
  overflow: hidden;
  height: 100vh;
  width: 100vw;
  display: flex;
  align-items: center;
  justify-content: center;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
  padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}

#crt {
  pointer-events: none;
  position: fixed;
  inset: 0;
  z-index: 9999;
  background: repeating-linear-gradient(0deg, rgba(0,0,0,0.06) 0px, rgba(0,0,0,0.06) 1px, transparent 1px, transparent 3px);
}
#crt::after {
  content:'';
  position:fixed;
  inset:0;
  background: radial-gradient(ellipse at center, transparent 55%, rgba(0,0,0,0.4) 100%);
}

#game-root {
  /* Size the box at 1/1.4, then zoom scales it back to fill the same space */
  width: min(calc(100vw / 1.4), calc(100vh * 4 / 3 / 1.4));
  height: min(calc(100vh / 1.4), calc(100vw * 3 / 4 / 1.4));
  max-width: calc(1200px / 1.4);
  max-height: calc(900px / 1.4);
  zoom: 1.4;
  position: relative;
  transition: transform 0.05s;
  background: var(--bg);
  border: 2px solid #1a1a3a;
  box-shadow: 0 0 40px rgba(0,0,0,0.8), 0 0 80px rgba(0,0,0,0.5);
  overflow: hidden;
}
#game-root.shake { animation: shakeAnim 0.4s ease-out; }
@keyframes shakeAnim {
  0% { transform: translate(0,0); }
  15% { transform: translate(-8px, 4px); }
  30% { transform: translate(6px, -6px); }
  45% { transform: translate(-4px, 2px); }
  60% { transform: translate(3px, -3px); }
  75% { transform: translate(-2px, 1px); }
  100% { transform: translate(0,0); }
}

#particles {
  position: fixed;
  inset: 0;
  z-index: 50;
  pointer-events: none;
}

.float-popup {
  position: fixed;
  z-index: 60;
  font-family: 'Press Start 2P', monospace;
  font-size: 12px;
  pointer-events: none;
  animation: floatUp 1.2s ease-out forwards;
  text-shadow: 0 0 8px currentColor;
}
@keyframes floatUp {
  0% { opacity:1; transform: translateY(0) scale(1); }
  60% { opacity:1; transform: translateY(-50px) scale(1.2); }
  100% { opacity:0; transform: translateY(-90px) scale(0.8); }
}

#combo-banner {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0);
  z-index: 70;
  font-size: 14px;
  color: var(--accent);
  text-shadow: 0 0 20px rgba(255,204,0,0.8), 0 0 40px rgba(255,204,0,0.4);
  pointer-events: none;
  opacity: 0;
  white-space: nowrap;
  text-align: center;
  max-width: 90vw;
}
#combo-banner.show { animation: comboPop 1.5s ease-out forwards; }
@keyframes comboPop {
  0% { opacity:0; transform: translate(-50%,-50%) scale(0.3) rotate(-5deg); }
  15% { opacity:1; transform: translate(-50%,-50%) scale(1.3) rotate(2deg); }
  30% { transform: translate(-50%,-50%) scale(1) rotate(0deg); }
  70% { opacity:1; }
  100% { opacity:0; transform: translate(-50%,-50%) scale(1.5); }
}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen { display:none; position:absolute; inset:0; }
.screen.active {
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}

/* ‚îÄ‚îÄ TITLE ‚îÄ‚îÄ */
#title-screen { text-align: center; padding: 20px; }

.title-main {
  font-size: 10px;
  color: var(--accent);
  letter-spacing: 3px;
  line-height: 2;
  text-shadow: 0 0 15px rgba(255,204,0,0.5);
  animation: titleGlow 2s ease-in-out infinite alternate;
  margin-bottom: 4px;
}
@keyframes titleGlow {
  from { text-shadow: 0 0 10px rgba(255,204,0,0.4); }
  to { text-shadow: 0 0 25px rgba(255,204,0,0.8), 0 2px 30px rgba(255,204,0,0.3); }
}

.title-sub {
  font-size: 7px;
  color: var(--dim);
  margin-bottom: 40px;
  line-height: 1.8;
}

.title-coin {
  font-size: 28px;
  margin: 16px 0 24px;
  animation: coinSpin 3s linear infinite;
  display: inline-block;
}
@keyframes coinSpin {
  0% { transform: scaleX(1); }
  25% { transform: scaleX(0.1); }
  50% { transform: scaleX(1); }
  75% { transform: scaleX(0.1); }
  100% { transform: scaleX(1); }
}

.menu-btn {
  display: block;
  width: 320px;
  margin: 6px auto;
  padding: 14px 18px;
  background: transparent;
  border: 2px solid var(--border);
  color: var(--text);
  font-family: 'Press Start 2P', monospace;
  font-size: 9px;
  cursor: pointer;
  text-align: center;
  transition: all 0.15s;
  position: relative;
  overflow: hidden;
}
.menu-btn::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(90deg, transparent, rgba(255,204,0,0.1), transparent);
  transform: translateX(-100%);
  transition: transform 0.4s;
}
.menu-btn:hover::before { transform: translateX(100%); }
.menu-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
  box-shadow: 0 0 15px rgba(255,204,0,0.15), inset 0 0 15px rgba(255,204,0,0.05);
}

.menu-hint {
  font-size: 9px;
  color: var(--dim);
  margin-top: 4px;
  display: block;
}

.blink-text {
  animation: blink 1.2s step-start infinite;
  font-size: 7px;
  color: var(--dim);
  margin-top: 30px;
}
@keyframes blink { 50% { opacity: 0; } }

/* ‚îÄ‚îÄ STANCE SELECT ‚îÄ‚îÄ */
#stance-screen {
  padding: 20px;
  width: 100%;
  align-items: center;
  text-align: center;
}

#stance-screen .stance-grid {
  max-width: 900px;
}

.stance-title {
  font-size: 10px;
  color: var(--accent);
  text-align: center;
  margin-bottom: 20px;
}

.stance-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 16px;
  width: 100%;
}

.stance-card {
  padding: 14px;
  border: 2px solid var(--border);
  background: var(--panel);
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
  text-align: left;
}
.stance-card::after {
  content: '';
  position: absolute;
  inset: 0;
  opacity: 0;
  transition: opacity 0.3s;
}
.stance-card:hover { transform: translateY(-2px); }
.stance-card.sel { transform: scale(1.02); }

.stance-card[data-s="DO"] { border-color: #00e5ff33; }
.stance-card[data-s="DO"].sel { border-color: var(--do); box-shadow: 0 0 20px rgba(0,229,255,0.2), inset 0 0 30px rgba(0,229,255,0.05); }
.stance-card[data-s="DO"]::after { background: radial-gradient(circle at 30% 30%, rgba(0,229,255,0.08), transparent 70%); }
.stance-card[data-s="DO"]:hover::after, .stance-card[data-s="DO"].sel::after { opacity:1; }

.stance-card[data-s="IO"] { border-color: #ff6ec733; }
.stance-card[data-s="IO"].sel { border-color: var(--io); box-shadow: 0 0 20px rgba(255,110,199,0.2), inset 0 0 30px rgba(255,110,199,0.05); }
.stance-card[data-s="IO"]::after { background: radial-gradient(circle at 70% 30%, rgba(255,110,199,0.08), transparent 70%); }
.stance-card[data-s="IO"]:hover::after, .stance-card[data-s="IO"].sel::after { opacity:1; }

.stance-card[data-s="DP"] { border-color: #76ff0333; }
.stance-card[data-s="DP"].sel { border-color: var(--dp); box-shadow: 0 0 20px rgba(118,255,3,0.2), inset 0 0 30px rgba(118,255,3,0.05); }
.stance-card[data-s="DP"]::after { background: radial-gradient(circle at 30% 70%, rgba(118,255,3,0.08), transparent 70%); }
.stance-card[data-s="DP"]:hover::after, .stance-card[data-s="DP"].sel::after { opacity:1; }

.stance-card[data-s="IP"] { border-color: #ff910033; }
.stance-card[data-s="IP"].sel { border-color: var(--ip); box-shadow: 0 0 20px rgba(255,145,0,0.2), inset 0 0 30px rgba(255,145,0,0.05); }
.stance-card[data-s="IP"]::after { background: radial-gradient(circle at 70% 70%, rgba(255,145,0,0.08), transparent 70%); }
.stance-card[data-s="IP"]:hover::after, .stance-card[data-s="IP"].sel::after { opacity:1; }

.sc-tag {
  display: inline-block;
  padding: 2px 8px;
  font-size: 7px;
  color: #000;
  margin-right: 6px;
}
.sc-name { font-size: 8px; margin-bottom: 8px; }
.sc-desc { font-size: 6px; color: #cfcff3; line-height: 1.8; margin-bottom: 6px; }
.sc-stats { font-size: 6px; color: #8888b0; line-height: 2; }

.go-btn {
  display: block;
  margin: 0 auto;
  font-family: 'Press Start 2P', monospace;
  font-size: 10px;
  padding: 14px 40px;
  border: 2px solid var(--accent);
  background: transparent;
  color: var(--accent);
  cursor: pointer;
  transition: all 0.15s;
}
.go-btn:hover { background: var(--accent); color: #000; box-shadow: 0 0 25px rgba(255,204,0,0.3); }
.go-btn:disabled { opacity: 0.25; cursor: default; }

/* ‚îÄ‚îÄ MAIN GAME ‚îÄ‚îÄ */
#play-screen { display: none; padding: 6px; }
#play-screen.active {
  display: grid;
  grid-template-rows: auto auto auto 1fr auto;
  gap: 4px;
  height: 100%;
  width: 100%;
  align-items: stretch;
  justify-content: stretch;
}

.hud {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 5px 10px;
  background: var(--panel);
  border: 2px solid var(--border);
  font-size: 7px;
}
.hud-stance { padding: 3px 10px; font-size: 8px; color: #000; }
.hud-year { color: var(--accent); font-size: 10px; }
.hud-score { font-size: 9px; }
.score-num { transition: all 0.3s; display: inline-block; }
.score-num.pulse { animation: scorePulse 0.4s ease-out; }
@keyframes scorePulse {
  0% { transform: scale(1); }
  40% { transform: scale(1.5); color: var(--accent); }
  100% { transform: scale(1); }
}

.timer-row {
  height: 6px;
  background: #000;
  border: 1px solid var(--border);
  overflow: hidden;
}
.timer-fill {
  height: 100%;
  background: var(--accent);
  transition: width 0.1s linear;
}
.timer-fill.low { background: var(--danger); animation: timerPulse 0.5s infinite; }
@keyframes timerPulse { 50% { opacity: 0.5; } }

.res-row {
  display: flex;
  gap: 10px;
  padding: 4px 10px;
  background: var(--panel);
  border: 2px solid var(--border);
  font-size: 7px;
  align-items: center;
  flex-wrap: wrap;
}
.res-item { display: flex; align-items: center; gap: 5px; }
.res-bar {
  width: 55px; height: 10px;
  background: #0a0a0a;
  border: 1px solid #333;
  position: relative; overflow: hidden;
}
.res-fill {
  height: 100%;
  transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1);
  position: relative;
}
.res-fill::after {
  content: '';
  position: absolute;
  top: 0; right: 0;
  width: 3px; height: 100%;
  background: rgba(255,255,255,0.4);
}
.res-fill.flash { animation: resFlash 0.3s ease-out; }
@keyframes resFlash { 0% { filter: brightness(2); } 100% { filter: brightness(1); } }
.res-val { min-width: 24px; text-align: right; font-size: 7px; transition: color 0.3s; }
.res-val.up { color: var(--success); }
.res-val.down { color: var(--danger); }

.hv-item {
  display: flex; align-items: center; gap: 5px;
  padding: 2px 8px;
  border: 1px solid var(--border);
  background: rgba(0,0,0,0.4);
  font-size: 6px;
}
.hv-bar { width: 50px; height: 6px; background: #0a0a0a; border: 1px solid #333; overflow: hidden; }
.hv-fill { height: 100%; transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1); }

.main-area {
  display: grid;
  grid-template-columns: 1fr 200px;
  gap: 4px;
  min-height: 0;
  overflow: hidden;
}
.world-col { display: flex; flex-direction: column; gap: 4px; min-height: 0; }
#world-canvas {
  flex: 1; width: 100%;
  background: var(--panel);
  border: 2px solid var(--border);
  image-rendering: pixelated;
  min-height: 60px;
}
.action-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(165px, 1fr));
  gap: 4px;
  overflow-y: auto;
  max-height: 200px;
  padding: 3px;
}

.act-card {
  padding: 6px;
  border: 2px solid var(--border);
  background: var(--panel);
  cursor: pointer;
  transition: all 0.15s;
  font-size: 6px;
  position: relative;
  overflow: visible;
  text-align: left;
}
.act-card::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.03), transparent 60%);
}
.act-card:hover:not(.off) {
  border-color: var(--accent);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}
.act-card.off { opacity: 0.25; cursor: default; filter: grayscale(0.8); }
.act-card .act-name { font-size: 7px; margin-bottom: 3px; color: var(--text); }
.act-card .act-cost { color: var(--dim); margin-bottom: 2px; }
.act-card .act-fx { color: #8f8; line-height: 1.6; }
.act-tag { position: absolute; top: 3px; right: 4px; font-size: 5px; padding: 1px 4px; color: #000; }

.act-count {
  text-align: center; font-size: 8px; padding: 4px;
  color: var(--accent);
  border: 1px dashed var(--border);
  margin-bottom: 2px;
  background: var(--panel);
}

.log-col {
  display: flex; flex-direction: column;
  background: var(--panel);
  border: 2px solid var(--border);
  overflow: hidden;
}
.log-title { font-size: 7px; color: var(--accent); padding: 5px 8px; border-bottom: 1px solid var(--border); }
.log-list { flex: 1; overflow-y: auto; padding: 4px; display: flex; flex-direction: column; gap: 3px; }
.log-entry {
  padding: 4px 6px; font-size: 6px; line-height: 1.6;
  border-left: 3px solid var(--border);
  background: rgba(0,0,0,0.25);
  animation: logSlideIn 0.3s ease-out;
  text-align: left;
}
@keyframes logSlideIn { from { opacity:0; transform:translateX(15px); } to { opacity:1; transform:translateX(0); } }
.log-entry.t-shock { border-color: var(--danger); }
.log-entry.t-opp { border-color: var(--success); }
.log-entry.t-shift { border-color: var(--io); }
.log-entry.t-singular { border-color: var(--accent); background: rgba(255,204,0,0.04); }
.log-entry.t-action { border-color: var(--do); }
.log-entry.t-year { border-color: var(--dim); color: var(--dim); font-style: italic; }

.bot-bar { display: flex; justify-content: center; gap: 10px; padding: 4px; }
.g-btn {
  font-family: 'Press Start 2P', monospace;
  font-size: 9px; padding: 10px 24px;
  border: 2px solid var(--accent);
  background: transparent; color: var(--accent);
  cursor: pointer; transition: all 0.15s;
  position: relative; overflow: hidden;
}
.g-btn::after {
  content: ''; position: absolute; inset: 0;
  background: var(--accent); opacity: 0; transition: opacity 0.15s;
}
.g-btn:hover::after { opacity: 0.15; }
.g-btn:hover { box-shadow: 0 0 20px rgba(255,204,0,0.2); }
.g-btn:disabled { opacity: 0.2; cursor: default; }
.g-btn:disabled:hover::after { opacity: 0; }
.g-btn.sec { border-color: var(--border); color: var(--dim); }
.g-btn.sec:hover { border-color: var(--dim); }

/* ‚îÄ‚îÄ EVENT OVERLAY ‚îÄ‚îÄ */
#event-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0);
  z-index: 80;
  display: none;
  align-items: center; justify-content: center;
  transition: background 0.4s;
}
#event-overlay.show { display: flex; background: rgba(0,0,0,0.75); }
.evt-box {
  max-width: 520px; width: 90%; padding: 28px;
  background: var(--panel);
  border: 3px solid var(--border);
  text-align: center;
  transform: scale(0.8); opacity: 0;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
#event-overlay.show .evt-box { transform: scale(1); opacity: 1; }
.evt-type { font-size: 7px; letter-spacing: 3px; margin-bottom: 10px; text-transform: uppercase; }
.evt-name { font-size: 11px; color: var(--accent); margin-bottom: 14px; line-height: 1.8; text-shadow: 0 0 10px rgba(255,204,0,0.3); }
.evt-desc { font-size: 7px; color: #b0b0d0; line-height: 2.2; margin-bottom: 16px; min-height: 40px; }
.evt-flavor { font-size: 6px; color: #9090b8; font-style: italic; margin-bottom: 12px; line-height: 1.8; }
.evt-fx {
  font-size: 7px; padding: 8px;
  background: rgba(0,0,0,0.4);
  border: 1px solid var(--border);
  margin-bottom: 18px; line-height: 2;
}
.fx-pos { color: var(--success); }
.fx-neg { color: var(--danger); }

/* ‚îÄ‚îÄ SUMMARY ‚îÄ‚îÄ */
#summary-screen {
  padding: 20px;
  width: 100%;
  max-height: 100%;
  overflow-y: auto;
  align-items: center;
  text-align: center;
}

#summary-screen .sum-grid,
#summary-screen .sum-blurb,
#summary-screen .sum-chart,
#summary-screen .sum-achv {
  max-width: 700px;
  width: 100%;
}
.sum-title {
  font-size: 12px; color: var(--accent);
  text-align: center; margin-bottom: 8px;
  text-shadow: 0 0 15px rgba(255,204,0,0.5);
}
.sum-ending { font-size: 10px; text-align: center; margin-bottom: 8px; line-height: 1.6; }
.sum-blurb {
  font-size: 7px; color: var(--dim); line-height: 2.2;
  padding: 14px;
  border: 1px solid var(--border);
  background: rgba(0,0,0,0.3);
  margin-bottom: 20px;
  text-align: left;
}
.sum-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 1fr;
  gap: 6px; margin-bottom: 16px;
  width: 100%;
}
.sum-stat {
  padding: 10px;
  background: rgba(0,0,0,0.3);
  border: 1px solid var(--border);
  text-align: center;
}
.sum-stat .sl { font-size: 6px; color: var(--dim); margin-bottom: 4px; }
.sum-stat .sv { font-size: 14px; }
.sum-chart {
  margin: 12px 0; width: 100%;
  background: rgba(0,0,0,0.3);
  border: 1px solid var(--border);
  padding: 8px;
}
.sum-chart canvas { width: 100%; height: 140px; image-rendering: pixelated; }
.sum-achv { margin-bottom: 16px; width: 100%; }
.achv-item {
  font-size: 7px; padding: 6px 10px; margin: 4px 0;
  border: 1px solid var(--accent);
  background: rgba(255,204,0,0.04);
  animation: achvPop 0.4s ease-out backwards;
  text-align: left;
}

/* ‚îÄ‚îÄ GLOSSARY ‚îÄ‚îÄ */
#glossary-screen {
  padding: 24px;
  width: 100%;
  max-height: 100%; overflow-y: auto;
  font-size: 7px; line-height: 2.2;
  text-align: center;
}
#glossary-screen > div { text-align: left; max-width: 700px; }

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media (max-width: 800px) {
  .main-area { grid-template-columns: 1fr; grid-template-rows: 1fr auto auto; }
  .stance-grid { grid-template-columns: 1fr; }
  .sum-grid { grid-template-columns: 1fr 1fr; }
  .action-grid { max-height: 280px; grid-template-columns: 1fr 1fr; }
  .act-card { padding: 8px 10px; }
  .act-card .act-name { font-size: 7px; margin-bottom: 5px; }
  .act-card .act-cost { margin-bottom: 4px; }
  .act-card .act-fx { line-height: 1.8; }
}

@media (max-width: 500px) {
  .action-grid { grid-template-columns: 1fr; max-height: 300px; }
  .act-card { padding: 10px; }
  .res-row { gap: 6px; padding: 4px 8px; font-size: 6px; }
  .res-bar { width: 40px; }
  .hv-bar { width: 35px; }
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   LAYOUT CONTROL PATCH (NO GAMEPLAY CHANGES)
   Paste at END of <style> so it overrides earlier rules.
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

/* Optional tunables */
:root{
  --ui-gap: 4px;
  --ui-pad: 6px;
  --actions-min-h: 120px;
  --actions-max-h: 38%;
}

/* Use dynamic viewport height where supported */
body{
  height: 100dvh;
  width: 100vw;
  overflow: hidden;
}

/* Make the play screen a strict container-managed grid */
#play-screen.active{
  height: 100%;
  width: 100%;
  padding: var(--ui-pad);
  gap: var(--ui-gap);
  min-height: 0;
  align-items: stretch;
}

/* Ensure the "1fr" row can actually shrink (grid gotcha) */
#play-screen.active > *{
  min-height: 0;
}

/* Main split area should take remaining space, not force overflow */
.main-area{
  min-height: 0;
  overflow: hidden;
  gap: var(--ui-gap);
  align-self: stretch;
  height: 100%;
}

/* Left column: allow world + actions to manage height sanely */
.world-col{
  min-height: 0;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  gap: var(--ui-gap);
}

/* World canvas should be the primary flexible grow/shrink element */
#world-canvas{
  flex: 1 1 auto;
  min-height: 60px;
  height: auto;
  max-height: none;
}

/* Action count is fixed-height UI; keep it from stretching */
.act-count{
  flex: 0 0 auto;
}

/* Actions list becomes the controlled scroller in left column */
.action-grid{
  flex: 0 1 auto;
  min-height: var(--actions-min-h);
  max-height: var(--actions-max-h);
  overflow: auto;
  padding: 3px;
}

/* Right column: log container must be allowed to shrink */
.log-col{
  min-height: 0;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* Log list is the only scroller on the right */
.log-list{
  min-height: 0;
  overflow: auto;
}

/* Small screens: keep it stable and prevent "floating apart" */
@media (max-width: 800px){
  #play-screen.active{
    height: 100%;
  }

  .main-area{
    grid-template-columns: 1fr;
    grid-template-rows: 1fr auto minmax(140px, 220px);
  }

  .action-grid{
    max-height: 25%;
  }
}


/* ‚îÄ‚îÄ BACKGROUND MUSIC (additive) ‚îÄ‚îÄ */
#music-toggle {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 90;
  font-family: 'Press Start 2P', monospace;
  font-size: 8px;
  padding: 10px 12px;
  border: 2px solid var(--border);
  background: rgba(10,10,20,0.7);
  color: var(--text);
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 1px;
}
#music-toggle.on {
  border-color: var(--accent);
  color: var(--accent);
  box-shadow: 0 0 18px rgba(255,204,0,0.15), inset 0 0 12px rgba(255,204,0,0.06);
}
#music-toggle:focus { outline: 2px dashed var(--accent); outline-offset: 3px; }

/* ‚îÄ‚îÄ Desktop: hide mobile-only elements ‚îÄ‚îÄ */
.log-toggle-btn { display: none !important; }
.log-close { display: none; }

/* ‚îÄ‚îÄ YEAR TRANSITION CINEMATIC ‚îÄ‚îÄ */
#year-transition {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.95);
  z-index: 85;
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
}
#year-transition.show { display: flex; }
.yt-content { text-align: center; }
.yt-year {
  font-size: 28px;
  color: var(--accent);
  text-shadow: 0 0 30px rgba(255,204,0,0.6);
  opacity: 0;
  transform: scale(0.5);
  animation: ytYearIn 0.6s ease-out 0.1s forwards;
}
.yt-headline {
  font-size: 9px;
  color: var(--text);
  margin-top: 16px;
  opacity: 0;
  letter-spacing: 2px;
  line-height: 1.8;
  animation: ytFadeIn 0.5s ease-out 0.5s forwards;
}
.yt-subline {
  font-size: 7px;
  color: var(--dim);
  margin-top: 10px;
  opacity: 0;
  font-style: italic;
  animation: ytFadeIn 0.4s ease-out 0.9s forwards;
}
@keyframes ytYearIn {
  0% { opacity:0; transform: scale(0.5); }
  60% { opacity:1; transform: scale(1.15); }
  100% { opacity:1; transform: scale(1); }
}
@keyframes ytFadeIn {
  from { opacity:0; transform: translateY(8px); }
  to { opacity:1; transform: translateY(0); }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MOBILE ‚Äî iPhone & similar (‚â§ 780px)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@media (max-width: 780px) {

  /* Drop 4:3 box + zoom ‚Äî go full screen */
  #game-root {
    width: 100vw !important;
    height: 100dvh !important;
    max-width: none !important;
    max-height: none !important;
    zoom: 1 !important;
    border: none !important;
    box-shadow: none !important;
  }

  /* Play screen: tight vertical stack */
  #play-screen.active {
    grid-template-rows: auto auto auto 1fr auto;
    gap: 3px;
    padding: 4px;
  }

  /* HUD: compact single row */
  .hud {
    padding: 4px 8px;
    font-size: 8px;
    gap: 4px;
  }

  /* Resource row: 2-row wrap */
  .res-row {
    padding: 3px 6px;
    gap: 4px;
    font-size: 7px;
    flex-wrap: wrap;
    justify-content: center;
  }
  .res-bar { width: 30px; height: 6px; }
  .hv-bar { width: 25px; }

  /* Main area: single column, log hidden */
  .main-area {
    grid-template-columns: 1fr !important;
    grid-template-rows: 1fr auto auto !important;
    gap: 3px;
  }

  /* World canvas: shorter on mobile */
  #world-canvas {
    min-height: 50px;
    max-height: 120px;
  }

  /* Action count */
  .act-count {
    padding: 3px;
    font-size: 8px;
  }

  /* Action grid: 2-col, scrollable, bigger touch targets */
  .action-grid {
    grid-template-columns: 1fr 1fr !important;
    max-height: none !important;
    min-height: 0 !important;
    gap: 3px;
    overflow-y: auto;
    flex: 1 1 auto;
  }

  .act-card {
    padding: 6px;
    min-height: 0;
    font-size: 8px;
  }
  .act-card .act-name { font-size: 9px; }
  .act-card .act-cost { font-size: 8px; }
  .act-card .act-fx { font-size: 8px; line-height: 1.5; }
  .act-tag { font-size: 6px; }

  /* Event log: slide-out overlay from right */
  .log-col {
    display: none !important;
  }
  .log-col.open {
    display: flex !important;
    position: fixed;
    top: 0;
    right: 0;
    width: 75vw;
    height: 100dvh;
    z-index: 100;
    background: var(--bg);
    border-left: 2px solid var(--accent);
    box-shadow: -8px 0 30px rgba(0,0,0,0.7);
    flex-direction: column;
    animation: slideIn 0.2s ease-out;
  }

  @keyframes slideIn {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
  }

  /* Log close button */
  .log-close {
    display: block;
    position: absolute;
    top: 8px;
    right: 10px;
    background: none;
    border: 1px solid var(--border);
    color: var(--text);
    font-size: 12px;
    padding: 4px 8px;
    cursor: pointer;
    z-index: 101;
    font-family: 'Press Start 2P', monospace;
  }

  /* Show LOG button in bottom bar */
  .log-toggle-btn {
    display: inline-block !important;
  }

  /* Bottom bar: compact */
  .bot-bar {
    padding: 3px;
    gap: 6px;
  }
  .g-btn {
    font-size: 8px;
    padding: 10px 14px;
  }

  /* Music toggle: smaller on mobile */
  #music-toggle {
    font-size: 6px;
    padding: 6px 8px;
    top: 4px;
    right: 4px;
  }

  /* Year transition: mobile sizing */
  .yt-year { font-size: 20px; }
  .yt-headline { font-size: 8px; }
  .yt-subline { font-size: 6px; }

  /* Title screen */
  .title-main { font-size: 16px; }
  .title-sub { font-size: 7px; padding: 0 10px; }
  .menu-btn { font-size: 8px; padding: 14px; min-width: 200px; }

  /* Stance selection */
  .stance-grid { grid-template-columns: 1fr !important; gap: 6px; }
  .stance-card { padding: 10px; }
  .sc-name { font-size: 8px; }
  .sc-desc { font-size: 7px; }
  .sc-stats { font-size: 7px; }

  /* Event overlay */
  .evt-box { width: 90vw; padding: 16px; }
  .evt-name { font-size: 11px; }
  .evt-desc { font-size: 8px; }
  .evt-flavor { font-size: 7px; }

  /* Log entries */
  .log-title { font-size: 8px; }
  .log-entry { font-size: 7px; }
  .log-year { font-size: 7px; }

  /* Summary */
  #summary-screen { padding: 12px; font-size: 7px; }
  .sum-grid { grid-template-columns: 1fr !important; }

  /* Glossary */
  #glossary-screen { padding: 12px; font-size: 7px; }
}

/* Extra small phones (iPhone SE etc) */
@media (max-width: 380px) {
  .action-grid { grid-template-columns: 1fr !important; }
  .act-card { min-height: 0; font-size: 8px; }
  .res-row { font-size: 6px; }
  .res-bar { width: 24px; }
  .title-main { font-size: 12px; }
}

</style>
</head>
<body>

<div id="crt"></div>
<canvas id="particles"></canvas>
<div id="combo-banner"></div>


<div id="game-root">
  <button id="music-toggle" class="on" type="button" aria-pressed="true" title="Toggle background music">MUSIC: ON</button>
  <!-- ‚ïê‚ïê‚ïê TITLE ‚ïê‚ïê‚ïê -->
  <div id="title-screen" class="screen active">
    <div class="title-coin">üé∞</div>
    <div class="title-main">NOT A LOTTERY TICKET<br>8-BIT FUTURES</div>
    <div class="title-sub">"You are not a lottery ticket." ‚Äî Choose your worldview. Shape your future.</div>
    <button class="menu-btn" onclick="sfx('coin');go('stance',1)">1 PLAYER RUN<span class="menu-hint">Solo 12-year strategic run</span></button>
    <button class="menu-btn" onclick="sfx('coin');go('stance',2)">2 PLAYER HOT-SEAT<span class="menu-hint">Take turns, share the world</span></button>
    <button class="menu-btn" onclick="sfx('select');showScreen('glossary-screen')">HOW TO PLAY<span class="menu-hint">Worldviews, resources, scoring</span></button>
    <div class="blink-text">INSERT COIN TO START</div>
    <div style="margin-top:30px;font-size:6px;color:var(--dim);"><a href="https://billsantry.com" target="_blank" style="color:var(--dim);text-decoration:none;">¬© Bill Santry</a></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê STANCE SELECT ‚ïê‚ïê‚ïê -->
  <div id="stance-screen" class="screen">
    <div class="stance-title" id="stanceTitle">CHOOSE YOUR FUTURE STANCE</div>
    <div class="stance-grid">
      <div class="stance-card" data-s="DO" onclick="pickStance('DO')" tabindex="0">
        <div class="sc-name"><span class="sc-tag" style="background:var(--do)">DO</span> <span style="color:var(--do)">DETERMINATE OPTIMISM</span></div>
        <div class="sc-desc">You have a specific plan for a better future. Concentrate your bets. Build conviction. Compound advantages over time.</div>
        <div class="sc-stats">‚¨Ü HIGH CEILING  ‚¨á MEDIUM FLOOR<br>‚òÖ Rewards: planning, conviction chains<br>‚úï Punishes: pivoting, hedging</div>
      </div>
      <div class="stance-card" data-s="IO" onclick="pickStance('IO')" tabindex="0">
        <div class="sc-name"><span class="sc-tag" style="background:var(--io)">IO</span> <span style="color:var(--io)">INDETERMINATE OPTIMISM</span></div>
        <div class="sc-desc">The future will be better ‚Äî you just don't know how. Diversify. A/B test everything. Optimize process over substance.</div>
        <div class="sc-stats">‚¨Ü MEDIUM CEILING  ‚¨á HIGH FLOOR<br>‚òÖ Rewards: breadth, experiments<br>‚úï Punishes: tunnel vision</div>
      </div>
      <div class="stance-card" data-s="DP" onclick="pickStance('DP')" tabindex="0">
        <div class="sc-name"><span class="sc-tag" style="background:var(--dp)">DP</span> <span style="color:var(--dp)">DETERMINATE PESSIMISM</span></div>
        <div class="sc-desc">The future looks bleak but you have a plan: ration, defend, build walls. Fortress strategy. Slow and resilient.</div>
        <div class="sc-stats">‚¨Ü LOW CEILING  ‚¨á MEDIUM FLOOR<br>‚òÖ Rewards: reserves, defense<br>‚úï Punishes: expansion, speed</div>
      </div>
      <div class="stance-card" data-s="IP" onclick="pickStance('IP')" tabindex="0">
        <div class="sc-name"><span class="sc-tag" style="background:var(--ip)">IP</span> <span style="color:var(--ip)">INDETERMINATE PESSIMISM</span></div>
        <div class="sc-desc">Things will get worse and nobody knows how. Insure everything. Hedge. Comply. Survive by not trying.</div>
        <div class="sc-stats">‚¨Ü LOW CEILING  ‚¨á HIGH SURVIVAL<br>‚òÖ Rewards: insurance, compliance<br>‚úï Punishes: vision, boldness</div>
      </div>
    </div>
    <button class="go-btn" id="goBtn" disabled onclick="sfx('start');beginRun()">‚ñ∂ START RUN</button>
  </div>

  <!-- ‚ïê‚ïê‚ïê PLAY ‚ïê‚ïê‚ïê -->
  <div id="play-screen" class="screen">
    <div class="hud">
      <span class="hud-stance" id="hudStance"></span>
      <span class="hud-year" id="hudYear">YEAR 1 / 12</span>
      <span class="hud-score">SCORE <span class="score-num" id="hudScore">0</span></span>
      <span id="hudPlayer" style="display:none;font-size:7px;"></span>
    </div>
    <div class="timer-row"><div class="timer-fill" id="timerFill" style="width:100%"></div></div>
    <div class="res-row" id="resRow"></div>
    <div class="main-area">
      <div class="world-col">
        <canvas id="world-canvas"></canvas>
        <div class="act-count" id="actCount">ACTIONS: 3 / 3</div>
        <div class="action-grid" id="actGrid"></div>
      </div>
      <div class="log-col" id="logCol">
        <button class="log-close" onclick="document.getElementById('logCol').classList.remove('open')">‚úï</button>
        <div class="log-title">‚óà EVENT LOG</div>
        <div class="log-list" id="logList"></div>
      </div>
    </div>
    <div class="bot-bar">
      <button class="g-btn log-toggle-btn" onclick="document.getElementById('logCol').classList.toggle('open')">LOG</button>
      <button class="g-btn" id="btnEnd" onclick="sfx('confirm');endYear()">END YEAR ‚ñ∂</button>
      <button class="g-btn sec" id="btnUndo" onclick="sfx('back');undo()" disabled>UNDO</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê YEAR TRANSITION ‚ïê‚ïê‚ïê -->
  <div id="year-transition">
    <div class="yt-content">
      <div class="yt-year" id="ytYear"></div>
      <div class="yt-headline" id="ytHeadline"></div>
      <div class="yt-subline" id="ytSubline"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê EVENT OVERLAY ‚ïê‚ïê‚ïê -->
  <div id="event-overlay">
    <div class="evt-box">
      <div class="evt-type" id="evtType"></div>
      <div class="evt-name" id="evtName"></div>
      <div class="evt-desc" id="evtDesc"></div>
      <div class="evt-flavor" id="evtFlavor"></div>
      <div class="evt-fx" id="evtFx"></div>
      <button class="g-btn" onclick="sfx('confirm');resolveEvent()">CONTINUE</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê SUMMARY ‚ïê‚ïê‚ïê -->
  <div id="summary-screen" class="screen"></div>

  <!-- ‚ïê‚ïê‚ïê GLOSSARY ‚ïê‚ïê‚ïê -->
  <div id="glossary-screen" class="screen">
    <div style="font-size:10px;color:var(--accent);margin-bottom:18px;">HOW TO PLAY</div>
    <div style="text-align:left;margin-bottom:10px;"><span style="color:var(--accent);">THE GAME:</span> Each run = 12 Years. Each Year, pick actions to spend resources. An event fires. Your worldview shapes everything. Score tallied at end.</div>
    <div style="text-align:left;margin-bottom:10px;"><span style="color:var(--accent);">TIMER:</span> Each year has a 30s countdown. Act fast ‚Äî this is an arcade!</div>
    <div style="text-align:left;margin-bottom:10px;"><span style="color:var(--do);">DO ‚Äî DETERMINATE OPTIMISM:</span> Chain consistent actions. Build Conviction. The plan compounds. High ceiling, but pivoting kills momentum.</div>
    <div style="text-align:left;margin-bottom:10px;"><span style="color:var(--io);">IO ‚Äî INDETERMINATE OPTIMISM:</span> Use diverse action types. Build Optionality. 4 actions/year. Consistent but capped.</div>
    <div style="text-align:left;margin-bottom:10px;"><span style="color:var(--dp);">DP ‚Äî DETERMINATE PESSIMISM:</span> Hoard and fortify. Build Resilience. Shocks barely hurt you.</div>
    <div style="text-align:left;margin-bottom:10px;"><span style="color:var(--ip);">IP ‚Äî INDETERMINATE PESSIMISM:</span> Insure and comply. Build Bureaucracy. Only 2 actions/year. Survive everything, build nothing.</div>
    <div style="text-align:left;margin-bottom:10px;"><span style="color:var(--accent);">SCORING:</span> Breakthrough + Wealth + Impact + Durability. Multiple endings per stance.</div>
    <div style="text-align:left;margin-bottom:16px;"><span style="color:var(--accent);">THE THESIS:</span> Your worldview shapes outcomes through natural mechanisms ‚Äî not luck. Feel why each stance leads where it does.</div>
    <button class="g-btn" onclick="sfx('back');showScreen('title-screen')">BACK</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NOT A LOTTERY TICKET: 8-BIT FUTURES v4
//  Living world, year cinematics, dynamic music tension
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ AUDIO ENGINE (expanded) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let actx;
function ensureAudio() { if (!actx) actx = new AudioCtx(); return actx; }

function playNote(type, freq, dur, vol=0.07, delay=0) {
  ensureAudio();
  const o = actx.createOscillator();
  const g = actx.createGain();
  o.connect(g); g.connect(actx.destination);
  o.type = type;
  const t = actx.currentTime + delay;
  o.frequency.setValueAtTime(freq, t);
  g.gain.setValueAtTime(vol, t);
  g.gain.exponentialRampToValueAtTime(0.001, t + dur);
  o.start(t); o.stop(t + dur);
  return o;
}

function playArp(type, freqs, noteDur, vol=0.06) {
  freqs.forEach((f, i) => playNote(type, f, noteDur, vol, i * noteDur * 0.8));
}

function sfx(type) {
  try {
    switch(type) {
      // POSITIVE
      case 'select': playArp('square', [440, 660], 0.08); break;
      case 'confirm': playArp('square', [523, 784], 0.1); break;
      case 'start': playArp('square', [262, 330, 392, 523], 0.12, 0.07); break;
      case 'coin': playArp('square', [988, 1319], 0.08, 0.06); break;
      case 'levelup': playArp('square', [523, 659, 784, 1047], 0.1, 0.06); break;
      case 'powerup': playArp('triangle', [330, 440, 554, 659], 0.09, 0.07); break;
      case 'breakthrough': playArp('square', [262, 330, 392, 523, 659, 784, 1047], 0.1, 0.07); break;
      case 'cha_ching': playArp('square', [1047, 1319, 1568], 0.07, 0.05); break;
      case 'combo': playArp('square', [440, 554, 659, 880], 0.08, 0.06); break;
      case 'fanfare': playArp('triangle', [392, 523, 659, 784, 1047], 0.15, 0.06); break;
      case 'opportunity': playArp('sine', [440, 660, 880], 0.1, 0.06); break;
      case 'heal': playArp('sine', [330, 440, 523, 659], 0.12, 0.05); break;
      case 'sparkle': {
        playNote('sine', 1200, 0.15, 0.04);
        playNote('sine', 1600, 0.12, 0.03, 0.05);
        playNote('sine', 2000, 0.1, 0.02, 0.1);
        break;
      }

      // NEGATIVE
      case 'shock': {
        ensureAudio();
        const o = actx.createOscillator();
        const g = actx.createGain();
        o.connect(g); g.connect(actx.destination);
        o.type = 'sawtooth';
        const t = actx.currentTime;
        o.frequency.setValueAtTime(200, t);
        o.frequency.exponentialRampToValueAtTime(40, t + 0.5);
        g.gain.setValueAtTime(0.1, t);
        g.gain.exponentialRampToValueAtTime(0.001, t + 0.6);
        o.start(t); o.stop(t + 0.6);
        break;
      }
      case 'fail': playArp('square', [392, 349, 330, 262], 0.15, 0.06); break;
      case 'damage': {
        playNote('sawtooth', 150, 0.2, 0.08);
        playNote('square', 100, 0.3, 0.06, 0.05);
        break;
      }
      case 'crash': {
        ensureAudio();
        const o = actx.createOscillator(); const g = actx.createGain();
        o.connect(g); g.connect(actx.destination);
        o.type = 'sawtooth';
        const t = actx.currentTime;
        o.frequency.setValueAtTime(400, t);
        o.frequency.exponentialRampToValueAtTime(30, t+0.8);
        g.gain.setValueAtTime(0.12, t);
        g.gain.exponentialRampToValueAtTime(0.001, t+0.9);
        o.start(t); o.stop(t+0.9);
        playNote('square', 80, 0.4, 0.05, 0.3);
        break;
      }
      case 'buzzer': playArp('sawtooth', [200, 150], 0.2, 0.07); break;
      case 'drain': {
        playNote('triangle', 300, 0.4, 0.06);
        playNote('triangle', 200, 0.4, 0.05, 0.15);
        playNote('triangle', 130, 0.4, 0.04, 0.3);
        break;
      }
      case 'alarm': {
        for (let i = 0; i < 3; i++) {
          playNote('square', 800, 0.08, 0.05, i * 0.15);
          playNote('square', 600, 0.08, 0.05, i * 0.15 + 0.08);
        }
        break;
      }
      case 'sad_trombone': playArp('triangle', [294, 277, 262, 247], 0.25, 0.06); break;
      case 'whomp': playNote('triangle', 120, 0.5, 0.08); break;

      // NEUTRAL / UI
      case 'back': playArp('triangle', [330, 220], 0.08, 0.05); break;
      case 'tick': playNote('sine', 800, 0.04, 0.03); break;
      case 'shift': playArp('sine', [440, 554, 440], 0.12, 0.04); break;
      case 'endgame': playArp('triangle', [523, 659, 784, 1047], 0.2, 0.07); break;
      case 'dramatic': {
        playNote('triangle', 220, 0.6, 0.06);
        playNote('sine', 330, 0.5, 0.04, 0.2);
        playNote('triangle', 440, 0.4, 0.05, 0.4);
        break;
      }
      case 'suspense': {
        playNote('triangle', 165, 0.8, 0.05);
        playNote('sine', 175, 0.8, 0.04, 0.02);
        break;
      }
    }
  } catch(e) {}
}

// ‚îÄ‚îÄ BACKGROUND MUSIC: GAME ADVENTURE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Slower cartoon bounce with Super Mario-style adventure melody
const Music = (() => {
  const LS_KEY = "8bit_futures_music";
  let enabled = (localStorage.getItem(LS_KEY) ?? "on") === "on";

  let ctx = null;
  let melGain = null;
  let bassGain = null;
  let percGain = null;
  let timer = null;
  let noteIdx = 0;
  let nextTime = 0;
  let tense = false;

  const BPM = 120; // Super Mario Bros tempo (was 160, now much slower)
  const BPM_TENSE = 100;
  
  const BASE = 220;
  const midi = (m) => 440 * Math.pow(2, (m - 69) / 12);

  function ensure() {
    if (typeof ensureAudio === "function") ctx = ensureAudio();
    else if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();

    if (!melGain) {
      melGain = ctx.createGain();
      melGain.gain.value = 0.10;
      melGain.connect(ctx.destination);
    }
    if (!bassGain) {
      bassGain = ctx.createGain();
      bassGain.gain.value = 0.12;
      bassGain.connect(ctx.destination);
    }
    if (!percGain) {
      percGain = ctx.createGain();
      percGain.gain.value = 0.07;
      percGain.connect(ctx.destination);
    }
    return ctx;
  }

  function playVoice(note, t, dur, gainNode, waveType, vol) {
    if (note == null || !ctx) return;
    try {
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = waveType;
      o.frequency.setValueAtTime(midi(note), t);
      const attack = 0.003;
      const release = dur * 0.80;
      g.gain.setValueAtTime(0.0001, t);
      g.gain.linearRampToValueAtTime(vol, t + attack);
      g.gain.exponentialRampToValueAtTime(0.0001, t + release);
      o.connect(g);
      g.connect(gainNode);
      o.start(t);
      o.stop(t + release + 0.05);
    } catch(e) {}
  }

  function playDrum(t, type) {
    if (!ctx) return;
    try {
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      
      if (type === 'kick') {
        o.type = 'sine';
        o.frequency.setValueAtTime(120, t);
        o.frequency.exponentialRampToValueAtTime(40, t + 0.08);
        g.gain.setValueAtTime(0.22, t);
        g.gain.exponentialRampToValueAtTime(0.001, t + 0.10);
        o.connect(g); g.connect(percGain);
        o.start(t); o.stop(t + 0.10);
      } else if (type === 'snare') {
        o.type = 'triangle';
        o.frequency.setValueAtTime(200, t);
        o.frequency.exponentialRampToValueAtTime(100, t + 0.06);
        g.gain.setValueAtTime(0.14, t);
        g.gain.exponentialRampToValueAtTime(0.001, t + 0.08);
        o.connect(g); g.connect(percGain);
        o.start(t); o.stop(t + 0.08);
      } else if (type === 'hat') {
        o.type = 'square';
        o.frequency.setValueAtTime(800, t);
        g.gain.setValueAtTime(0.07, t);
        g.gain.exponentialRampToValueAtTime(0.001, t + 0.03);
        o.connect(g); g.connect(percGain);
        o.start(t); o.stop(t + 0.03);
      }
    } catch(e) {}
  }

  function buildSection(melNotes, bassNotes, drums) {
    const events = [];
    let t = 0;
    for (const [note, beats] of melNotes) {
      if (note != null) events.push([t, 'M', note, beats]);
      t += beats;
    }
    t = 0;
    for (const [note, beats] of bassNotes) {
      if (note != null) events.push([t, 'B', note, beats]);
      t += beats;
    }
    t = 0;
    for (const [type, beats] of drums) {
      if (type != null) events.push([t, 'D', type, beats]);
      t += beats;
    }
    return { events, totalBeats: t };
  }

  // ‚îÄ‚îÄ SUPER MARIO-STYLE ADVENTURE THEME ‚îÄ‚îÄ
  // Key: C major (Mario's key!)
  // C=60, D=62, E=64, F=65, G=67, A=69, B=71, C=72
  
  const mainTheme = buildSection(
    [
      // Mario-style opening - iconic interval jump
      [64, 0.375], [64, 0.125], [null, 0.5], [64, 0.5], [null, 0.5], [60, 0.5], [64, 0.5], [null, 0.5],
      [67, 1], [null, 1], [55, 1], [null, 1],
      
      // Adventure continues
      [60, 0.75], [null, 0.25], [55, 0.75], [null, 0.25], [53, 0.75], [null, 0.25],
      [57, 0.5], [null, 0.25], [59, 0.5], [null, 0.25], [58, 0.25], [57, 0.75],
      [64, 0.75], [67, 0.75], [69, 0.5], [65, 0.5], [67, 0.5], [null, 0.25],
      [64, 0.5], [60, 0.5], [62, 0.5], [59, 0.75], [null, 0.75],
    ],
    [
      // Mario walking bass - alternating root and fifth
      [48, 0.5], [null, 0.5], [48, 0.5], [null, 0.5], [48, 0.5], [null, 0.5], [48, 0.5], [null, 0.5],
      [55, 0.5], [null, 0.5], [55, 0.5], [null, 0.5], [43, 0.5], [null, 0.5], [43, 0.5], [null, 0.5],
      
      [48, 0.5], [null, 0.5], [48, 0.5], [null, 0.5], [48, 0.5], [null, 0.5], [48, 0.5], [null, 0.5],
      [53, 0.5], [null, 0.5], [53, 0.5], [null, 0.5], [55, 0.5], [null, 0.5], [55, 0.5], [null, 0.5],
      [53, 0.5], [null, 0.5], [53, 0.5], [null, 0.5], [53, 0.5], [null, 0.5], [53, 0.5], [null, 0.5],
      [48, 0.5], [null, 0.5], [48, 0.5], [null, 0.5], [55, 0.5], [null, 0.5], [55, 0.5], [null, 0.5],
    ],
    [
      // Steady game beat
      ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5], ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5],
      ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5], ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5],
      ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5], ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5],
      ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5], ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5],
      ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5], ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5],
      ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5], ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5],
    ]
  );

  const undergroundTheme = buildSection(
    [
      // Underground/cave feel (minor) - like Mario underground level
      [60, 0.375], [60, 0.125], [60, 0.5], [60, 0.5], [62, 0.5], [63, 0.5],
      [62, 0.375], [60, 0.125], [58, 0.5], [57, 0.5], [null, 1],
      
      [60, 0.375], [60, 0.125], [60, 0.5], [60, 0.5], [62, 0.5], [63, 0.5],
      [65, 1.5], [null, 0.5], [63, 1], [null, 1],
      
      // Back to surface
      [60, 0.5], [67, 0.5], [72, 0.5], [67, 0.5],
      [60, 0.5], [64, 0.5], [69, 0.5], [64, 0.5],
      [60, 0.5], [62, 0.5], [64, 0.5], [65, 0.5],
      [67, 1.5], [null, 0.5], [55, 1], [null, 1],
    ],
    [
      // Staccato walking bass
      [48, 0.25], [null, 0.25], [48, 0.25], [null, 0.25], [48, 0.25], [null, 0.25], [48, 0.25], [null, 0.25],
      [46, 0.25], [null, 0.25], [46, 0.25], [null, 0.25], [45, 0.25], [null, 0.25], [45, 0.25], [null, 0.25],
      
      [48, 0.25], [null, 0.25], [48, 0.25], [null, 0.25], [48, 0.25], [null, 0.25], [48, 0.25], [null, 0.25],
      [53, 0.25], [null, 0.25], [53, 0.25], [null, 0.25], [51, 0.25], [null, 0.25], [51, 0.25], [null, 0.25],
      
      [48, 0.25], [null, 0.25], [48, 0.25], [null, 0.25], [55, 0.25], [null, 0.25], [55, 0.25], [null, 0.25],
      [48, 0.25], [null, 0.25], [48, 0.25], [null, 0.25], [52, 0.25], [null, 0.25], [52, 0.25], [null, 0.25],
      [48, 0.25], [null, 0.25], [48, 0.25], [null, 0.25], [50, 0.25], [null, 0.25], [50, 0.25], [null, 0.25],
      [55, 0.25], [null, 0.25], [55, 0.25], [null, 0.25], [43, 0.25], [null, 0.25], [43, 0.25], [null, 0.25],
    ],
    [
      ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5], ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5],
      ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5], ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5],
      ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5], ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5],
      ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5], ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5],
      ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5], ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5],
      ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5], ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5],
      ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5], ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5],
      ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5], ['kick', 0.5], ['hat', 0.5], ['snare', 0.5], ['hat', 0.5],
    ]
  );

  const FORM = [mainTheme, undergroundTheme, mainTheme, undergroundTheme];

  let fullLoop = [];
  let loopBeats = 0;
  for (const sec of FORM) {
    for (const [beat, type, note, dur] of sec.events) {
      fullLoop.push([loopBeats + beat, type, note, dur]);
    }
    loopBeats += sec.totalBeats;
  }
  fullLoop.sort((a, b) => a[0] - b[0]);

  function schedule() {
    if (!enabled || !ctx) return;
    const spb = 60 / (tense ? BPM_TENSE : BPM);
    const horizon = ctx.currentTime + 0.3;

    while (nextTime < horizon) {
      if (noteIdx >= fullLoop.length) noteIdx = 0;
      
      const evt = fullLoop[noteIdx];
      if (!evt) { noteIdx = 0; continue; }

      const [beat, type, note, dur] = evt;
      const noteDur = dur * spb;

      if (type === 'M') {
        // Square wave with 25% pulse width for that classic Mario sound
        playVoice(note, nextTime, noteDur, melGain, 'square', 0.26);
        // Add octave doubling on accented notes (every 4th note)
        if (noteIdx % 4 === 0 && note != null) {
          playVoice(note + 12, nextTime + 0.002, noteDur * 0.5, melGain, 'square', 0.08);
        }
      } else if (type === 'B') {
        // Triangle bass - warm and bouncy
        playVoice(note, nextTime, noteDur, bassGain, 'triangle', 0.30);
      } else if (type === 'D') {
        playDrum(nextTime, note);
      }

      noteIdx++;
      if (noteIdx < fullLoop.length) {
        const nextBeat = fullLoop[noteIdx][0];
        const gap = (nextBeat - beat) * spb;
        if (gap > 0) nextTime += gap;
      } else {
        nextTime += 0.05;
        noteIdx = 0;
      }
    }
  }

  function start() {
    if (!enabled) return;
    ensure();
    if (ctx.state === "suspended") ctx.resume();
    if (!timer) {
      nextTime = ctx.currentTime + 0.1;
      noteIdx = 0;
      timer = setInterval(schedule, 80);
    }
  }

  function stop() {
    if (timer) clearInterval(timer);
    timer = null;
    if (melGain && ctx) {
      try {
        const t = ctx.currentTime;
        melGain.gain.cancelScheduledValues(t);
        melGain.gain.setTargetAtTime(0.0001, t, 0.03);
        bassGain.gain.cancelScheduledValues(t);
        bassGain.gain.setTargetAtTime(0.0001, t, 0.03);
        percGain.gain.cancelScheduledValues(t);
        percGain.gain.setTargetAtTime(0.0001, t, 0.03);
        setTimeout(() => {
          if (melGain) melGain.gain.value = 0.10;
          if (bassGain) bassGain.gain.value = 0.12;
          if (percGain) percGain.gain.value = 0.07;
        }, 150);
      } catch(e) {}
    }
  }

  function setEnabled(on) {
    enabled = !!on;
    localStorage.setItem(LS_KEY, enabled ? "on" : "off");
    if (enabled) start();
    else stop();
    updateButton();
  }

  function toggle() { setEnabled(!enabled); }

  function updateButton() {
    const b = document.getElementById("music-toggle");
    if (!b) return;
    b.classList.toggle("on", enabled);
    b.setAttribute("aria-pressed", enabled ? "true" : "false");
    b.textContent = enabled ? "MUSIC: ON" : "MUSIC: OFF";
  }

  function armAutoplay() {
    const kick = () => {
      if (enabled) start();
      window.removeEventListener("pointerdown", kick);
      window.removeEventListener("keydown", kick);
      window.removeEventListener("touchstart", kick);
    };
    window.addEventListener("pointerdown", kick, { once: true });
    window.addEventListener("keydown", kick, { once: true });
    window.addEventListener("touchstart", kick, { once: true });
  }

  function init() {
    updateButton();
    armAutoplay();
  }

  function setTension(on) {
    tense = !!on;
    if (!ctx || !melGain || !bassGain) return;
    try {
      const t = ctx.currentTime;
      melGain.gain.setTargetAtTime(on ? 0.06 : 0.10, t, 0.3);
      bassGain.gain.setTargetAtTime(on ? 0.07 : 0.12, t, 0.3);
      percGain.gain.setTargetAtTime(on ? 0.04 : 0.07, t, 0.3);
    } catch(e) {}
  }

  return { init, toggle, setEnabled, setTension };
})();
	
// End of music

// Hook up the toggle button (additive; doesn't touch existing UI)
window.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("music-toggle");
  if (btn) btn.addEventListener("click", () => Music.toggle());
  Music.init();
});

// ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const pCanvas = document.getElementById('particles');
const pCtx = pCanvas.getContext('2d');
let particles = [];
function resizeP() { pCanvas.width=window.innerWidth; pCanvas.height=window.innerHeight; }
resizeP(); window.addEventListener('resize', resizeP);

function spawnP(x, y, count, color, spread=80) {
  for (let i=0;i<count;i++) particles.push({
    x, y, vx:(Math.random()-0.5)*spread*0.1, vy:(Math.random()-0.5)*spread*0.1-2,
    life:1, decay:0.015+Math.random()*0.02, size:2+Math.random()*3, color
  });
}
function tickP() {
  pCtx.clearRect(0,0,pCanvas.width,pCanvas.height);
  particles = particles.filter(p => p.life > 0);
  particles.forEach(p => {
    p.x+=p.vx; p.y+=p.vy; p.vy+=0.05; p.life-=p.decay;
    pCtx.globalAlpha=p.life; pCtx.fillStyle=p.color;
    pCtx.fillRect(Math.round(p.x),Math.round(p.y),p.size,p.size);
  });
  pCtx.globalAlpha=1;
}

function floatPopup(x,y,text,color) {
  const el=document.createElement('div');
  el.className='float-popup'; el.textContent=text;
  el.style.left=x+'px'; el.style.top=y+'px'; el.style.color=color;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),1300);
}

function showCombo(text) {
  const el=document.getElementById('combo-banner');
  el.textContent=text; el.className=''; void el.offsetWidth; el.className='show';
  setTimeout(()=>{el.className='';},1600);
}

function shake() {
  const r=document.getElementById('game-root');
  r.classList.remove('shake'); void r.offsetWidth; r.classList.add('shake');
  setTimeout(()=>r.classList.remove('shake'),500);
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// ‚îÄ‚îÄ GAME STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const G = {
  mode:1, players:[], cp:0, year:1, maxYears:12,
  log:[], worldTension:50, evtHist:[], timerInterval:null,
  timerLeft:0, timerMax:30, pendingStances:[], pendingEvent:null,
};

function mkPlayer(stance) {
  const p = {
    stance,
    res:{time:80,money:60,focus:70,rep:50},
    caps:{time:100,money:200,focus:100,rep:100},
    hid:{conviction:0,optionality:0,resilience:0,bureaucracy:0},
    score:{breakthrough:0,wealth:0,impact:0,durability:0},
    total:0, actMax:3, actUsed:0, actHist:[], yearHist:[],
    planChain:0, divSet:new Set(), insurance:0, reserve:0,
    shipped:0, protos:0, undos:[], traits:{},
  };
  switch(stance) {
    case 'DO': p.res.focus=80; p.hid.conviction=20; break;
    case 'IO': p.res.money=70; p.actMax=4; p.hid.optionality=20; break;
    case 'DP': p.res.money=50; p.res.rep=40; p.hid.resilience=20; p.reserve=10; break;
    case 'IP': p.res.money=55; p.res.focus=50; p.actMax=2; p.hid.bureaucracy=25; p.insurance=15; break;
  }
  return p;
}
function cp() { return G.players[G.cp]; }
const SC={DO:'#00e5ff',IO:'#ff6ec7',DP:'#76ff03',IP:'#ff9100'};

// ‚îÄ‚îÄ ACTIONS (now with Silicon Valley flavor) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ACTS = [
  // DO
  { id:'plan', name:'WRITE THE SECRET PLAN', s:['DO'], cost:{time:15,focus:20}, fx:{conviction:15}, delayed:{breakthrough:8}, desc:'Definite vision on a napkin. +15 Conviction.', tag:'PLAN' },
  { id:'proto', name:'BUILD PROTOTYPE', s:['DO','IO'], cost:{time:20,money:15}, fx:{rep:5}, delayed:{breakthrough:12,wealth:5}, desc:'Demo day approaches. Ship or die.', tag:'BUILD' },
  { id:'hire_s', name:'HIRE TRUE BELIEVERS', s:['DO'], cost:{money:25,time:10}, fx:{focus:15,conviction:8}, delayed:{breakthrough:10}, desc:'Cult-like devotion to the mission. +15 Focus.', tag:'TEAM' },
  { id:'ship', name:'SHIP IT (BUGS AND ALL)', s:['DO','IO'], cost:{time:25,focus:15,money:10}, fx:{money:20,rep:15}, delayed:{wealth:15,impact:5}, desc:'Launch now, apologize later. Revenue!', tag:'SHIP' },
  { id:'double', name:'DOUBLE DOWN', s:['DO'], cost:{money:30,focus:20}, fx:{conviction:25}, delayed:{breakthrough:20}, desc:'Bet the company. Again. +25 Conviction.', tag:'FOCUS' },
  { id:'expand', name:'BLITZSCALE', s:['DO','IO'], cost:{money:20,time:15,rep:5}, fx:{rep:10}, delayed:{wealth:15,impact:10}, desc:'Grow first, figure out revenue later.', tag:'GROW' },
  { id:'garage', name:'BACK TO THE GARAGE', s:['DO'], cost:{time:20,focus:15}, fx:{conviction:12,money:5}, delayed:{breakthrough:15}, desc:'Strip it down. Build what matters.', tag:'FOCUS' },

  // IO
  { id:'ab', name:'A/B TEST THE LOGO', s:['IO'], cost:{time:10,money:10}, fx:{optionality:15}, delayed:{wealth:5}, desc:'Does blue or green convert better? +15 Optionality.', tag:'TEST' },
  { id:'diversify', name:'DIVERSIFY THE PORTFOLIO', s:['IO'], cost:{money:20}, fx:{optionality:20}, delayed:{wealth:8,durability:5}, desc:'Never put all eggs in one basket (or app).', tag:'SPREAD' },
  { id:'network', name:'WORK THE CONFERENCE', s:['IO','DO'], cost:{time:15,focus:10}, fx:{rep:15,optionality:10}, delayed:{impact:5}, desc:'Business cards. So many business cards.', tag:'SOCIAL' },
  { id:'refactor', name:'REFACTOR EVERYTHING', s:['IO'], cost:{time:15,focus:15}, fx:{focus:10,optionality:8}, delayed:{durability:5}, desc:'Rewrite in Rust. Again. Process > product.', tag:'PROCESS' },
  { id:'pivot', name:'PIVOT! PIVOT! PIVOT!', s:['IO'], cost:{time:10,focus:10}, fx:{optionality:15,conviction:-20}, delayed:{}, desc:'We\'re a social network now. -20 Conviction!', tag:'PIVOT' },
  { id:'hire_g', name:'HIRE STANFORD MBAS', s:['IO'], cost:{money:15,time:10}, fx:{focus:10,optionality:10}, delayed:{durability:3}, desc:'Great at process. Unclear on product.', tag:'TEAM' },
  { id:'growth_hack', name:'GROWTH HACK', s:['IO'], cost:{time:10,money:5,rep:-3}, fx:{optionality:12,money:8}, delayed:{wealth:5}, desc:'Technically legal. Ethically ambiguous.', tag:'HACK' },

  // DP
  { id:'save', name:'HOARD CASH LIKE A DRAGON', s:['DP','IP'], cost:{time:5}, fx:{money:15,resilience:10}, delayed:{durability:5}, desc:'Smaug had the right idea. +15 Money.', tag:'SAVE' },
  { id:'fortify', name:'FORTIFY THE BUNKER', s:['DP'], cost:{money:15,time:15}, fx:{resilience:20,rep:5}, delayed:{durability:10}, desc:'Triple redundancy. Faraday cages. +20 Resilience.', tag:'DEFEND' },
  { id:'ration', name:'RATION EVERYTHING', s:['DP'], cost:{focus:10}, fx:{time:10,money:5,resilience:10}, delayed:{durability:5}, desc:'One ply. Shared desks. Cold brew is a luxury.', tag:'RATION' },
  { id:'infra', name:'BUILD INFRASTRUCTURE', s:['DP','DO'], cost:{money:25,time:20}, fx:{resilience:15}, delayed:{wealth:10,durability:15}, desc:'Boring but indestructible. Like concrete.', tag:'INFRA' },
  { id:'contingency', name:'PLAN FOR DOOMSDAY', s:['DP'], cost:{time:15,focus:15}, fx:{resilience:15,conviction:5}, delayed:{durability:8}, desc:'Asteroid? Covered. AI uprising? Covered.', tag:'PLAN' },
  { id:'cut', name:'CUT TO THE BONE', s:['DP','IP'], cost:{focus:10}, fx:{money:10,rep:-5,resilience:5}, delayed:{durability:3}, desc:'Fire the chef. Cancel the retreat. -5 Rep.', tag:'CUT' },

  // IP
  { id:'insure', name:'INSURE AGAINST EXISTENCE', s:['IP'], cost:{money:15}, fx:{bureaucracy:15,resilience:5}, delayed:{durability:5}, desc:'Insure the insurance. +15 Bureaucracy.', tag:'INSURE' },
  { id:'lobby', name:'LOBBY FOR REGULATIONS', s:['IP','DP'], cost:{money:20,time:10}, fx:{bureaucracy:10,rep:5}, delayed:{durability:5}, desc:'If we can\'t win, nobody can play.', tag:'LOBBY' },
  { id:'comply', name:'COMPLIANCE OVERDRIVE', s:['IP'], cost:{time:15,focus:15}, fx:{bureaucracy:20,rep:5}, delayed:{durability:8}, desc:'147-page terms of service. +20 Bureaucracy.', tag:'COMPLY' },
  { id:'hedge', name:'HEDGE THE HEDGE', s:['IP'], cost:{money:20,focus:10}, fx:{bureaucracy:10,optionality:5}, delayed:{durability:5}, desc:'Your derivative has a derivative.', tag:'HEDGE' },
  { id:'outsource', name:'FORM A COMMITTEE', s:['IP','IO'], cost:{money:10,focus:5}, fx:{bureaucracy:10,focus:5,conviction:-10}, delayed:{}, desc:'18 people. No decisions. -10 Conviction.', tag:'DEFER' },
  { id:'audit', name:'AUDIT THE AUDITORS', s:['IP','DP'], cost:{time:10,money:10}, fx:{bureaucracy:8,resilience:8,rep:5}, delayed:{durability:5}, desc:'Quis custodiet ipsos custodes?', tag:'CHECK' },
  { id:'nda', name:'NDA EVERYTHING', s:['IP'], cost:{time:5,money:5}, fx:{bureaucracy:12}, delayed:{durability:3}, desc:'Can\'t get sued if nobody knows what you do.', tag:'LEGAL' },
];

// ‚îÄ‚îÄ EVENTS (Silicon Valley absurdism meets real life) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const EVTS = [
  // SHOCKS
  { id:'recession', name:'RECESSION HITS', t:'shock', desc:'Markets crash. Your runway just became a taxiway.', flavor:'"We\'re not in a recession, it\'s a correction." ‚Äî Everyone, 2008', fx:{money:-20,rep:-5}, w:{DO:0.8,IO:0.9,DP:0.5,IP:0.7} },
  { id:'competitor', name:'CLONE ARMY APPEARS', t:'shock', desc:'A well-funded copycat launches. They even copied your font.', flavor:'Turns out being "first to market" just means you did their R&D for free.', fx:{rep:-10,money:-10}, w:{DO:1,IO:0.8,DP:0.6,IP:0.5} },
  { id:'regulation', name:'CONGRESS DISCOVERS YOUR INDUSTRY', t:'shock', desc:'Senators who can\'t set up email now regulate your AI. Compliance costs spike.', flavor:'"Would the CEO please explain to me how the internet works?" ‚Äî Actual Senate hearing', fx:{money:-15,time:-10,focus:-10}, w:{DO:1,IO:0.9,DP:0.7,IP:0.3} },
  { id:'talent_drain', name:'EVERYONE LEAVES FOR A STARTUP', t:'shock', desc:'Your best engineers quit to build a crypto-powered dog-walking app. It gets funded.', flavor:'The dog-walking thing actually works. You hate everything.', fx:{focus:-15,rep:-5}, w:{DO:0.7,IO:0.9,DP:0.8,IP:1} },
  { id:'obsolete', name:'YOUR TECH IS A PUNCHLINE', t:'shock', desc:'A 19-year-old built your entire product as a weekend side project. It\'s on GitHub.', flavor:'"I was bored on a Sunday." ‚Äî The 19-year-old', fx:{focus:-10,conviction:-15,money:-10}, w:{DO:1,IO:0.5,DP:0.6,IP:0.4} },
  { id:'scandal', name:'LEAKED SLACK MESSAGES', t:'shock', desc:'Internal hot takes go viral. Twitter is having a field day. HR is having a meltdown.', flavor:'The screenshot includes an emoji reaction from the CEO.', fx:{rep:-25,money:-5}, w:{DO:0.8,IO:0.7,DP:0.5,IP:0.6}, req:p=>p.res.rep>40 },
  { id:'supply', name:'THE CLOUD IS DOWN', t:'shock', desc:'Your cloud provider has an outage. Your product is the cloud provider. Customers are confused.', flavor:'Status page says "All Systems Operational" while the building is literally on fire.', fx:{money:-15,time:-15}, w:{DO:0.9,IO:0.7,DP:0.4,IP:0.6} },
  { id:'crash', name:'BUBBLE POPS', t:'shock', desc:'Turns out "disruption" wasn\'t a business model. VCs discover EBITDA.', flavor:'WeWork was just the beginning.', fx:{money:-25,resilience:-5}, w:{DO:0.8,IO:1,DP:0.5,IP:0.6} },
  { id:'lawsuit', name:'PATENT TROLL ATTACK', t:'shock', desc:'You\'re being sued for using "a computer to do a thing." The patent is from 1997.', flavor:'Their office is a PO box in East Texas.', fx:{money:-15,focus:-15,time:-10}, w:{DO:0.7,IO:0.8,DP:0.6,IP:0.3} },
  { id:'departure', name:'CO-FOUNDER BREAKUP', t:'shock', desc:'Creative differences. Also they took the code repo. And the espresso machine.', flavor:'The espresso machine hurts the most.', fx:{focus:-10,conviction:-10,rep:-5}, w:{DO:1,IO:0.5,DP:0.7,IP:0.4} },
  { id:'hype_death', name:'HYPE CYCLE HANGOVER', t:'shock', desc:'Last year you were "revolutionary." This year? "Didn\'t they already try that?"', flavor:'The Gartner Trough of Disillusionment is real and it has your name on it.', fx:{rep:-15,money:-10}, w:{DO:0.8,IO:0.9,DP:0.4,IP:0.5} },
  { id:'data_breach', name:'DATA BREACH', t:'shock', desc:'Hackers got in through the smart fish tank in the lobby. Seriously.', flavor:'The fish tank was connected to the network "for temperature monitoring."', fx:{money:-20,rep:-15,focus:-10}, w:{DO:0.7,IO:0.8,DP:0.4,IP:0.5} },

  // OPPORTUNITIES
  { id:'new_tech', name:'NEW PARADIGM DROPS', t:'opportunity', desc:'A genuinely new technology emerges. First-movers get rich. Second-movers get acqui-hired.', flavor:'It\'s like the internet but for [whatever your thing is].', fx:{focus:10,money:10,breakthrough:5}, w:{DO:1.2,IO:0.8,DP:0.5,IP:0.3} },
  { id:'partner', name:'BIG CORP WANTS TO PARTNER', t:'opportunity', desc:'A Fortune 500 company wants to "explore synergies." Their legal review takes 9 months.', flavor:'The partnership announcement uses the word "ecosystem" fourteen times.', fx:{money:15,rep:15}, w:{DO:1,IO:1,DP:0.6,IP:0.4} },
  { id:'talent', name:'ACQUI-HIRE OPPORTUNITY', t:'opportunity', desc:'A failed startup\'s A-team is available. They\'re brilliant, slightly traumatized, and cheap.', flavor:'Their last company "changed the world" of artisanal mayonnaise delivery.', fx:{focus:15,rep:5}, w:{DO:1,IO:0.9,DP:0.6,IP:0.5} },
  { id:'boom', name:'MONEY PRINTER GO BRRRR', t:'opportunity', desc:'Interest rates hit zero. VCs fund anything with "AI" in the pitch deck.', flavor:'A literal Juicero moment. Somebody will fund a subscription for water.', fx:{money:25,rep:5,wealth:5}, w:{DO:1,IO:1,DP:0.5,IP:0.4} },
  { id:'grant', name:'FREE GOVERNMENT MONEY', t:'opportunity', desc:'You qualify for a grant. The application is 200 pages but the money is free.', flavor:'Turns out "advancing American competitiveness" means whatever you want it to mean.', fx:{money:20}, w:{DO:0.8,IO:0.7,DP:0.8,IP:0.9} },
  { id:'viral', name:'YOUR INTERN GOES VIRAL', t:'opportunity', desc:'An intern\'s TikTok about your office becomes a cultural moment. You have 10M views.', flavor:'The TikTok is making fun of you. Somehow this helps.', fx:{rep:20,money:5}, w:{DO:0.9,IO:1,DP:0.4,IP:0.3}, req:p=>p.shipped>0 },
  { id:'govt_contract', name:'GOVERNMENT CONTRACT', t:'opportunity', desc:'Stable revenue for 5 years. The catch: everything is COBOL-compatible.', flavor:'You will attend meetings about meetings. But the check clears.', fx:{money:20,bureaucracy:10,durability:5}, w:{DO:0.5,IO:0.6,DP:1,IP:1.2} },
  { id:'mentor', name:'LEGENDARY FOUNDER CALLS', t:'opportunity', desc:'A legendary founder wants to advise you. They made their fortune in the \'90s and it shows.', flavor:'"Have you considered building a portal?" ‚Äî The mentor, unironically', fx:{conviction:15,focus:10,breakthrough:3}, w:{DO:1.2,IO:0.7,DP:0.5,IP:0.3} },
  { id:'buyout', name:'ACQUISITION OFFER', t:'opportunity', desc:'Big Tech offers a life-changing sum. Your soul costs extra.', flavor:'They promise "full autonomy." The reorg happens in 6 months.', fx:{money:40,wealth:20,conviction:-20}, w:{DO:0.7,IO:1.2,DP:0.5,IP:0.8}, req:p=>p.res.rep>30 },
  { id:'cheap', name:'AWS BILL DROPS 90%', t:'opportunity', desc:'Infrastructure costs collapse. Your burn rate becomes survivable.', flavor:'The CFO weeps tears of joy. Real, actual tears.', fx:{money:15,time:5}, w:{DO:0.8,IO:0.8,DP:1,IP:0.8} },
  { id:'influencer', name:'INFLUENCER DISCOVERS YOU', t:'opportunity', desc:'A mega-influencer casually mentions your product. Servers immediately crash.', flavor:'You don\'t have enough servers. You never had enough servers.', fx:{rep:18,money:12}, w:{DO:0.9,IO:1.1,DP:0.3,IP:0.3}, req:p=>p.shipped>0 },
  { id:'talent_boom', name:'BIG TECH LAYOFFS', t:'opportunity', desc:'A wave of layoffs floods the market with overqualified engineers. Their salary expectations are... aspirational.', flavor:'They want "startup energy" with "big tech compensation." Good luck.', fx:{focus:12,money:-5,rep:5}, w:{DO:1,IO:0.9,DP:0.7,IP:0.5} },

  // SHIFTS
  { id:'dereg', name:'DEREGULATION WAVE', t:'shift', desc:'New administration tears up the rulebook. Move fast, break things is back.', flavor:'Compliance officers update their resumes.', fx:{money:5,conviction:5,bureaucracy:-10}, w:{DO:1.2,IO:1,DP:0.6,IP:0.4} },
  { id:'culture', name:'THE DISCOURSE SHIFTS', t:'shift', desc:'Yesterday\'s innovation is today\'s moral panic. The think pieces are merciless.', flavor:'Op-eds from people who don\'t use your product explain why it\'s destroying society.', fx:{rep:-5,optionality:10}, w:{DO:0.7,IO:1.2,DP:0.5,IP:0.6} },
  { id:'austerity', name:'AUSTERITY IS COOL NOW', t:'shift', desc:'Suddenly "profitable" is trendy. Bootstrap is the new disruption.', flavor:'VCs pretend they always cared about unit economics.', fx:{money:-10,resilience:10}, w:{DO:0.6,IO:0.7,DP:1.2,IP:1} },
  { id:'global', name:'GLOBALIZATION 2.0', t:'shift', desc:'New markets open. Your competitor is now also in Indonesia, India, and Brazil.', flavor:'Localization is harder than you thought. Much, much harder.', fx:{money:5,rep:5,focus:-5}, w:{DO:1,IO:1.1,DP:0.6,IP:0.5} },
  { id:'techlash', name:'TECH BACKLASH', t:'shift', desc:'Public sentiment turns. "Tech bro" is now a slur. Hoodies are out, suits are in.', flavor:'You rebrand as a "purpose-driven impact company." Same product.', fx:{rep:-10,bureaucracy:10,conviction:-5}, w:{DO:0.9,IO:0.8,DP:0.7,IP:1.2} },
  { id:'infra_boom', name:'INFRASTRUCTURE ERA', t:'shift', desc:'Government builds bridges, broadband, and bureaucracy. Boring companies win.', flavor:'The sexiest company in America makes concrete. We live in strange times.', fx:{money:10,resilience:10}, w:{DO:0.9,IO:0.7,DP:1.2,IP:0.8} },
  { id:'risk_up', name:'YOLO ECONOMY', t:'shift', desc:'Everyone quits their jobs. "Follow your passion" trends globally. Money chases dreams.', flavor:'Your barista is now a VC-backed founder. His latte art startup has a $5M valuation.', fx:{money:10,conviction:5,optionality:5}, w:{DO:1.2,IO:1,DP:0.4,IP:0.3} },
  { id:'comply_era', name:'THE COMPLIANCE-INDUSTRIAL COMPLEX', t:'shift', desc:'Audits, certifications, three-letter acronyms. Process consumes everything.', flavor:'You now have more compliance officers than engineers. This is fine.', fx:{bureaucracy:15,focus:-5}, w:{DO:0.5,IO:0.6,DP:0.8,IP:1.3} },
  { id:'trust', name:'TRUST RENAISSANCE', t:'shift', desc:'Somehow, against all odds, people start trusting institutions again. Briefly.', flavor:'It won\'t last. Enjoy it.', fx:{rep:10,focus:5}, w:{DO:1,IO:1,DP:0.8,IP:0.7} },
  { id:'inequality', name:'PITCHFORKS AND TAX PROPOSALS', t:'shift', desc:'Inequality discourse hits fever pitch. "Billionaire" becomes a dirty word.', flavor:'Your private jet now has a carbon offset. Problem solved, right?', fx:{rep:-5,impact:5}, w:{DO:0.8,IO:0.7,DP:0.9,IP:0.8} },
  { id:'ai_hype', name:'AI HYPE REACHES PEAK', t:'shift', desc:'Everything is AI now. Your toaster has AI. Your dog\'s collar has AI. Investors love it.', flavor:'You add "AI" to your product name. Revenue doubles. The product is unchanged.', fx:{money:8,rep:8,conviction:-3}, w:{DO:0.7,IO:1.2,DP:0.5,IP:0.6} },
  { id:'remote_war', name:'RETURN TO OFFICE WARS', t:'shift', desc:'The great RTO vs remote battle consumes all management bandwidth for 6 months.', flavor:'Productivity studies contradict each other. Everyone cites the one they agree with.', fx:{focus:-8,time:-5,bureaucracy:5}, w:{DO:0.7,IO:0.8,DP:0.6,IP:0.9} },

  // SINGULARS
  { id:'zero_one', name:'0 ‚Üí 1 BREAKTHROUGH!', t:'singular', desc:'Against all odds, you created something genuinely new. Not an iteration. Not an improvement. A new thing entirely.', flavor:'"They laughed at us. Then they copied us. Then we won."', fx:{breakthrough:50,money:30,rep:30,wealth:30,impact:20}, w:{DO:2.5,IO:0.3,DP:0.1,IP:0.05}, req:p=>p.hid.conviction>=40 },
  { id:'monopoly', name:'COMPETITION IS FOR LOSERS', t:'singular', desc:'You\'ve captured a market so completely that competitors give up. Peter Thiel nods approvingly.', flavor:'Antitrust lawyers start circling. But for now? Total dominance.', fx:{wealth:40,money:40,rep:10,durability:20}, w:{DO:1.5,IO:0.4,DP:0.5,IP:0.1}, req:p=>p.shipped>=2 },
  { id:'perfect_storm', name:'EVERYTHING BREAKS AT ONCE', t:'singular', desc:'Recession + regulation + competitor + scandal + the office literally floods. All in one quarter.', flavor:'Your therapist fires you as a client. "Too stressful," they say.', fx:{money:-40,rep:-20,focus:-20,time:-20}, w:{DO:0.8,IO:0.8,DP:0.3,IP:0.4} },
  { id:'paradigm', name:'REALITY FORK', t:'singular', desc:'A paradigm shift so dramatic that the entire industry map redraws overnight. Adapt or vanish.', flavor:'The last time this happened, "phone" meant something attached to a wall.', fx:{optionality:20,conviction:-15,money:10}, w:{DO:0.5,IO:1.5,DP:0.4,IP:0.3} },
  { id:'unicorn', name:'UNICORN ACHIEVED', t:'singular', desc:'Your valuation hits $1B. The champagne is from Costco but the number is real.', flavor:'Your parents finally understand what you do. Kind of. Not really.', fx:{money:50,wealth:30,rep:20,breakthrough:15}, w:{DO:2,IO:0.7,DP:0.1,IP:0.05}, req:p=>p.planChain>=4 },
  { id:'institution', name:'IT WILL OUTLIVE YOU', t:'singular', desc:'What you built has become an institution. It no longer needs you. That\'s the point.', flavor:'The interns don\'t know who you are. This is the highest form of success.', fx:{durability:50,impact:30,rep:20,wealth:15}, w:{DO:1,IO:0.5,DP:1.5,IP:0.2}, req:p=>p.hid.resilience>=40 },
  { id:'black_swan', name:'BLACK SWAN (GOOD?)', t:'singular', desc:'An event so improbable that no model predicted it. It helps you enormously.', flavor:'Was it luck? Skill? Position? You\'ll argue about this forever.', fx:{money:35,rep:15,breakthrough:10}, w:{DO:1,IO:1,DP:0.5,IP:0.5} },
  { id:'collapse', name:'EXTINCTION-LEVEL EVENT', t:'singular', desc:'The entire ecosystem collapses. Startups die. VCs hide. Only cockroaches and fortresses survive.', flavor:'"We\'re not in a bubble" ‚Äî VCs, six months ago', fx:{money:-50,rep:-30,focus:-15}, w:{DO:0.8,IO:0.9,DP:0.2,IP:0.3}, req:p=>G.year>=6 },
  { id:'movement', name:'YOU STARTED A MOVEMENT', t:'singular', desc:'It stopped being about your product. People believe in what you represent. They march.', flavor:'You didn\'t plan this. Nobody plans this. That\'s what makes it real.', fx:{impact:40,rep:25,focus:10}, w:{DO:1.2,IO:0.8,DP:0.3,IP:0.1}, req:p=>p.score.impact>=20 },
  { id:'mega_payoff', name:'ONE BET PAYS FOR ALL', t:'singular', desc:'Out of 47 portfolio bets, one returns 1000x. The other 46 were write-offs. Math works.', flavor:'Indeterminate optimism in its purest form. You\'re not a genius. You\'re a statistician.', fx:{money:40,wealth:25,optionality:10}, w:{DO:0.2,IO:2,DP:0.3,IP:0.4}, req:p=>p.hid.optionality>=40 },
  { id:'pied_piper', name:'THE GARAGE WINS', t:'singular', desc:'Your tiny team with no funding somehow built something that humiliates every giant in the industry.', flavor:'Hooli is furious. Gavin Belson is throwing things. You are in a garage eating cereal.', fx:{breakthrough:35,rep:25,money:15,conviction:15}, w:{DO:2,IO:0.5,DP:0.2,IP:0.05}, req:p=>p.hid.conviction>=30&&p.res.money<60 },
  { id:'accidental_empire', name:'ACCIDENTAL EMPIRE', t:'singular', desc:'You built a chat app for your team. 200 million people now use it. You still don\'t know why.', flavor:'"We never intended for this to happen." ‚Äî Every accidental billionaire ever.', fx:{wealth:35,money:30,rep:20,impact:15}, w:{DO:0.4,IO:1.8,DP:0.2,IP:0.3}, req:p=>p.shipped>=1&&p.hid.optionality>=25 },
];

// ‚îÄ‚îÄ ENDINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ENDS = {
  DO: [
    { label:'THE VISIONARY', cond:p=>p.score.breakthrough>=50, blurb:'You saw the future and built it with your bare hands. The secret plan worked. Not because the universe owed you ‚Äî but because definite plans, executed with conviction, bend probability. You weren\'t a lottery ticket. You were the dealer.', c:'var(--do)' },
    { label:'THE BUILDER', cond:p=>p.score.wealth>=40, blurb:'Not a 0‚Üí1 breakthrough, but a real thing that works. Your plan evolved but never abandoned its core. The compound interest of conviction paid off. The future you imagined? Close enough. Better than drift.', c:'var(--do)' },
    { label:'THE STUBBORN IDEALIST', cond:p=>p.score.breakthrough>=15, blurb:'The vision was clear. The execution was messy. You got close enough to see the promised land but not close enough to touch it. Was the plan wrong, or was the world not ready? You\'ll wonder forever.', c:'var(--do)' },
    { label:'THE BEAUTIFUL DREAMER', cond:()=>true, blurb:'You bet everything on a specific future that never arrived. The napkin plan sits in a drawer. Conviction without adaptation becomes delusion. The universe doesn\'t care about your five-year plan. But at least you had one.', c:'var(--do)' },
  ],
  IO: [
    { label:'THE PORTFOLIO KING', cond:p=>p.total>=80, blurb:'You tested everything, diversified perfectly, and optimized your way to prosperity. No singular vision, no moonshot ‚Äî just relentless process and probability. Is this the best humanity can do? The returns say: maybe.', c:'var(--io)' },
    { label:'THE OPTIMIZER', cond:p=>p.score.wealth>=30, blurb:'Your diversified approach delivered solid returns. A/B tested your way to the comfortable middle. The process worked ‚Äî but somewhere in all those spreadsheets, the question "why?" got lost.', c:'var(--io)' },
    { label:'THE DRIFT', cond:p=>p.score.durability>=15, blurb:'North-east drift achieved. You moved in a vaguely positive direction without ever choosing a specific destination. Lots of activity. Lots of experiments. What did you build? Hard to say exactly.', c:'var(--io)' },
    { label:'THE PIVOT TO NOWHERE', cond:()=>true, blurb:'Social network. Marketplace. SaaS tool. AI wrapper. You pivoted so many times you forgot what you originally believed. Process without substance. Options without choices. The spreadsheet is immaculate. The results are not.', c:'var(--io)' },
  ],
  DP: [
    { label:'THE FORTRESS', cond:p=>p.score.durability>=50, blurb:'While empires crumbled around you, your walls held. Every crisis that destroyed others barely dented your reserves. Not glamorous. Not exciting. But when the dust settles, you\'re the last one standing. There\'s a word for that: winning.', c:'var(--dp)' },
    { label:'THE SURVIVOR', cond:p=>p.score.durability>=30, blurb:'You prepared for the worst and got something close to it. But your rationing held. Your walls held. Your cold-brew-free, one-ply office held. In a world of fragile things, you were not fragile. That counts.', c:'var(--dp)' },
    { label:'THE BUNKER DWELLER', cond:p=>p.res.money>=40, blurb:'Safe inside your fortress, you watched the world change through a very small window. Nothing got in ‚Äî not danger, not opportunity, not sunlight. You survived. Was that the point?', c:'var(--dp)' },
    { label:'THE RUIN', cond:()=>true, blurb:'Even the fortress fell. You planned for a dark future and got a darker one. The walls weren\'t thick enough. The rations ran out. Pessimism without sufficient resources is just prophecy fulfilled.', c:'var(--dp)' },
  ],
  IP: [
    { label:'THE ETERNAL BUREAUCRACY', cond:p=>p.score.durability>=40, blurb:'You outlasted everyone through sheer institutional inertia. Not through vision or courage ‚Äî through forms filed in triplicate, insurance policies nested like Russian dolls, and meetings about meetings. The paperwork says you won. Who are we to argue?', c:'var(--ip)' },
    { label:'THE INSURANCE POLICY', cond:p=>p.hid.bureaucracy>=50, blurb:'Every risk covered. Every form filed. Every hedge hedged. You built nothing new, broke nothing old, and existed in a perfect equilibrium of absolute zero. Bureaucratic nirvana achieved.', c:'var(--ip)' },
    { label:'THE STAGNANT POND', cond:p=>p.res.money>=20, blurb:'Nothing ventured, nothing gained. Your hedges cancelled your bets. Your insurance ate your capital. Your committees produced reports about the need for more reports. You existed. Technically.', c:'var(--ip)' },
    { label:'THE VOID', cond:()=>true, blurb:'You avoided all risk and found the biggest risk of all: total irrelevance. While you were filing forms, the world moved on without you. No vision, no plan, no agency, no story. Not even a cautionary tale ‚Äî just a footnote.', c:'var(--ip)' },
  ],
};

const ACHVS = [
  { id:'0to1', name:'0‚Üí1 CREATOR', desc:'Trigger a breakthrough event', chk:p=>p.score.breakthrough>=50 },
  { id:'fort', name:'FORTRESS', desc:'Resilience over 60', chk:p=>p.hid.resilience>=60 },
  { id:'portfolio', name:'OPTIONALITY MAX', desc:'Optionality over 70', chk:p=>p.hid.optionality>=70 },
  { id:'paper', name:'KAFKAESQUE', desc:'Bureaucracy over 80', chk:p=>p.hid.bureaucracy>=80 },
  { id:'believer', name:'TRUE BELIEVER', desc:'6+ plan chain', chk:p=>p.planChain>=6 },
  { id:'rich', name:'SCROOGE MODE', desc:'End with 150+ Money', chk:p=>p.res.money>=150 },
  { id:'famous', name:'FRONT PAGE', desc:'Hit 90+ Reputation', chk:p=>p.res.rep>=90 },
  { id:'shipper', name:'SERIAL SHIPPER', desc:'Ship 4+ products', chk:p=>p.shipped>=4 },
];

// ‚îÄ‚îÄ SCREEN FLOW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function go(screen, mode) {
  if (screen==='stance') {
    G.mode=mode; G.pendingStances=[];
    document.getElementById('stanceTitle').textContent = mode===2?'PLAYER 1: CHOOSE STANCE':'CHOOSE YOUR FUTURE STANCE';
    document.querySelectorAll('.stance-card').forEach(c=>c.classList.remove('sel'));
    document.getElementById('goBtn').disabled=true;
    showScreen('stance-screen');
  }
}

let pickedStance=null;
function pickStance(s) {
  sfx('select'); pickedStance=s;
  document.querySelectorAll('.stance-card').forEach(c=>c.classList.remove('sel'));
  document.querySelector(`.stance-card[data-s="${s}"]`).classList.add('sel');
  document.getElementById('goBtn').disabled=false;
}

function beginRun() {
  if (!pickedStance) return;
  G.pendingStances.push(pickedStance);
  if (G.mode===2 && G.pendingStances.length===1) {
    document.getElementById('stanceTitle').textContent='PLAYER 2: CHOOSE STANCE';
    pickedStance=null;
    document.querySelectorAll('.stance-card').forEach(c=>c.classList.remove('sel'));
    document.getElementById('goBtn').disabled=true;
    return;
  }
  G.year=1;G.cp=0;G.log=[];G.evtHist=[];G.worldTension=50;
  G.players=G.pendingStances.map(s=>mkPlayer(s));
  pickedStance=null;
  showScreen('play-screen');
  startYear();
}

function startTimer() {
  G.timerLeft=G.timerMax;
  const fill=document.getElementById('timerFill');
  fill.style.width='100%'; fill.classList.remove('low');
  clearInterval(G.timerInterval);
  G.timerInterval=setInterval(()=>{
    G.timerLeft-=0.1;
    const pct=Math.max(0,(G.timerLeft/G.timerMax)*100);
    fill.style.width=pct+'%';
    if(pct<25) fill.classList.add('low'); else fill.classList.remove('low');
    if(G.timerLeft<=5&&G.timerLeft>0&&Math.round(G.timerLeft*10)%10===0) sfx('tick');
    if(G.timerLeft<=0) { clearInterval(G.timerInterval); sfx('buzzer'); endYear(); }
  },100);
}

function startYear() {
  const p=cp();
  p.actUsed=0; p.undos=[];
  regen(p);

  // Show cinematic transition (skip year 1 first player to avoid delay on game start)
  const skipTransition = G.year === 1 && G.cp === 0;

  function doStart() {
    startTimer();
    renderHUD(); renderRes(); renderActs(); renderLog(); renderWorld();
    startWorldAnim();
    document.getElementById('btnEnd').disabled=false;
    document.getElementById('btnUndo').disabled=true;
    addLog(`‚îÄ‚îÄ YEAR ${G.year} ‚îÄ‚îÄ`,'t-year');
    if(G.mode===2) addLog(`Player ${G.cp+1} (${p.stance}) turn`,'t-year');
  }

  if (skipTransition) {
    doStart();
  } else {
    showYearTransition(G.year, p, doStart);
  }
}

function regen(p) {
  p.res.time=Math.min(p.caps.time,p.res.time+15);
  p.res.focus=Math.min(p.caps.focus,p.res.focus+10);
  p.res.money=Math.min(p.caps.money,p.res.money+5);
  p.res.rep=Math.max(0,p.res.rep-2);
  if(p.stance!=='DO') p.hid.conviction=Math.max(0,p.hid.conviction-4);
  if(p.stance!=='IO') p.hid.optionality=Math.max(0,p.hid.optionality-3);
  if(p.stance!=='DP') p.hid.resilience=Math.max(0,p.hid.resilience-2);
  if(p.stance!=='IP') p.hid.bureaucracy=Math.max(0,p.hid.bureaucracy-2);
  clampRes(p);
}

function clampRes(p) {
  for(const k in p.res) p.res[k]=Math.max(0,Math.min(p.caps[k],Math.round(p.res[k])));
  for(const k in p.hid) p.hid[k]=Math.max(0,Math.min(100,Math.round(p.hid[k])));
}

function doAction(id) {
  const p=cp();
  if(p.actUsed>=p.actMax) return;
  const act=ACTS.find(a=>a.id===id);
  if(!act) return;
  for(const [k,v] of Object.entries(act.cost)) if((p.res[k]||0)<v) return;

  p.undos.push(JSON.parse(JSON.stringify({res:p.res,hid:p.hid,score:p.score,actUsed:p.actUsed,planChain:p.planChain,divSet:[...p.divSet],shipped:p.shipped,protos:p.protos,insurance:p.insurance,reserve:p.reserve})));

  for(const [k,v] of Object.entries(act.cost)) p.res[k]-=v;
  for(const [k,v] of Object.entries(act.fx)) {
    if(k in p.res) p.res[k]+=v;
    else if(k in p.hid) p.hid[k]+=v;
  }
  for(const [k,v] of Object.entries(act.delayed||{})) {
    if(k in p.score) p.score[k]+=v;
  }

  // Plan chain
  if(act.s.includes('DO')&&p.stance==='DO'&&act.id!=='pivot') {
    p.planChain++;
    if(p.planChain>=3) {
      const bonus=Math.floor(p.planChain*1.5);
      p.score.breakthrough+=bonus;
      p.hid.conviction=Math.min(100,p.hid.conviction+3);
      if(p.planChain===3){showCombo('PLAN CHAIN √ó3!');sfx('combo');}
      else if(p.planChain===5){showCombo('CONVICTION LOCK √ó5!!');sfx('powerup');}
      else if(p.planChain>=7){showCombo('UNSTOPPABLE √ó'+p.planChain+'!!!');sfx('breakthrough');}
    }
  } else if(p.stance==='DO'&&act.id==='pivot'){p.planChain=0;}

  // Diversity
  p.divSet.add(act.tag);
  if(p.stance==='IO'&&p.divSet.size>=4) {
    p.hid.optionality=Math.min(100,p.hid.optionality+3);
    if(p.divSet.size===4){showCombo('DIVERSIFIED √ó4!');sfx('combo');}
    else if(p.divSet.size===6){showCombo('MAXIMUM OPTIONALITY!');sfx('powerup');}
  }

  if(act.id==='ship') p.shipped++;
  if(act.id==='proto') p.protos++;
  if(act.id==='insure') p.insurance+=10;
  if(act.id==='fortify'||act.id==='save') p.reserve+=10;

  p.actUsed++;
  p.actHist.push(act.id);
  clampRes(p);

  sfx(act.fx.money>10?'cha_ching':'select');
  const card=document.querySelector(`.act-card[data-id="${id}"]`);
  if(card) {
    const r=card.getBoundingClientRect();
    spawnP(r.left+r.width/2,r.top,15,SC[p.stance]);
    floatPopup(r.left+r.width/2-30,r.top-10,act.tag,SC[p.stance]);
  }

  const scoreEl=document.getElementById('hudScore');
  scoreEl.classList.remove('pulse');void scoreEl.offsetWidth;scoreEl.classList.add('pulse');

  addLog(`‚ñ∂ ${act.name}`,'t-action');
  renderHUD();renderRes(true);renderActs();renderWorld();
  document.getElementById('btnUndo').disabled=false;
}

function undo() {
  const p=cp();
  if(!p.undos.length) return;
  const s=p.undos.pop();
  Object.assign(p,{res:s.res,hid:s.hid,score:s.score,actUsed:s.actUsed,planChain:s.planChain,shipped:s.shipped,protos:s.protos,insurance:s.insurance,reserve:s.reserve});
  p.divSet=new Set(s.divSet);
  p.actHist.pop(); G.log.pop();
  renderHUD();renderRes();renderActs();renderLog();renderWorld();
  document.getElementById('btnUndo').disabled=!p.undos.length;
}

function endYear() {
  clearInterval(G.timerInterval);
  const p=cp();
  p.yearHist.push({y:G.year,money:p.res.money,rep:p.res.rep,conv:p.hid.conviction,opt:p.hid.optionality,res:p.hid.resilience,bur:p.hid.bureaucracy,score:{...p.score}});
  if(G.mode===2&&G.cp===0){G.cp=1;startYear();return;}
  document.getElementById('btnEnd').disabled=true;
  setTimeout(()=>generateEvent(),300);
}

// ‚îÄ‚îÄ EVENT ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateEvent() {
  const p=cp();
  const yf=G.year/G.maxYears;
  let sc=0.25+yf*0.15, oc=0.30-yf*0.05, hc=0.25, gc=0.05+yf*0.08;
  if(p.hid.resilience>40) sc*=0.7;
  if(p.hid.bureaucracy>40) sc*=0.8;
  if(p.hid.conviction>50) gc*=1.3;
  if(p.hid.optionality>50) oc*=1.2;
  const tot=sc+oc+hc+gc;
  sc/=tot;oc/=tot;hc/=tot;gc/=tot;
  const roll=Math.random();
  let type=roll<sc?'shock':roll<sc+oc?'opportunity':roll<sc+oc+hc?'shift':'singular';
  let cands=EVTS.filter(e=>e.t===type&&(!e.req||e.req(p))&&!G.evtHist.slice(-3).includes(e.id));
  if(!cands.length) cands=EVTS.filter(e=>e.t==='shift'&&!G.evtHist.slice(-3).includes(e.id));
  if(!cands.length) cands=EVTS.filter(e=>e.t==='shift');
  const wt=cands.map(e=>({e,w:(e.w[p.stance]||0.5)+Math.random()*0.3}));
  wt.sort((a,b)=>b.w-a.w);
  const evt=wt[0].e;
  G.evtHist.push(evt.id);

  const afx={...evt.fx};
  if(evt.t==='shock') {
    const iProt=Math.min(0.5,p.insurance/100);
    const rProt=Math.min(0.4,p.hid.resilience/200);
    const prot=1-Math.max(iProt,rProt);
    for(const k in afx) if(afx[k]<0) afx[k]=Math.round(afx[k]*prot);
  }

  G.pendingEvent={evt,afx};
  showEventPopup(evt,afx);
}

function showEventPopup(evt, afx) {
  const colors={shock:'var(--danger)',opportunity:'var(--success)',shift:'var(--io)',singular:'var(--accent)'};
  document.getElementById('evtType').textContent=evt.t.toUpperCase()+' EVENT';
  document.getElementById('evtType').style.color=colors[evt.t];
  document.getElementById('evtName').textContent=evt.name;

  // Typewriter
  const descEl=document.getElementById('evtDesc');
  descEl.textContent='';
  let di=0;
  const tw=setInterval(()=>{
    if(di<evt.desc.length){descEl.textContent+=evt.desc[di];di++;}else clearInterval(tw);
  },20);

  // Flavor text
  const flavorEl=document.getElementById('evtFlavor');
  flavorEl.textContent=evt.flavor||'';

  let fxHTML='';
  for(const [k,v] of Object.entries(afx)) {
    const sign=v>=0?'+':'';
    const cls=v>=0?'fx-pos':'fx-neg';
    const label={time:'Time',money:'Money',focus:'Focus',rep:'Rep',conviction:'Conv',optionality:'Opt',resilience:'Res',bureaucracy:'Bur',breakthrough:'Break',wealth:'Wealth',impact:'Impact',durability:'Dur'}[k]||k;
    fxHTML+=`<span class="${cls}">${sign}${v} ${label}</span>  `;
  }
  document.getElementById('evtFx').innerHTML=fxHTML;

  document.getElementById('event-overlay').classList.add('show');

  // Sound + VFX
  if(evt.t==='singular') {
    const hasGood = Object.values(afx).some(v=>v>15);
    sfx(hasGood?'breakthrough':'crash');
    spawnP(window.innerWidth/2,window.innerHeight/2,60,'#ffcc00',200);
    spawnP(window.innerWidth/2,window.innerHeight/2,40,'#fff',150);
    if(!hasGood) { shake(); worldShock(); }
    else worldOpportunity();
  } else if(evt.t==='shock') {
    const shockSounds=['shock','damage','crash','alarm','sad_trombone','whomp','drain'];
    sfx(shockSounds[Math.floor(Math.random()*shockSounds.length)]);
    shake(); worldShock();
    spawnP(window.innerWidth/2,window.innerHeight/2,30,'#ff1744',120);
    if(typeof Music !== 'undefined' && Music.setTension) Music.setTension(true);
  } else if(evt.t==='opportunity') {
    const oppSounds=['opportunity','cha_ching','heal','sparkle','levelup','powerup'];
    sfx(oppSounds[Math.floor(Math.random()*oppSounds.length)]);
    spawnP(window.innerWidth/2,window.innerHeight/2,25,'#00e676',100);
    worldOpportunity();
    if(typeof Music !== 'undefined' && Music.setTension) Music.setTension(false);
  } else {
    sfx('shift');
    spawnP(window.innerWidth/2,window.innerHeight/2,15,'#ff6ec7',80);
  }
}

function resolveEvent() {
  const {evt,afx}=G.pendingEvent;
  const targets=G.mode===2?G.players:[cp()];
  targets.forEach(p=>{
    for(const [k,v] of Object.entries(afx)) {
      if(k in p.res) p.res[k]+=v;
      else if(k in p.hid) p.hid[k]+=v;
      else if(k in p.score) p.score[k]+=v;
    }
    clampRes(p);
  });
  if(evt.t==='shock') G.worldTension=Math.min(100,G.worldTension+8);
  else if(evt.t==='opportunity') G.worldTension=Math.max(0,G.worldTension-5);
  addLog(`${evt.t.toUpperCase()}: ${evt.name}`,'t-'+(evt.t==='opportunity'?'opp':evt.t));

  document.getElementById('event-overlay').classList.remove('show');

  if(G.mode===2) G.cp=0;
  G.year++;

  if(G.year>G.maxYears){sfx('endgame');setTimeout(endRun,500);}
  else{renderWorld();startYear();}
}

function endRun() {
  G.players.forEach(p=>{
    p.score.breakthrough+=Math.floor(p.hid.conviction/5);
    p.score.durability+=Math.floor(p.hid.resilience/4)+Math.floor(p.hid.bureaucracy/6);
    p.score.wealth+=Math.floor(p.res.money/5);
    p.score.impact+=Math.floor(p.res.rep/5);
    p.total=p.score.breakthrough+p.score.wealth+p.score.impact+p.score.durability;
  });
  renderSummary();
}

function getEnding(p) {
  for(const e of ENDS[p.stance]) if(e.cond(p)) return e;
  return ENDS[p.stance].slice(-1)[0];
}

function renderSummary() {
  const c=document.getElementById('summary-screen');
  let h='<div class="sum-title">RUN COMPLETE</div>';
  G.players.forEach((p,idx)=>{
    const e=getEnding(p);
    if(G.mode===2) h+=`<div style="font-size:9px;color:${SC[p.stance]};margin:10px 0 4px;">PLAYER ${idx+1} ‚Äî ${p.stance}</div>`;
    h+=`<div class="sum-ending" style="color:${e.c}">${e.label}</div>`;
    h+=`<div class="sum-blurb">${e.blurb}</div>`;
    h+=`<div class="sum-grid">
      <div class="sum-stat"><div class="sl">TOTAL</div><div class="sv" style="color:var(--accent)">${p.total}</div></div>
      <div class="sum-stat"><div class="sl">BREAKTHROUGH</div><div class="sv" style="color:var(--do)">${p.score.breakthrough}</div></div>
      <div class="sum-stat"><div class="sl">WEALTH</div><div class="sv" style="color:#ffee58">${p.score.wealth}</div></div>
      <div class="sum-stat"><div class="sl">IMPACT</div><div class="sv" style="color:var(--io)">${p.score.impact}</div></div>
      <div class="sum-stat"><div class="sl">DURABILITY</div><div class="sv" style="color:var(--dp)">${p.score.durability}</div></div>
      <div class="sum-stat"><div class="sl">CONVICTION</div><div class="sv">${p.hid.conviction}</div></div>
      <div class="sum-stat"><div class="sl">PLAN CHAIN</div><div class="sv">${p.planChain}</div></div>
      <div class="sum-stat"><div class="sl">PRODUCTS</div><div class="sv">${p.shipped}</div></div>
    </div>`;
    const achvs=ACHVS.filter(a=>a.chk(p));
    if(achvs.length) {
      h+='<div class="sum-achv">';
      achvs.forEach((a,i)=>{h+=`<div class="achv-item" style="animation-delay:${i*0.15}s">‚òÖ ${a.name} ‚Äî ${a.desc}</div>`;});
      h+='</div>';
    }
    h+=`<div class="sum-chart"><canvas id="chart${idx}" width="600" height="140"></canvas></div>`;
  });
  h+=`<div style="display:flex;gap:12px;justify-content:center;margin:16px 0;">
    <button class="g-btn" onclick="sfx('start');go('stance',${G.mode})">PLAY AGAIN</button>
    <button class="g-btn sec" onclick="sfx('back');showScreen('title-screen')">TITLE</button>
  </div>`;
  c.innerHTML=h;
  showScreen('summary-screen');
  setTimeout(()=>{
    sfx('fanfare');
    G.players.forEach((p,i)=>drawChart(`chart${i}`,p));
  },200);
}

function drawChart(id,p) {
  const cv=document.getElementById(id);
  if(!cv||!p.yearHist.length) return;
  const ctx=cv.getContext('2d');
  const W=cv.width,H=cv.height;
  ctx.fillStyle='#0a0a14';ctx.fillRect(0,0,W,H);
  ctx.strokeStyle='#1a1a2a';ctx.lineWidth=1;
  for(let i=0;i<5;i++){const y=H*0.1+i*(H*0.75/4);ctx.beginPath();ctx.moveTo(20,y);ctx.lineTo(W-10,y);ctx.stroke();}
  if(p.yearHist.length<2) return;
  const maxM=Math.max(...p.yearHist.map(y=>y.money),1);
  function line(data,max,color) {
    ctx.strokeStyle=color;ctx.lineWidth=2.5;ctx.beginPath();
    data.forEach((v,i)=>{
      const x=(i/(data.length-1))*(W-40)+25,y=H-20-(v/max)*(H-40);
      i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    });ctx.stroke();
    ctx.strokeStyle=color;ctx.lineWidth=6;ctx.globalAlpha=0.15;ctx.beginPath();
    data.forEach((v,i)=>{
      const x=(i/(data.length-1))*(W-40)+25,y=H-20-(v/max)*(H-40);
      i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    });ctx.stroke();ctx.globalAlpha=1;
  }
  line(p.yearHist.map(y=>y.money),maxM,'#ffee58');
  line(p.yearHist.map(y=>y.conv),100,'#00e5ff');
  line(p.yearHist.map(y=>y.opt),100,'#ff6ec7');
  line(p.yearHist.map(y=>y.res),100,'#76ff03');
  ctx.font='8px "Press Start 2P"';
  ctx.fillStyle='#ffee58';ctx.fillText('$',10,14);
  ctx.fillStyle='#00e5ff';ctx.fillText('C',30,14);
  ctx.fillStyle='#ff6ec7';ctx.fillText('O',50,14);
  ctx.fillStyle='#76ff03';ctx.fillText('R',70,14);
  ctx.fillStyle='#444';ctx.font='7px monospace';
  p.yearHist.forEach((y,i)=>{ctx.fillText('Y'+y.y,(i/(p.yearHist.length-1))*(W-40)+20,H-4);});
}

// ‚îÄ‚îÄ RENDERING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHUD() {
  const p=cp();
  const badge=document.getElementById('hudStance');
  badge.textContent=p.stance;badge.style.background=SC[p.stance];
  document.getElementById('hudYear').textContent=`YEAR ${G.year} / ${G.maxYears}`;
  document.getElementById('hudScore').textContent=p.score.breakthrough+p.score.wealth+p.score.impact+p.score.durability;
  const pi=document.getElementById('hudPlayer');
  if(G.mode===2){pi.style.display='inline';pi.textContent=`P${G.cp+1}`;pi.style.color=SC[p.stance];}
  else pi.style.display='none';
}

let prevRes={};
function renderRes(flash) {
  const p=cp();
  const defs=[
    {k:'time',icon:'‚è±',l:'TIME',c:'#42a5f5'},
    {k:'money',icon:'üí∞',l:'MONEY',c:'#ffee58'},
    {k:'focus',icon:'üéØ',l:'FOCUS',c:'#ce93d8'},
    {k:'rep',icon:'‚≠ê',l:'REP',c:'#ef5350'},
  ];
  const hvMap={DO:{k:'conviction',l:'CONVICTION',c:'var(--do)'},IO:{k:'optionality',l:'OPTIONALITY',c:'var(--io)'},DP:{k:'resilience',l:'RESILIENCE',c:'var(--dp)'},IP:{k:'bureaucracy',l:'BUREAUCRACY',c:'var(--ip)'}};
  let h='';
  defs.forEach(d=>{
    const pct=Math.round((p.res[d.k]/p.caps[d.k])*100);
    const diff=(prevRes[d.k]||0)!==p.res[d.k];
    const dir=p.res[d.k]>(prevRes[d.k]||0)?'up':p.res[d.k]<(prevRes[d.k]||0)?'down':'';
    h+=`<div class="res-item">
      <span style="font-size:10px">${d.icon}</span><span>${d.l}</span>
      <div class="res-bar"><div class="res-fill ${flash&&diff?'flash':''}" style="width:${pct}%;background:${d.c}"></div></div>
      <span class="res-val ${flash?dir:''}">${p.res[d.k]}</span>
    </div>`;
  });
  const hv=hvMap[p.stance];
  h+=`<div class="hv-item"><span>${hv.l}</span><div class="hv-bar"><div class="hv-fill" style="width:${p.hid[hv.k]}%;background:${hv.c}"></div></div><span>${p.hid[hv.k]}</span></div>`;
  document.getElementById('resRow').innerHTML=h;
  prevRes={...p.res};
  if(flash) setTimeout(()=>document.querySelectorAll('.res-val').forEach(el=>{el.classList.remove('up','down');}),600);
}

function renderActs() {
  const p=cp();
  const rem=p.actMax-p.actUsed;
  document.getElementById('actCount').textContent=`ACTIONS: ${rem} / ${p.actMax}`;
  document.getElementById('actCount').style.color=rem>0?'var(--accent)':'var(--dim)';
  const avail=ACTS.filter(a=>a.s.includes(p.stance));
  let h='';
  avail.forEach(a=>{
    let canAfford=true;
    for(const [k,v] of Object.entries(a.cost)) if((p.res[k]||0)<v){canAfford=false;break;}
    const off=!canAfford||rem<=0;
    const costStr=Object.entries(a.cost).map(([k,v])=>`-${v}${k[0].toUpperCase()}`).join(' ');
    h+=`<div class="act-card ${off?'off':''}" data-id="${a.id}" onclick="${off?'':`doAction('${a.id}')`}">
      <div class="act-tag" style="background:${SC[a.s[0]]}">${a.tag}</div>
      <div class="act-name">${a.name}</div>
      <div class="act-cost">${costStr}</div>
      <div class="act-fx">${a.desc}</div>
    </div>`;
  });
  document.getElementById('actGrid').innerHTML=h;
}

function addLog(text,cls='') {
  G.log.push({text,cls});renderLog();
}

function renderLog() {
  const list=document.getElementById('logList');
  let h='';
  G.log.slice(-25).reverse().forEach(l=>{
    h+=`<div class="log-entry ${l.cls}">${l.text}</div>`;
  });
  list.innerHTML=h;
}

// ‚îÄ‚îÄ YEAR TRANSITION CINEMATIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const YEAR_HEADLINES = {
  early: [ // Years 1-4
    ["THE FOUNDATION","Every empire starts with a napkin sketch"],
    ["FIRST STEPS","The journey of a thousand pivots begins"],
    ["SEEDS PLANTED","Now we wait. And burn cash."],
    ["EARLY DAYS","Nobody knows your name. Yet."],
  ],
  mid: [ // Years 5-8
    ["THE GRIND","Glamour fades. Spreadsheets remain."],
    ["HALFWAY THERE","Too late to quit. Too early to celebrate."],
    ["THE CRUCIBLE","This is where pretenders break"],
    ["INFLECTION POINT","The next move changes everything"],
  ],
  late: [ // Years 9-11
    ["THE FINAL ACT","History is watching"],
    ["ENDGAME APPROACHES","No more practice rounds"],
    ["LEGACY TIME","What will they say you built?"],
    ["THE HOME STRETCH","Every decision is magnified now"],
  ],
  finale: [
    ["THE FINAL YEAR","This is it. Make it count."],
  ],
};

const STANCE_HEADLINES = {
  DO: {
    high: ["THE PLAN IS WORKING","Conviction compounds"],
    low: ["THE VISION WAVERS","Even believers have doubts"],
  },
  IO: {
    high: ["OPTIONS EVERYWHERE","The portfolio diversifies"],
    low: ["SPREADING TOO THIN","Optionality has a cost"],
  },
  DP: {
    high: ["THE WALLS HOLD","Fortress strategy pays off"],
    low: ["CRACKS IN THE BUNKER","Even fortresses need upkeep"],
  },
  IP: {
    high: ["COMPLIANCE ACHIEVED","The paperwork is immaculate"],
    low: ["DROWNING IN PROCESS","The forms have forms now"],
  },
};

function getYearHeadline(year, player) {
  // Mix of era-based and stance-based headlines
  const useStance = Math.random() > 0.5 && year > 2;

  if (useStance) {
    const hv = {DO:'conviction',IO:'optionality',DP:'resilience',IP:'bureaucracy'}[player.stance];
    const level = player.hid[hv] > 35 ? 'high' : 'low';
    const [headline, sub] = STANCE_HEADLINES[player.stance][level];
    return { headline, sub };
  }

  let pool;
  if (year >= 12) pool = YEAR_HEADLINES.finale;
  else if (year >= 9) pool = YEAR_HEADLINES.late;
  else if (year >= 5) pool = YEAR_HEADLINES.mid;
  else pool = YEAR_HEADLINES.early;

  const [headline, sub] = pool[Math.floor(Math.random() * pool.length)];
  return { headline, sub };
}

function showYearTransition(year, player, callback) {
  const el = document.getElementById('year-transition');
  const { headline, sub } = getYearHeadline(year, player);

  document.getElementById('ytYear').textContent = `YEAR ${year}`;
  document.getElementById('ytHeadline').textContent = headline;
  document.getElementById('ytSubline').textContent = sub;

  // Reset animations
  el.classList.remove('show');
  void el.offsetWidth;

  // Re-trigger child animations by cloning
  ['ytYear','ytHeadline','ytSubline'].forEach(id => {
    const node = document.getElementById(id);
    node.style.animation = 'none';
    void node.offsetWidth;
    node.style.animation = '';
  });

  el.classList.add('show');
  sfx('dramatic');

  setTimeout(() => {
    el.classList.remove('show');
    if (callback) callback();
  }, 2000);
}

// ‚îÄ‚îÄ WORLD CANVAS (LIVING) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let worldCtx, worldW, worldH;
let worldAnim = { buildings: [], cranes: [], weather: [], character: { x: 50, frame: 0 }, lastShock: 0, lastOpp: 0 };

function initWorldBuildings(p) {
  const wealth = p.score.wealth + p.res.money * 0.3;
  const count = Math.min(15, Math.floor(3 + wealth / 20));
  const buildings = [];
  for (let i = 0; i < Math.max(count, worldAnim.buildings.length); i++) {
    const seed = (i * 7 + 13) * 37;
    const bw = 14 + (seed % 18);
    let targetH = 20 + (seed % 25) + (wealth / 8) + (p.score.breakthrough * 1.5);
    targetH = Math.min(worldH * 0.55, targetH);

    if (i < count) {
      if (worldAnim.buildings[i]) {
        worldAnim.buildings[i].targetH = targetH;
        worldAnim.buildings[i].w = bw;
      } else {
        buildings.push({
          x: 15 + i * ((worldW - 30) / Math.max(count, 1)),
          w: bw, h: 0, targetH,
          crane: targetH > (worldAnim.buildings[i]?.h || 0) + 10,
          damage: 0, // 0-1, visual damage overlay
        });
      }
    }
  }
  // Keep existing, add new
  worldAnim.buildings = [...worldAnim.buildings.slice(0, count), ...buildings.slice(worldAnim.buildings.length)];
  // Remove excess
  worldAnim.buildings = worldAnim.buildings.slice(0, count);
}

function tickWorldAnim(p) {
  const now = Date.now();

  // Animate buildings growing/shrinking
  worldAnim.buildings.forEach(b => {
    const diff = b.targetH - b.h;
    if (Math.abs(diff) > 0.5) {
      b.h += diff * 0.04; // Smooth lerp
      if (diff > 5) b.crane = true;
    } else {
      b.h = b.targetH;
      b.crane = false;
    }
    // Heal damage over time
    if (b.damage > 0) b.damage = Math.max(0, b.damage - 0.002);
  });

  // Character walk
  worldAnim.character.frame = (worldAnim.character.frame + 0.08) % 4;
  const targetX = 20 + (p.actHist.length % 8) * (worldW / 10);
  worldAnim.character.x += (targetX - worldAnim.character.x) * 0.02;

  // Weather particles
  if (G.worldTension > 50) {
    // Rain
    if (Math.random() < (G.worldTension - 50) / 200) {
      worldAnim.weather.push({
        x: Math.random() * worldW, y: 0,
        vy: 3 + Math.random() * 2, type: 'rain', life: 1,
      });
    }
  }
  if (G.worldTension > 75 && Math.random() < 0.01) {
    // Lightning
    worldAnim.weather.push({ type: 'lightning', life: 0.3, x: Math.random() * worldW });
  }

  // Tick weather
  worldAnim.weather = worldAnim.weather.filter(w => {
    if (w.type === 'rain') {
      w.y += w.vy;
      return w.y < worldH;
    }
    if (w.type === 'lightning') {
      w.life -= 0.02;
      return w.life > 0;
    }
    return false;
  });
}

function drawWorld(p) {
  if (!worldCtx) return;
  const W = worldW, H = worldH;
  const ctx = worldCtx;

  // Sky gradient based on stance + tension
  const skyColors = {
    DO: [`#0a1628`,`#1a3a6a`], IO: [`#1a0a28`,`#3a1a5a`],
    DP: [`#0a140a`,`#1a3a1a`], IP: [`#1a1408`,`#3a2a10`],
  };
  const tensionDarken = G.worldTension / 300;
  const [skyTop, skyBot] = skyColors[p.stance] || skyColors.DO;
  const skyGrad = ctx.createLinearGradient(0, 0, 0, H);
  skyGrad.addColorStop(0, skyTop);
  skyGrad.addColorStop(1, skyBot);
  ctx.fillStyle = skyGrad;
  ctx.fillRect(0, 0, W, H);

  // Darken sky with tension
  if (tensionDarken > 0.05) {
    ctx.fillStyle = `rgba(0,0,0,${tensionDarken})`;
    ctx.fillRect(0, 0, W, H);
  }

  // Stars (twinkle)
  const now = Date.now();
  for (let i = 0; i < 35; i++) {
    const sx = ((42 * i * 137) % W), sy = ((42 * i * 73) % (H * 0.5));
    const bright = 0.2 + Math.sin(now * 0.001 + i * 1.7) * 0.4;
    ctx.globalAlpha = Math.max(0, bright);
    ctx.fillStyle = '#fff';
    ctx.fillRect(Math.floor(sx), Math.floor(sy), 1, 1);
  }
  ctx.globalAlpha = 1;

  // Lightning flash
  worldAnim.weather.filter(w => w.type === 'lightning').forEach(w => {
    ctx.fillStyle = `rgba(255,255,255,${w.life})`;
    ctx.fillRect(0, 0, W, H);
    // Lightning bolt
    ctx.strokeStyle = '#fff';
    ctx.globalAlpha = w.life * 2;
    ctx.lineWidth = 2;
    ctx.beginPath();
    let lx = w.x, ly = 0;
    ctx.moveTo(lx, ly);
    for (let s = 0; s < 6; s++) {
      lx += (Math.random() - 0.5) * 25;
      ly += 10 + Math.random() * 15;
      ctx.lineTo(lx, ly);
    }
    ctx.stroke();
    ctx.globalAlpha = 1;
  });

  // Ground
  const groundY = H * 0.75;
  ctx.fillStyle = '#080810';
  ctx.fillRect(0, groundY, W, H - groundY);

  // Ground line with stance color glow
  ctx.fillStyle = SC[p.stance];
  ctx.globalAlpha = 0.3;
  ctx.fillRect(0, groundY, W, 1);
  ctx.globalAlpha = 0.1;
  ctx.fillRect(0, groundY + 1, W, 2);
  ctx.globalAlpha = 1;

  // Buildings
  const bColors = { DO: '#1a4a6a', IO: '#4a1a4a', DP: '#1a3a1a', IP: '#3a2a0a' };
  const bHiColors = { DO: '#2a6a8a', IO: '#6a2a6a', DP: '#2a5a2a', IP: '#5a3a1a' };

  worldAnim.buildings.forEach((b, i) => {
    if (b.h < 2) return;
    const bx = Math.floor(b.x);
    const bh = Math.floor(b.h);
    const by = Math.floor(groundY - bh);

    // Building body
    ctx.fillStyle = bColors[p.stance];
    ctx.fillRect(bx, by, b.w, bh);

    // Highlight edge
    ctx.fillStyle = bHiColors[p.stance];
    ctx.fillRect(bx, by, 2, bh);

    // Damage overlay (red tint)
    if (b.damage > 0) {
      ctx.fillStyle = `rgba(255,20,20,${b.damage * 0.4})`;
      ctx.fillRect(bx, by, b.w, bh);
      // Damage cracks
      if (b.damage > 0.3) {
        ctx.strokeStyle = `rgba(60,20,20,${b.damage})`;
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(bx + b.w / 2, by);
        ctx.lineTo(bx + b.w / 2 + 3, by + bh * 0.3);
        ctx.lineTo(bx + b.w / 2 - 2, by + bh * 0.6);
        ctx.stroke();
      }
    }

    // Windows
    const winColor = SC[p.stance];
    for (let wy = by + 4; wy < groundY - 4; wy += 7) {
      for (let wx = bx + 3; wx < bx + b.w - 3; wx += 5) {
        // Windows flicker
        const lit = Math.sin(now * 0.0008 + i * 3 + wx * 0.5 + wy * 0.3) > -0.2;
        if (lit) {
          ctx.globalAlpha = 0.3 + Math.sin(now * 0.002 + wx + wy) * 0.2;
          ctx.fillStyle = winColor;
          ctx.fillRect(wx, wy, 2, 3);
        }
      }
    }
    ctx.globalAlpha = 1;

    // Construction crane
    if (b.crane && b.h > 10) {
      ctx.strokeStyle = '#888';
      ctx.lineWidth = 1;
      // Vertical mast
      ctx.beginPath();
      ctx.moveTo(bx + b.w / 2, by);
      ctx.lineTo(bx + b.w / 2, by - 12);
      ctx.stroke();
      // Boom arm
      const armSwing = Math.sin(now * 0.001 + i) * 8;
      ctx.beginPath();
      ctx.moveTo(bx + b.w / 2, by - 11);
      ctx.lineTo(bx + b.w / 2 + armSwing + 10, by - 11);
      ctx.stroke();
      // Cable
      ctx.strokeStyle = '#666';
      ctx.beginPath();
      ctx.moveTo(bx + b.w / 2 + armSwing + 10, by - 11);
      ctx.lineTo(bx + b.w / 2 + armSwing + 10, by - 5);
      ctx.stroke();
    }

    // Antenna on tall buildings
    if (bh > H * 0.35) {
      ctx.fillStyle = '#555';
      ctx.fillRect(bx + b.w / 2, by - 6, 1, 6);
      if (Math.sin(now * 0.003 + i) > 0) {
        ctx.fillStyle = '#ff0000';
        ctx.fillRect(bx + b.w / 2, by - 7, 2, 2);
      }
    }
  });

  // Rain
  ctx.strokeStyle = 'rgba(100,140,200,0.3)';
  ctx.lineWidth = 1;
  worldAnim.weather.filter(w => w.type === 'rain').forEach(w => {
    ctx.beginPath();
    ctx.moveTo(w.x, w.y);
    ctx.lineTo(w.x - 1, w.y + 4);
    ctx.stroke();
  });

  // Stance-specific visual overlays
  if (p.stance === 'DO' && p.hid.conviction > 25) {
    // Beacon of conviction ‚Äî pulsing vertical light
    const pulse = 0.1 + Math.sin(now * 0.002) * 0.05;
    ctx.globalAlpha = (p.hid.conviction / 100) * pulse;
    const beamGrad = ctx.createLinearGradient(W / 2, 0, W / 2, groundY);
    beamGrad.addColorStop(0, SC.DO);
    beamGrad.addColorStop(1, 'transparent');
    ctx.fillStyle = beamGrad;
    ctx.fillRect(W / 2 - 3, 0, 6, groundY);
    ctx.globalAlpha = 1;
  }

  if (p.stance === 'IO' && p.hid.optionality > 15) {
    // Network nodes
    const nodes = Math.floor(p.hid.optionality / 12);
    const pts = [];
    ctx.globalAlpha = 0.25;
    for (let i = 0; i < nodes; i++) {
      const nx = 25 + ((i * 97 + 31) % (W - 50));
      const ny = 15 + ((i * 53 + 17) % (groundY - 30));
      pts.push([nx, ny]);
      ctx.fillStyle = SC.IO;
      ctx.fillRect(nx - 1, ny - 1, 3, 3);
    }
    ctx.strokeStyle = SC.IO;
    ctx.lineWidth = 1;
    for (let i = 0; i < pts.length; i++) {
      for (let j = i + 1; j < pts.length; j++) {
        if (Math.abs(pts[i][0] - pts[j][0]) + Math.abs(pts[i][1] - pts[j][1]) < 120) {
          ctx.beginPath();
          ctx.moveTo(pts[i][0], pts[i][1]);
          ctx.lineTo(pts[j][0], pts[j][1]);
          ctx.stroke();
        }
      }
    }
    ctx.globalAlpha = 1;
  }

  if (p.stance === 'DP' && p.hid.resilience > 10) {
    // Fortress wall with battlements
    const wallH = 4 + p.hid.resilience * 0.25;
    ctx.fillStyle = '#2a4a2a';
    ctx.fillRect(0, groundY - wallH, W, wallH);
    // Battlements
    for (let i = 0; i < W; i += 10) {
      ctx.fillRect(i, groundY - wallH - 3, 5, 3);
    }
    // Wall highlight
    ctx.fillStyle = '#3a5a3a';
    ctx.fillRect(0, groundY - wallH, W, 1);
  }

  if (p.stance === 'IP' && p.hid.bureaucracy > 15) {
    // Fog of bureaucracy
    ctx.globalAlpha = Math.min(0.35, p.hid.bureaucracy / 250);
    ctx.fillStyle = '#4a3a20';
    ctx.fillRect(0, 0, W, H);
    ctx.globalAlpha = 1;
  }

  // Character (simple pixel person)
  const charX = Math.floor(worldAnim.character.x);
  const charY = Math.floor(groundY - 8);
  const charFrame = Math.floor(worldAnim.character.frame);
  ctx.fillStyle = SC[p.stance];
  // Head
  ctx.fillRect(charX + 1, charY, 3, 3);
  // Body
  ctx.fillRect(charX + 1, charY + 3, 3, 3);
  // Legs (animated)
  if (charFrame < 2) {
    ctx.fillRect(charX, charY + 6, 2, 2);
    ctx.fillRect(charX + 3, charY + 6, 2, 2);
  } else {
    ctx.fillRect(charX + 1, charY + 6, 1, 2);
    ctx.fillRect(charX + 3, charY + 6, 1, 2);
  }

  // Year watermark
  ctx.fillStyle = '#ffffff';
  ctx.globalAlpha = 0.08;
  ctx.font = '36px "Press Start 2P"';
  ctx.fillText('Y' + G.year, W - 100, H - 12);
  ctx.globalAlpha = 1;
}

function renderWorld() {
  const canvas = document.getElementById('world-canvas');
  if (!canvas) return;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = Math.floor(rect.width);
  canvas.height = Math.floor(Math.max(80, rect.height - 260));
  worldCtx = canvas.getContext('2d');
  worldW = canvas.width;
  worldH = canvas.height;
  initWorldBuildings(cp());
}

// Continuous world animation loop
let worldAnimRunning = false;
function worldAnimLoop() {
  if (!document.getElementById('play-screen').classList.contains('active')) {
    worldAnimRunning = false;
    return;
  }
  const p = cp();
  tickWorldAnim(p);
  drawWorld(p);
  worldAnimRunning = true;
  requestAnimationFrame(worldAnimLoop);
}

function startWorldAnim() {
  if (!worldAnimRunning) {
    worldAnimRunning = true;
    worldAnimLoop();
  }
}

// Trigger damage visual on shock events
function worldShock() {
  worldAnim.buildings.forEach(b => {
    b.damage = Math.min(1, b.damage + 0.4 + Math.random() * 0.3);
  });
}

// Trigger growth burst on opportunity events
function worldOpportunity() {
  worldAnim.buildings.forEach(b => {
    b.targetH = Math.min(worldH * 0.55, b.targetH + 5 + Math.random() * 10);
  });
}

// ‚îÄ‚îÄ ANIMATION LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function animLoop(){tickP();requestAnimationFrame(animLoop);}
animLoop();

window.addEventListener('resize',()=>{
  if(document.getElementById('play-screen').classList.contains('active')) {
    renderWorld();
    startWorldAnim();
  }
});

document.addEventListener('keydown',e=>{
  if(e.key==='Escape'&&document.getElementById('event-overlay').classList.contains('show')){
    sfx('confirm');resolveEvent();
  }
});

showScreen('title-screen');

</script>

</body>
</html>
