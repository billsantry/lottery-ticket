<html lang="en"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NOT A LOTTERY TICKET: 8-BIT FUTURES</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

:root {
  --bg: #0a0a14;
  --panel: #101028;
  --panel-hi: #181840;
  --border: #2a2a5a;
  --text: #c8c8e0;
  --dim: #5a5a7a;
  --accent: #ffcc00;
  --do: #00e5ff;
  --io: #ff6ec7;
  --dp: #76ff03;
  --ip: #ff9100;
  --danger: #ff1744;
  --success: #00e676;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Press Start 2P', monospace;
  overflow: hidden;
  height: 100vh;
  width: 100vw;
}

/* ‚îÄ‚îÄ CRT + SCANLINES ‚îÄ‚îÄ */
#crt {
  pointer-events: none;
  position: fixed;
  inset: 0;
  z-index: 9999;
  background: repeating-linear-gradient(0deg, rgba(0,0,0,0.06) 0px, rgba(0,0,0,0.06) 1px, transparent 1px, transparent 3px);
}
#crt::after {
  content:'';
  position:fixed;
  inset:0;
  background: radial-gradient(ellipse at center, transparent 55%, rgba(0,0,0,0.4) 100%);
}

/* ‚îÄ‚îÄ SCREEN SHAKE ‚îÄ‚îÄ */
#game-root {
  width:100vw; height:100vh;
  position:relative;
  transition: transform 0.05s;
}
#game-root.shake {
  animation: shakeAnim 0.4s ease-out;
}
@keyframes shakeAnim {
  0% { transform: translate(0,0); }
  15% { transform: translate(-8px, 4px); }
  30% { transform: translate(6px, -6px); }
  45% { transform: translate(-4px, 2px); }
  60% { transform: translate(3px, -3px); }
  75% { transform: translate(-2px, 1px); }
  100% { transform: translate(0,0); }
}

/* ‚îÄ‚îÄ PARTICLE CANVAS ‚îÄ‚îÄ */
#particles {
  position: fixed;
  inset: 0;
  z-index: 50;
  pointer-events: none;
}

/* ‚îÄ‚îÄ FLOATING SCORE POPUPS ‚îÄ‚îÄ */
.float-popup {
  position: fixed;
  z-index: 60;
  font-family: 'Press Start 2P', monospace;
  font-size: 12px;
  pointer-events: none;
  animation: floatUp 1.2s ease-out forwards;
  text-shadow: 0 0 8px currentColor;
}
@keyframes floatUp {
  0% { opacity:1; transform: translateY(0) scale(1); }
  60% { opacity:1; transform: translateY(-50px) scale(1.2); }
  100% { opacity:0; transform: translateY(-90px) scale(0.8); }
}

/* ‚îÄ‚îÄ COMBO BANNER ‚îÄ‚îÄ */
#combo-banner {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0);
  z-index: 70;
  font-size: 16px;
  color: var(--accent);
  text-shadow: 0 0 20px rgba(255,204,0,0.8), 0 0 40px rgba(255,204,0,0.4);
  pointer-events: none;
  opacity: 0;
  white-space: nowrap;
}
#combo-banner.show {
  animation: comboPop 1.5s ease-out forwards;
}
@keyframes comboPop {
  0% { opacity:0; transform: translate(-50%,-50%) scale(0.3) rotate(-5deg); }
  15% { opacity:1; transform: translate(-50%,-50%) scale(1.3) rotate(2deg); }
  30% { transform: translate(-50%,-50%) scale(1) rotate(0deg); }
  70% { opacity:1; transform: translate(-50%,-50%) scale(1); }
  100% { opacity:0; transform: translate(-50%,-50%) scale(1.5); }
}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen { display:none; position:absolute; inset:0; }
.screen.active { display:flex; flex-direction:column; align-items:center; justify-content:center; }

/* ‚îÄ‚îÄ TITLE ‚îÄ‚îÄ */
#title-screen {
  text-align: center;
  padding: 20px;
}

.title-main {
  font-size: 10px;
  color: var(--accent);
  letter-spacing: 3px;
  line-height: 2;
  text-shadow: 0 0 15px rgba(255,204,0,0.5);
  animation: titleGlow 2s ease-in-out infinite alternate;
  margin-bottom: 4px;
}
@keyframes titleGlow {
  from { text-shadow: 0 0 10px rgba(255,204,0,0.4); }
  to { text-shadow: 0 0 25px rgba(255,204,0,0.8), 0 2px 30px rgba(255,204,0,0.3); }
}

.title-sub {
  font-size: 7px;
  color: var(--dim);
  margin-bottom: 40px;
  line-height: 1.8;
}

.title-coin {
  font-size: 28px;
  margin: 16px 0 24px;
  animation: coinSpin 3s linear infinite;
  display: inline-block;
}
@keyframes coinSpin {
  0% { transform: scaleX(1); }
  25% { transform: scaleX(0.1); }
  50% { transform: scaleX(1); }
  75% { transform: scaleX(0.1); }
  100% { transform: scaleX(1); }
}

.menu-btn {
  display: block;
  width: 320px;
  margin: 6px auto;
  padding: 14px 18px;
  background: transparent;
  border: 2px solid var(--border);
  color: var(--text);
  font-family: 'Press Start 2P', monospace;
  font-size: 9px;
  cursor: pointer;
  text-align: center;
  transition: all 0.15s;
  position: relative;
  overflow: hidden;
}
.menu-btn::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(90deg, transparent, rgba(255,204,0,0.1), transparent);
  transform: translateX(-100%);
  transition: transform 0.4s;
}
.menu-btn:hover::before { transform: translateX(100%); }
.menu-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
  box-shadow: 0 0 15px rgba(255,204,0,0.15), inset 0 0 15px rgba(255,204,0,0.05);
}

.menu-hint {
  font-size: 6px;
  color: var(--dim);
  margin-top: 4px;
  display: block;
}

.blink-text {
  animation: blink 1.2s step-start infinite;
  font-size: 7px;
  color: var(--dim);
  margin-top: 30px;
}
@keyframes blink {
  50% { opacity: 0; }
}

/* ‚îÄ‚îÄ STANCE SELECT ‚îÄ‚îÄ */
#stance-screen {
  padding: 20px;
  max-width: 900px;
  width: 100%;
}

.stance-title {
  font-size: 10px;
  color: var(--accent);
  text-align: center;
  margin-bottom: 20px;
}

.stance-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 16px;
}

.stance-card {
  padding: 14px;
  border: 2px solid var(--border);
  background: var(--panel);
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}
.stance-card::after {
  content: '';
  position: absolute;
  inset: 0;
  opacity: 0;
  transition: opacity 0.3s;
}
.stance-card:hover { transform: translateY(-2px); }
.stance-card.sel {
  transform: scale(1.02);
}

.stance-card[data-s="DO"] { border-color: #00e5ff33; }
.stance-card[data-s="DO"].sel { border-color: var(--do); box-shadow: 0 0 20px rgba(0,229,255,0.2), inset 0 0 30px rgba(0,229,255,0.05); }
.stance-card[data-s="DO"]::after { background: radial-gradient(circle at 30% 30%, rgba(0,229,255,0.08), transparent 70%); }
.stance-card[data-s="DO"]:hover::after, .stance-card[data-s="DO"].sel::after { opacity:1; }

.stance-card[data-s="IO"] { border-color: #ff6ec733; }
.stance-card[data-s="IO"].sel { border-color: var(--io); box-shadow: 0 0 20px rgba(255,110,199,0.2), inset 0 0 30px rgba(255,110,199,0.05); }
.stance-card[data-s="IO"]::after { background: radial-gradient(circle at 70% 30%, rgba(255,110,199,0.08), transparent 70%); }
.stance-card[data-s="IO"]:hover::after, .stance-card[data-s="IO"].sel::after { opacity:1; }

.stance-card[data-s="DP"] { border-color: #76ff0333; }
.stance-card[data-s="DP"].sel { border-color: var(--dp); box-shadow: 0 0 20px rgba(118,255,3,0.2), inset 0 0 30px rgba(118,255,3,0.05); }
.stance-card[data-s="DP"]::after { background: radial-gradient(circle at 30% 70%, rgba(118,255,3,0.08), transparent 70%); }
.stance-card[data-s="DP"]:hover::after, .stance-card[data-s="DP"].sel::after { opacity:1; }

.stance-card[data-s="IP"] { border-color: #ff910033; }
.stance-card[data-s="IP"].sel { border-color: var(--ip); box-shadow: 0 0 20px rgba(255,145,0,0.2), inset 0 0 30px rgba(255,145,0,0.05); }
.stance-card[data-s="IP"]::after { background: radial-gradient(circle at 70% 70%, rgba(255,145,0,0.08), transparent 70%); }
.stance-card[data-s="IP"]:hover::after, .stance-card[data-s="IP"].sel::after { opacity:1; }

.sc-tag {
  display: inline-block;
  padding: 2px 8px;
  font-size: 7px;
  color: #000;
  margin-right: 6px;
}
.sc-name { font-size: 8px; margin-bottom: 8px; }
.sc-desc { font-size: 6px; color: var(--dim); line-height: 1.8; margin-bottom: 6px; }
.sc-stats { font-size: 6px; color: var(--dim); line-height: 2; }

.go-btn {
  display: block;
  margin: 0 auto;
  font-family: 'Press Start 2P', monospace;
  font-size: 10px;
  padding: 14px 40px;
  border: 2px solid var(--accent);
  background: transparent;
  color: var(--accent);
  cursor: pointer;
  transition: all 0.15s;
}
.go-btn:hover { background: var(--accent); color: #000; box-shadow: 0 0 25px rgba(255,204,0,0.3); }
.go-btn:disabled { opacity: 0.25; cursor: default; }

/* ‚îÄ‚îÄ MAIN GAME ‚îÄ‚îÄ */
#play-screen {
  display: none;
  padding: 8px;
}
#play-screen.active {
  display: grid;
  grid-template-rows: auto auto 1fr auto;
  gap: 6px;
  height: 100vh;
  width: 100vw;
}

/* TOP HUD */
.hud {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 14px;
  background: var(--panel);
  border: 2px solid var(--border);
  font-size: 7px;
}
.hud-stance {
  padding: 3px 10px;
  font-size: 8px;
  color: #000;
}
.hud-year { color: var(--accent); font-size: 10px; }
.hud-score { font-size: 9px; }
.score-num { transition: all 0.3s; }
.score-num.pulse { animation: scorePulse 0.4s ease-out; }
@keyframes scorePulse {
  0% { transform: scale(1); }
  40% { transform: scale(1.5); color: var(--accent); }
  100% { transform: scale(1); }
}

/* TIMER BAR */
.timer-row {
  height: 6px;
  background: #000;
  border: 1px solid var(--border);
  overflow: hidden;
}
.timer-fill {
  height: 100%;
  background: var(--accent);
  transition: width 0.1s linear;
}
.timer-fill.low { background: var(--danger); animation: timerPulse 0.5s infinite; }
@keyframes timerPulse {
  50% { opacity: 0.5; }
}

/* RESOURCE BARS */
.res-row {
  display: flex;
  gap: 12px;
  padding: 6px 14px;
  background: var(--panel);
  border: 2px solid var(--border);
  font-size: 7px;
  align-items: center;
  flex-wrap: wrap;
}
.res-item {
  display: flex;
  align-items: center;
  gap: 5px;
}
.res-bar {
  width: 55px;
  height: 10px;
  background: #0a0a0a;
  border: 1px solid #333;
  position: relative;
  overflow: hidden;
}
.res-fill {
  height: 100%;
  transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1);
  position: relative;
}
.res-fill::after {
  content: '';
  position: absolute;
  top: 0;
  right: 0;
  width: 3px;
  height: 100%;
  background: rgba(255,255,255,0.4);
}
.res-fill.flash { animation: resFlash 0.3s ease-out; }
@keyframes resFlash {
  0% { filter: brightness(2); }
  100% { filter: brightness(1); }
}
.res-val {
  min-width: 24px;
  text-align: right;
  font-size: 7px;
  transition: color 0.3s;
}
.res-val.up { color: var(--success); }
.res-val.down { color: var(--danger); }

.hv-item {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 2px 8px;
  border: 1px solid var(--border);
  background: rgba(0,0,0,0.4);
  font-size: 6px;
}
.hv-bar {
  width: 50px;
  height: 6px;
  background: #0a0a0a;
  border: 1px solid #333;
  overflow: hidden;
}
.hv-fill { height: 100%; transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1); }

/* MAIN SPLIT */
.main-area {
  display: grid;
  grid-template-columns: 1fr 220px;
  gap: 6px;
  min-height: 0;
  overflow: hidden;
}

/* WORLD CANVAS */
.world-col {
  display: flex;
  flex-direction: column;
  gap: 6px;
  min-height: 0;
}
#world-canvas {
  flex: 1;
  width: 100%;
  background: var(--panel);
  border: 2px solid var(--border);
  image-rendering: pixelated;
  min-height: 120px;
}
.action-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(165px, 1fr));
  gap: 5px;
  overflow-y: auto;
  max-height: 210px;
  padding: 4px;
}

.act-card {
  padding: 8px;
  border: 2px solid var(--border);
  background: var(--panel);
  cursor: pointer;
  transition: all 0.15s;
  font-size: 6px;
  position: relative;
  overflow: hidden;
}
.act-card::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.03), transparent 60%);
}
.act-card:hover:not(.off) {
  border-color: var(--accent);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}
.act-card.off {
  opacity: 0.25;
  cursor: default;
  filter: grayscale(0.8);
}
.act-card.used {
  border-color: var(--success);
  box-shadow: inset 0 0 12px rgba(0,230,118,0.08);
}
.act-card .act-name {
  font-size: 7px;
  margin-bottom: 3px;
  color: var(--text);
}
.act-card .act-cost {
  color: var(--dim);
  margin-bottom: 2px;
}
.act-card .act-fx {
  color: #8f8;
  line-height: 1.6;
}
.act-tag {
  position: absolute;
  top: 3px;
  right: 4px;
  font-size: 5px;
  padding: 1px 4px;
  color: #000;
}

/* ACTION COUNT */
.act-count {
  text-align: center;
  font-size: 8px;
  padding: 6px;
  color: var(--accent);
  border: 1px dashed var(--border);
  margin-bottom: 4px;
  background: var(--panel);
}

/* LOG PANEL */
.log-col {
  display: flex;
  flex-direction: column;
  background: var(--panel);
  border: 2px solid var(--border);
  overflow: hidden;
}
.log-title {
  font-size: 7px;
  color: var(--accent);
  padding: 8px;
  border-bottom: 1px solid var(--border);
}
.log-list {
  flex: 1;
  overflow-y: auto;
  padding: 6px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.log-entry {
  padding: 6px;
  font-size: 6px;
  line-height: 1.6;
  border-left: 3px solid var(--border);
  background: rgba(0,0,0,0.25);
  animation: logSlideIn 0.3s ease-out;
}
@keyframes logSlideIn {
  from { opacity: 0; transform: translateX(15px); }
  to { opacity: 1; transform: translateX(0); }
}
.log-entry.t-shock { border-color: var(--danger); }
.log-entry.t-opp { border-color: var(--success); }
.log-entry.t-shift { border-color: var(--io); }
.log-entry.t-singular { border-color: var(--accent); background: rgba(255,204,0,0.04); }
.log-entry.t-action { border-color: var(--do); }
.log-entry.t-year { border-color: var(--dim); color: var(--dim); font-style: italic; }

/* BOTTOM */
.bot-bar {
  display: flex;
  justify-content: center;
  gap: 10px;
  padding: 6px;
}
.g-btn {
  font-family: 'Press Start 2P', monospace;
  font-size: 9px;
  padding: 12px 28px;
  border: 2px solid var(--accent);
  background: transparent;
  color: var(--accent);
  cursor: pointer;
  transition: all 0.15s;
  position: relative;
  overflow: hidden;
}
.g-btn::after {
  content: '';
  position: absolute;
  inset: 0;
  background: var(--accent);
  opacity: 0;
  transition: opacity 0.15s;
}
.g-btn:hover::after { opacity: 0.15; }
.g-btn:hover { box-shadow: 0 0 20px rgba(255,204,0,0.2); }
.g-btn:disabled { opacity: 0.2; cursor: default; }
.g-btn:disabled:hover::after { opacity: 0; }
.g-btn.sec { border-color: var(--border); color: var(--dim); }
.g-btn.sec:hover { border-color: var(--dim); }

/* ‚îÄ‚îÄ EVENT OVERLAY ‚îÄ‚îÄ */
#event-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0);
  z-index: 80;
  display: none;
  align-items: center;
  justify-content: center;
  transition: background 0.4s;
}
#event-overlay.show {
  display: flex;
  background: rgba(0,0,0,0.75);
}
.evt-box {
  max-width: 500px;
  width: 90%;
  padding: 28px;
  background: var(--panel);
  border: 3px solid var(--border);
  text-align: center;
  transform: scale(0.8);
  opacity: 0;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
#event-overlay.show .evt-box {
  transform: scale(1);
  opacity: 1;
}
.evt-type {
  font-size: 7px;
  letter-spacing: 3px;
  margin-bottom: 10px;
  text-transform: uppercase;
}
.evt-name {
  font-size: 11px;
  color: var(--accent);
  margin-bottom: 14px;
  line-height: 1.8;
  text-shadow: 0 0 10px rgba(255,204,0,0.3);
}
.evt-desc {
  font-size: 7px;
  color: var(--dim);
  line-height: 2;
  margin-bottom: 16px;
  min-height: 40px;
}
.evt-fx {
  font-size: 7px;
  padding: 8px;
  background: rgba(0,0,0,0.4);
  border: 1px solid var(--border);
  margin-bottom: 18px;
  line-height: 2;
}
.fx-pos { color: var(--success); }
.fx-neg { color: var(--danger); }

/* ‚îÄ‚îÄ SUMMARY ‚îÄ‚îÄ */
#summary-screen {
  padding: 20px;
  max-width: 700px;
  width: 100%;
  max-height: 100vh;
  overflow-y: auto;
}
.sum-title {
  font-size: 12px;
  color: var(--accent);
  text-align: center;
  margin-bottom: 8px;
  text-shadow: 0 0 15px rgba(255,204,0,0.5);
}
.sum-ending {
  font-size: 10px;
  text-align: center;
  margin-bottom: 8px;
  line-height: 1.6;
}
.sum-blurb {
  font-size: 7px;
  color: var(--dim);
  line-height: 2;
  padding: 14px;
  border: 1px solid var(--border);
  background: rgba(0,0,0,0.3);
  margin-bottom: 20px;
  text-align: left;
}
.sum-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 1fr;
  gap: 6px;
  margin-bottom: 16px;
}
.sum-stat {
  padding: 10px;
  background: rgba(0,0,0,0.3);
  border: 1px solid var(--border);
  text-align: center;
}
.sum-stat .sl { font-size: 6px; color: var(--dim); margin-bottom: 4px; }
.sum-stat .sv { font-size: 14px; }
.sum-stat .sv.animating {
  animation: countUp 0.6s ease-out;
}
@keyframes countUp {
  from { opacity:0; transform: translateY(10px); }
  to { opacity:1; transform: translateY(0); }
}
.sum-chart {
  margin: 12px 0;
  background: rgba(0,0,0,0.3);
  border: 1px solid var(--border);
  padding: 8px;
}
.sum-chart canvas {
  width: 100%;
  height: 140px;
  image-rendering: pixelated;
}
.sum-achv {
  margin-bottom: 16px;
}
.achv-item {
  font-size: 7px;
  padding: 6px 10px;
  margin: 4px 0;
  border: 1px solid var(--accent);
  background: rgba(255,204,0,0.04);
  animation: achvPop 0.4s ease-out backwards;
}

/* ‚îÄ‚îÄ GLOSSARY ‚îÄ‚îÄ */
#glossary-screen {
  padding: 24px;
  max-width: 700px;
  width: 100%;
  max-height: 100vh;
  overflow-y: auto;
  font-size: 7px;
  line-height: 2.2;
}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media (max-width: 800px) {
  .main-area { grid-template-columns: 1fr; grid-template-rows: 1fr auto 160px; }
  .stance-grid { grid-template-columns: 1fr; }
  .sum-grid { grid-template-columns: 1fr 1fr; }
  .action-grid { max-height: 160px; }
}
</style>
</head>
<body>

<div id="crt"></div>
<canvas id="particles" width="1465" height="429"></canvas>
<div id="combo-banner"></div>

<div id="game-root">
  <!-- ‚ïê‚ïê‚ïê TITLE ‚ïê‚ïê‚ïê -->
  <div id="title-screen" class="screen active">
    <div class="title-coin">üé∞</div>
    <div class="title-main">NOT A LOTTERY TICKET<br>8-BIT FUTURES</div>
    <div class="title-sub">"You are not a lottery ticket." ‚Äî Choose your worldview. Shape your future.</div>
    <button class="menu-btn" onclick="sfx('select');go('stance',1)">1 PLAYER RUN<span class="menu-hint">Solo 12-year strategic run</span></button>
    <button class="menu-btn" onclick="sfx('select');go('stance',2)">2 PLAYER HOT-SEAT<span class="menu-hint">Take turns, share the world</span></button>
    <button class="menu-btn" onclick="sfx('select');showScreen('glossary-screen')">HOW TO PLAY<span class="menu-hint">Worldviews, resources, scoring</span></button>
    <div class="blink-text">INSERT COIN TO START</div>
  </div>

  <!-- ‚ïê‚ïê‚ïê STANCE SELECT ‚ïê‚ïê‚ïê -->
  <div id="stance-screen" class="screen">
    <div class="stance-title" id="stanceTitle">CHOOSE YOUR FUTURE STANCE</div>
    <div class="stance-grid">
      <div class="stance-card" data-s="DO" onclick="pickStance('DO')" tabindex="0">
        <div class="sc-name"><span class="sc-tag" style="background:var(--do)">DO</span> <span style="color:var(--do)">DETERMINATE OPTIMISM</span></div>
        <div class="sc-desc">You have a specific plan for a better future. Concentrate your bets. Build conviction. Compound advantages over time.</div>
        <div class="sc-stats">‚¨Ü HIGH CEILING  ‚¨á MEDIUM FLOOR<br>‚òÖ Rewards: planning, conviction chains, sequencing<br>‚úï Punishes: pivoting, hedging, distraction</div>
      </div>
      <div class="stance-card" data-s="IO" onclick="pickStance('IO')" tabindex="0">
        <div class="sc-name"><span class="sc-tag" style="background:var(--io)">IO</span> <span style="color:var(--io)">INDETERMINATE OPTIMISM</span></div>
        <div class="sc-desc">The future will be better ‚Äî you just don't know how. Diversify. A/B test everything. Optimize process over substance.</div>
        <div class="sc-stats">‚¨Ü MEDIUM CEILING  ‚¨á HIGH FLOOR<br>‚òÖ Rewards: breadth, experiments, diversity<br>‚úï Punishes: tunnel vision, overcommitment</div>
      </div>
      <div class="stance-card" data-s="DP" onclick="pickStance('DP')" tabindex="0">
        <div class="sc-name"><span class="sc-tag" style="background:var(--dp)">DP</span> <span style="color:var(--dp)">DETERMINATE PESSIMISM</span></div>
        <div class="sc-desc">The future looks bleak but you have a plan: ration, defend, build walls. Fortress strategy. Slow and resilient.</div>
        <div class="sc-stats">‚¨Ü LOW CEILING  ‚¨á MEDIUM FLOOR<br>‚òÖ Rewards: reserves, defense, preparation<br>‚úï Punishes: expansion, ambition, speed</div>
      </div>
      <div class="stance-card" data-s="IP" onclick="pickStance('IP')" tabindex="0">
        <div class="sc-name"><span class="sc-tag" style="background:var(--ip)">IP</span> <span style="color:var(--ip)">INDETERMINATE PESSIMISM</span></div>
        <div class="sc-desc">Things will get worse and nobody knows how. Insure everything. Hedge. Comply. Survive by not trying.</div>
        <div class="sc-stats">‚¨Ü LOW CEILING  ‚¨á HIGH SURVIVAL<br>‚òÖ Rewards: insurance, compliance, caution<br>‚úï Punishes: vision, initiative, boldness</div>
      </div>
    </div>
    <button class="go-btn" id="goBtn" disabled="" onclick="sfx('start');beginRun()">‚ñ∂ START RUN</button>
  </div>

  <!-- ‚ïê‚ïê‚ïê PLAY ‚ïê‚ïê‚ïê -->
  <div id="play-screen" class="screen">
    <div class="hud">
      <span class="hud-stance" id="hudStance"></span>
      <span class="hud-year" id="hudYear">YEAR 1 / 12</span>
      <span class="hud-score">SCORE <span class="score-num" id="hudScore">0</span></span>
      <span id="hudPlayer" style="display:none;font-size:7px;"></span>
    </div>
    <div class="timer-row"><div class="timer-fill" id="timerFill" style="width:100%"></div></div>
    <div class="res-row" id="resRow"></div>

    <div class="main-area">
      <div class="world-col">
        <canvas id="world-canvas"></canvas>
        <div class="act-count" id="actCount">ACTIONS: 3 / 3</div>
        <div class="action-grid" id="actGrid"></div>
      </div>
      <div class="log-col">
        <div class="log-title">‚óà EVENT LOG</div>
        <div class="log-list" id="logList"></div>
      </div>
    </div>

    <div class="bot-bar">
      <button class="g-btn" id="btnEnd" onclick="sfx('confirm');endYear()">END YEAR ‚ñ∂</button>
      <button class="g-btn sec" id="btnUndo" onclick="sfx('back');undo()" disabled="">UNDO</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê EVENT OVERLAY ‚ïê‚ïê‚ïê -->
  <div id="event-overlay">
    <div class="evt-box">
      <div class="evt-type" id="evtType"></div>
      <div class="evt-name" id="evtName"></div>
      <div class="evt-desc" id="evtDesc"></div>
      <div class="evt-fx" id="evtFx"></div>
      <button class="g-btn" onclick="sfx('confirm');resolveEvent()">CONTINUE</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê SUMMARY ‚ïê‚ïê‚ïê -->
  <div id="summary-screen" class="screen"></div>

  <!-- ‚ïê‚ïê‚ïê GLOSSARY ‚ïê‚ïê‚ïê -->
  <div id="glossary-screen" class="screen">
    <div style="text-align:center;font-size:10px;color:var(--accent);margin-bottom:18px;">HOW TO PLAY</div>
    <div style="margin-bottom:10px;"><span style="color:var(--accent);">THE GAME:</span> Each run = 12 Years. Each Year, pick actions to spend resources. An event fires. Your worldview shapes everything. Score is tallied at the end.</div>
    <div style="margin-bottom:10px;"><span style="color:var(--accent);">TIMER:</span> Each year has a countdown. Act fast ‚Äî this is an arcade! If time runs out, the year ends with whatever actions you took.</div>
    <div style="margin-bottom:10px;"><span style="color:var(--do);">DO ‚Äî DETERMINATE OPTIMISM:</span> Chain consistent actions. Build Conviction. The plan compounds. High ceiling, but pivoting kills your momentum.</div>
    <div style="margin-bottom:10px;"><span style="color:var(--io);">IO ‚Äî INDETERMINATE OPTIMISM:</span> Use diverse action types. Build Optionality. You get 4 actions/year. Consistent but capped ‚Äî you drift upward but never break through.</div>
    <div style="margin-bottom:10px;"><span style="color:var(--dp);">DP ‚Äî DETERMINATE PESSIMISM:</span> Hoard and fortify. Build Resilience. Shocks barely hurt you. Slow growth, high survival.</div>
    <div style="margin-bottom:10px;"><span style="color:var(--ip);">IP ‚Äî INDETERMINATE PESSIMISM:</span> Insure and comply. Build Bureaucracy. Only 2 actions/year. You survive everything but build nothing.</div>
    <div style="margin-bottom:10px;"><span style="color:var(--accent);">RESOURCES:</span> ‚è± Time, üí∞ Money, üéØ Focus, ‚≠ê Reputation ‚Äî manage them carefully.</div>
    <div style="margin-bottom:10px;"><span style="color:var(--accent);">THE WORLD:</span> Watch your city grow (or crumble) on the pixel canvas. Buildings, smoke, lightning ‚Äî the world reacts to your choices in real time.</div>
    <div style="margin-bottom:10px;"><span style="color:var(--accent);">SCORING:</span> Breakthrough + Wealth + Impact + Durability. Each stance generates different point mixes. Multiple endings per stance.</div>
    <div style="margin-bottom:16px;"><span style="color:var(--accent);">THE THESIS:</span> "You are not a lottery ticket." Your worldview shapes outcomes through natural mechanisms. Feel why each stance leads where it does.</div>
    <button class="g-btn" onclick="sfx('back');showScreen('title-screen')">BACK</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NOT A LOTTERY TICKET: 8-BIT FUTURES ‚Äî Full Arcade Engine
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ AUDIO (Web Audio API bleeps) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let actx;
function ensureAudio() { if (!actx) actx = new AudioCtx(); }

function sfx(type) {
  try {
    ensureAudio();
    const o = actx.createOscillator();
    const g = actx.createGain();
    o.connect(g); g.connect(actx.destination);
    const t = actx.currentTime;
    switch(type) {
      case 'select':
        o.type='square'; o.frequency.setValueAtTime(440,t); o.frequency.setValueAtTime(660,t+0.06);
        g.gain.setValueAtTime(0.08,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.12);
        o.start(t); o.stop(t+0.12); break;
      case 'confirm':
        o.type='square'; o.frequency.setValueAtTime(523,t); o.frequency.setValueAtTime(784,t+0.08);
        g.gain.setValueAtTime(0.08,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.2);
        o.start(t); o.stop(t+0.2); break;
      case 'start':
        o.type='square';
        o.frequency.setValueAtTime(262,t); o.frequency.setValueAtTime(330,t+0.1); o.frequency.setValueAtTime(392,t+0.2); o.frequency.setValueAtTime(523,t+0.3);
        g.gain.setValueAtTime(0.07,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.45);
        o.start(t); o.stop(t+0.45); break;
      case 'back':
        o.type='triangle'; o.frequency.setValueAtTime(330,t); o.frequency.setValueAtTime(220,t+0.08);
        g.gain.setValueAtTime(0.06,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.15);
        o.start(t); o.stop(t+0.15); break;
      case 'shock':
        o.type='sawtooth'; o.frequency.setValueAtTime(200,t); o.frequency.exponentialRampToValueAtTime(50,t+0.4);
        g.gain.setValueAtTime(0.1,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.5);
        o.start(t); o.stop(t+0.5); break;
      case 'opportunity':
        o.type='sine'; o.frequency.setValueAtTime(440,t); o.frequency.setValueAtTime(880,t+0.15);
        g.gain.setValueAtTime(0.06,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.3);
        o.start(t); o.stop(t+0.3); break;
      case 'singular':
        o.type='sine';
        o.frequency.setValueAtTime(262,t); o.frequency.setValueAtTime(523,t+0.15); o.frequency.setValueAtTime(784,t+0.3); o.frequency.setValueAtTime(1047,t+0.45);
        g.gain.setValueAtTime(0.08,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.7);
        o.start(t); o.stop(t+0.7); break;
      case 'tick':
        o.type='sine'; o.frequency.setValueAtTime(800,t);
        g.gain.setValueAtTime(0.03,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.04);
        o.start(t); o.stop(t+0.04); break;
      case 'endgame':
        o.type='triangle';
        o.frequency.setValueAtTime(523,t); o.frequency.setValueAtTime(659,t+0.2); o.frequency.setValueAtTime(784,t+0.4); o.frequency.setValueAtTime(1047,t+0.6);
        g.gain.setValueAtTime(0.08,t); g.gain.exponentialRampToValueAtTime(0.001,t+1);
        o.start(t); o.stop(t+1); break;
    }
  } catch(e) {}
}

// ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const pCanvas = document.getElementById('particles');
const pCtx = pCanvas.getContext('2d');
let particles = [];

function resizeParticles() {
  pCanvas.width = window.innerWidth;
  pCanvas.height = window.innerHeight;
}
resizeParticles();
window.addEventListener('resize', resizeParticles);

function spawnParticles(x, y, count, color, spread = 80) {
  for (let i = 0; i < count; i++) {
    particles.push({
      x, y,
      vx: (Math.random() - 0.5) * spread * 0.1,
      vy: (Math.random() - 0.5) * spread * 0.1 - 2,
      life: 1,
      decay: 0.015 + Math.random() * 0.02,
      size: 2 + Math.random() * 3,
      color
    });
  }
}

function tickParticles() {
  pCtx.clearRect(0, 0, pCanvas.width, pCanvas.height);
  particles = particles.filter(p => p.life > 0);
  particles.forEach(p => {
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.05;
    p.life -= p.decay;
    pCtx.globalAlpha = p.life;
    pCtx.fillStyle = p.color;
    pCtx.fillRect(Math.round(p.x), Math.round(p.y), p.size, p.size);
  });
  pCtx.globalAlpha = 1;
}

// ‚îÄ‚îÄ FLOATING POPUPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function floatPopup(x, y, text, color) {
  const el = document.createElement('div');
  el.className = 'float-popup';
  el.textContent = text;
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  el.style.color = color;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1300);
}

// ‚îÄ‚îÄ COMBO BANNER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showCombo(text) {
  const el = document.getElementById('combo-banner');
  el.textContent = text;
  el.className = '';
  void el.offsetWidth;
  el.className = 'show';
  setTimeout(() => el.className = '', 1600);
}

// ‚îÄ‚îÄ SCREEN SHAKE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function shake() {
  const root = document.getElementById('game-root');
  root.classList.remove('shake');
  void root.offsetWidth;
  root.classList.add('shake');
  setTimeout(() => root.classList.remove('shake'), 500);
}

// ‚îÄ‚îÄ SCREEN MANAGEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// ‚îÄ‚îÄ GAME STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const G = {
  mode: 1,
  players: [],
  cp: 0,
  year: 1,
  maxYears: 12,
  log: [],
  worldTension: 50,
  evtHist: [],
  timerInterval: null,
  timerLeft: 0,
  timerMax: 30,
  pendingStances: [],
  pendingEvent: null,
};

function mkPlayer(stance) {
  const p = {
    stance,
    res: { time:80, money:60, focus:70, rep:50 },
    caps: { time:100, money:200, focus:100, rep:100 },
    hid: { conviction:0, optionality:0, resilience:0, bureaucracy:0 },
    score: { breakthrough:0, wealth:0, impact:0, durability:0 },
    total: 0,
    actMax: 3,
    actUsed: 0,
    actHist: [],
    yearHist: [],
    planChain: 0,
    divSet: new Set(),
    insurance: 0,
    reserve: 0,
    shipped: 0,
    protos: 0,
    undos: [],
    traits: {},
  };
  switch(stance) {
    case 'DO': p.res.focus=80; p.hid.conviction=20; break;
    case 'IO': p.res.money=70; p.actMax=4; p.hid.optionality=20; break;
    case 'DP': p.res.money=50; p.res.rep=40; p.hid.resilience=20; p.reserve=10; break;
    case 'IP': p.res.money=55; p.res.focus=50; p.actMax=2; p.hid.bureaucracy=25; p.insurance=15; break;
  }
  return p;
}
function cp() { return G.players[G.cp]; }
const SC = { DO:'#00e5ff', IO:'#ff6ec7', DP:'#76ff03', IP:'#ff9100' };

// ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ACTS = [
  { id:'plan', name:'WRITE THE SECRET PLAN', s:['DO'], cost:{time:15,focus:20}, fx:{conviction:15}, delayed:{breakthrough:8}, desc:'+15 Conviction. Compounding begins.', tag:'PLAN' },
  { id:'proto', name:'BUILD PROTOTYPE', s:['DO','IO'], cost:{time:20,money:15}, fx:{rep:5}, delayed:{breakthrough:12,wealth:5}, desc:'+5 Rep. Breakthrough potential.', tag:'BUILD' },
  { id:'hire_s', name:'HIRE SPECIALISTS', s:['DO'], cost:{money:25,time:10}, fx:{focus:15,conviction:8}, delayed:{breakthrough:10}, desc:'+15 Focus, +8 Conviction.', tag:'TEAM' },
  { id:'ship', name:'SHIP PRODUCT', s:['DO','IO'], cost:{time:25,focus:15,money:10}, fx:{money:20,rep:15}, delayed:{wealth:15,impact:5}, desc:'Revenue + reputation. Big move.', tag:'SHIP' },
  { id:'double', name:'DOUBLE DOWN', s:['DO'], cost:{money:30,focus:20}, fx:{conviction:25}, delayed:{breakthrough:20}, desc:'All-in on your plan. +25 Conviction.', tag:'FOCUS' },
  { id:'expand', name:'EXPAND MARKET', s:['DO','IO'], cost:{money:20,time:15,rep:5}, fx:{rep:10}, delayed:{wealth:15,impact:10}, desc:'Go bigger. New markets.', tag:'GROW' },
  { id:'ab', name:'A/B TEST EVERYTHING', s:['IO'], cost:{time:10,money:10}, fx:{optionality:15}, delayed:{wealth:5}, desc:'+15 Optionality. Data-driven.', tag:'TEST' },
  { id:'diversify', name:'DIVERSIFY BETS', s:['IO'], cost:{money:20}, fx:{optionality:20}, delayed:{wealth:8,durability:5}, desc:'Spread your portfolio wide.', tag:'SPREAD' },
  { id:'network', name:'NETWORK AGGRESSIVELY', s:['IO','DO'], cost:{time:15,focus:10}, fx:{rep:15,optionality:10}, delayed:{impact:5}, desc:'Meet everyone. +15 Rep.', tag:'SOCIAL' },
  { id:'refactor', name:'REFACTOR PROCESS', s:['IO'], cost:{time:15,focus:15}, fx:{focus:10,optionality:8}, delayed:{durability:5}, desc:'Optimize systems. Process > substance.', tag:'PROCESS' },
  { id:'pivot', name:'PIVOT STRATEGY', s:['IO'], cost:{time:10,focus:10}, fx:{optionality:15,conviction:-20}, delayed:{}, desc:'New direction. -20 Conviction!', tag:'PIVOT' },
  { id:'hire_g', name:'HIRE GENERALISTS', s:['IO'], cost:{money:15,time:10}, fx:{focus:10,optionality:10}, delayed:{durability:3}, desc:'Flexible team. Jack of all trades.', tag:'TEAM' },
  { id:'save', name:'SAVE CASH', s:['DP','IP'], cost:{time:5}, fx:{money:15,resilience:10}, delayed:{durability:5}, desc:'Hoard. +15 Money, +10 Resilience.', tag:'SAVE' },
  { id:'fortify', name:'FORTIFY POSITION', s:['DP'], cost:{money:15,time:15}, fx:{resilience:20,rep:5}, delayed:{durability:10}, desc:'Build walls. +20 Resilience.', tag:'DEFEND' },
  { id:'ration', name:'RATION RESOURCES', s:['DP'], cost:{focus:10}, fx:{time:10,money:5,resilience:10}, delayed:{durability:5}, desc:'Stretch every unit.', tag:'RATION' },
  { id:'infra', name:'INVEST IN INFRA', s:['DP','DO'], cost:{money:25,time:20}, fx:{resilience:15}, delayed:{wealth:10,durability:15}, desc:'Slow but durable. Build what lasts.', tag:'INFRA' },
  { id:'contingency', name:'PLAN CONTINGENCIES', s:['DP'], cost:{time:15,focus:15}, fx:{resilience:15,conviction:5}, delayed:{durability:8}, desc:'Prepare for every downside.', tag:'PLAN' },
  { id:'cut', name:'CUT COSTS', s:['DP','IP'], cost:{focus:10}, fx:{money:10,rep:-5,resilience:5}, delayed:{durability:3}, desc:'Trim fat. -5 Rep.', tag:'CUT' },
  { id:'insure', name:'BUY INSURANCE', s:['IP'], cost:{money:15}, fx:{bureaucracy:15,resilience:5}, delayed:{durability:5}, desc:'+15 Bureaucracy. Cover every risk.', tag:'INSURE' },
  { id:'lobby', name:'LOBBY REGULATORS', s:['IP','DP'], cost:{money:20,time:10}, fx:{bureaucracy:10,rep:5}, delayed:{durability:5}, desc:'Influence the rules.', tag:'LOBBY' },
  { id:'comply', name:'FULL COMPLIANCE', s:['IP'], cost:{time:15,focus:15}, fx:{bureaucracy:20,rep:5}, delayed:{durability:8}, desc:'Follow every rule. +20 Bureaucracy.', tag:'COMPLY' },
  { id:'hedge', name:'HEDGE EVERYTHING', s:['IP'], cost:{money:20,focus:10}, fx:{bureaucracy:10,optionality:5}, delayed:{durability:5}, desc:'Cancel risk with counter-bets.', tag:'HEDGE' },
  { id:'outsource', name:'OUTSOURCE DECISIONS', s:['IP','IO'], cost:{money:10,focus:5}, fx:{bureaucracy:10,focus:5,conviction:-10}, delayed:{}, desc:'Committees decide. -10 Conviction.', tag:'DEFER' },
  { id:'audit', name:'RUN AN AUDIT', s:['IP','DP'], cost:{time:10,money:10}, fx:{bureaucracy:8,resilience:8,rep:5}, delayed:{durability:5}, desc:'Check everything twice.', tag:'CHECK' },
];

// ‚îÄ‚îÄ EVENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const EVTS = [
  { id:'recession', name:'RECESSION HITS', t:'shock', desc:'Markets crash. Capital evaporates overnight.', fx:{money:-20,rep:-5}, w:{DO:0.8,IO:0.9,DP:0.5,IP:0.7} },
  { id:'competitor', name:'RIVAL EMERGES', t:'shock', desc:'A well-funded competitor appears from nowhere.', fx:{rep:-10,money:-10}, w:{DO:1,IO:0.8,DP:0.6,IP:0.5} },
  { id:'regulation', name:'NEW REGULATIONS', t:'shock', desc:'Government cracks down. Compliance costs spike.', fx:{money:-15,time:-10,focus:-10}, w:{DO:1,IO:0.9,DP:0.7,IP:0.3} },
  { id:'talent_drain', name:'TALENT EXODUS', t:'shock', desc:'Your best people leave for greener pastures.', fx:{focus:-15,rep:-5}, w:{DO:0.7,IO:0.9,DP:0.8,IP:1} },
  { id:'obsolete', name:'TECH OBSOLESCENCE', t:'shock', desc:'Your core tech is suddenly yesterday\'s news.', fx:{focus:-10,conviction:-15,money:-10}, w:{DO:1,IO:0.5,DP:0.6,IP:0.4} },
  { id:'scandal', name:'PUBLIC SCANDAL', t:'shock', desc:'Bad press. Trust collapses overnight.', fx:{rep:-25,money:-5}, w:{DO:0.8,IO:0.7,DP:0.5,IP:0.6}, req:p=>p.res.rep>40 },
  { id:'supply', name:'SUPPLY CRISIS', t:'shock', desc:'Critical components unavailable. Everything stalls.', fx:{money:-15,time:-15}, w:{DO:0.9,IO:0.7,DP:0.4,IP:0.6} },
  { id:'crash', name:'MARKET FREEFALL', t:'shock', desc:'Everything drops. Panic everywhere.', fx:{money:-25,resilience:-5}, w:{DO:0.8,IO:1,DP:0.5,IP:0.6} },
  { id:'lawsuit', name:'FRIVOLOUS LAWSUIT', t:'shock', desc:'Legal headaches consume all bandwidth.', fx:{money:-15,focus:-15,time:-10}, w:{DO:0.7,IO:0.8,DP:0.6,IP:0.3} },
  { id:'departure', name:'KEY PERSON LEAVES', t:'shock', desc:'Your most important ally walks away.', fx:{focus:-10,conviction:-10,rep:-5}, w:{DO:1,IO:0.5,DP:0.7,IP:0.4} },
  { id:'new_tech', name:'BREAKTHROUGH TECH', t:'opportunity', desc:'New technology appears. First-movers win big.', fx:{focus:10,money:10,breakthrough:5}, w:{DO:1.2,IO:0.8,DP:0.5,IP:0.3} },
  { id:'partner', name:'STRATEGIC PARTNER', t:'opportunity', desc:'A powerful ally offers collaboration.', fx:{money:15,rep:15}, w:{DO:1,IO:1,DP:0.6,IP:0.4} },
  { id:'talent', name:'TALENT WAVE', t:'opportunity', desc:'Brilliant people are available and eager.', fx:{focus:15,rep:5}, w:{DO:1,IO:0.9,DP:0.6,IP:0.5} },
  { id:'boom', name:'MARKET BOOM', t:'opportunity', desc:'Demand surges. Money flows freely.', fx:{money:25,rep:5,wealth:5}, w:{DO:1,IO:1,DP:0.5,IP:0.4} },
  { id:'grant', name:'MAJOR GRANT', t:'opportunity', desc:'Free capital. No strings attached.', fx:{money:20}, w:{DO:0.8,IO:0.7,DP:0.8,IP:0.9} },
  { id:'viral', name:'VIRAL MOMENT', t:'opportunity', desc:'Unexpected attention. The world is watching.', fx:{rep:20,money:5}, w:{DO:0.9,IO:1,DP:0.4,IP:0.3}, req:p=>p.shipped>0 },
  { id:'govt_contract', name:'GOV CONTRACT', t:'opportunity', desc:'Stable revenue. Bureaucracy required.', fx:{money:20,bureaucracy:10,durability:5}, w:{DO:0.5,IO:0.6,DP:1,IP:1.2} },
  { id:'mentor', name:'LEGENDARY MENTOR', t:'opportunity', desc:'A visionary offers guidance.', fx:{conviction:15,focus:10,breakthrough:3}, w:{DO:1.2,IO:0.7,DP:0.5,IP:0.3} },
  { id:'buyout', name:'ACQUISITION OFFER', t:'opportunity', desc:'Big payout. But you lose control.', fx:{money:40,wealth:20,conviction:-20}, w:{DO:0.7,IO:1.2,DP:0.5,IP:0.8}, req:p=>p.res.rep>30 },
  { id:'cheap', name:'COSTS PLUMMET', t:'opportunity', desc:'Key inputs become dirt cheap.', fx:{money:15,time:5}, w:{DO:0.8,IO:0.8,DP:1,IP:0.8} },
  { id:'dereg', name:'DEREGULATION', t:'shift', desc:'Rules relax. Builders and movers rejoice.', fx:{money:5,conviction:5,bureaucracy:-10}, w:{DO:1.2,IO:1,DP:0.6,IP:0.4} },
  { id:'culture', name:'CULTURE SHIFT', t:'shift', desc:'Public values change overnight.', fx:{rep:-5,optionality:10}, w:{DO:0.7,IO:1.2,DP:0.5,IP:0.6} },
  { id:'austerity', name:'AUSTERITY ERA', t:'shift', desc:'Everyone tightens belts. Frugality rewarded.', fx:{money:-10,resilience:10}, w:{DO:0.6,IO:0.7,DP:1.2,IP:1} },
  { id:'global', name:'GLOBALIZATION SURGE', t:'shift', desc:'Borders open. New markets, new threats.', fx:{money:5,rep:5,focus:-5}, w:{DO:1,IO:1.1,DP:0.6,IP:0.5} },
  { id:'techlash', name:'TECH BACKLASH', t:'shift', desc:'Public turns against innovation.', fx:{rep:-10,bureaucracy:10,conviction:-5}, w:{DO:0.9,IO:0.8,DP:0.7,IP:1.2} },
  { id:'infra_boom', name:'INFRA BOOM', t:'shift', desc:'Government invests big. Builders benefit.', fx:{money:10,resilience:10}, w:{DO:0.9,IO:0.7,DP:1.2,IP:0.8} },
  { id:'risk_up', name:'RISK APPETITE RISES', t:'shift', desc:'Investors get bold. Moonshots funded.', fx:{money:10,conviction:5,optionality:5}, w:{DO:1.2,IO:1,DP:0.4,IP:0.3} },
  { id:'comply_era', name:'COMPLIANCE ERA', t:'shift', desc:'Audits everywhere. Process wins the day.', fx:{bureaucracy:15,focus:-5}, w:{DO:0.5,IO:0.6,DP:0.8,IP:1.3} },
  { id:'trust', name:'TRUST RENAISSANCE', t:'shift', desc:'Society becomes more cooperative.', fx:{rep:10,focus:5}, w:{DO:1,IO:1,DP:0.8,IP:0.7} },
  { id:'inequality', name:'INEQUALITY CRISIS', t:'shift', desc:'Public demands change. Impact matters.', fx:{rep:-5,impact:5}, w:{DO:0.8,IO:0.7,DP:0.9,IP:0.8} },
  { id:'zero_one', name:'0 ‚Üí 1 BREAKTHROUGH!', t:'singular', desc:'A true original creation. The world will never be the same.', fx:{breakthrough:50,money:30,rep:30,wealth:30,impact:20}, w:{DO:2.5,IO:0.3,DP:0.1,IP:0.05}, req:p=>p.hid.conviction>=40 },
  { id:'monopoly', name:'NATURAL MONOPOLY', t:'singular', desc:'You capture a market completely.', fx:{wealth:40,money:40,rep:10,durability:20}, w:{DO:1.5,IO:0.4,DP:0.5,IP:0.1}, req:p=>p.shipped>=2 },
  { id:'perfect_storm', name:'PERFECT STORM', t:'singular', desc:'Everything goes wrong at once. Only the prepared survive.', fx:{money:-40,rep:-20,focus:-20,time:-20}, w:{DO:0.8,IO:0.8,DP:0.3,IP:0.4} },
  { id:'paradigm', name:'PARADIGM SHIFT', t:'singular', desc:'Reality changes. Adaptable players thrive.', fx:{optionality:20,conviction:-15,money:10}, w:{DO:0.5,IO:1.5,DP:0.4,IP:0.3} },
  { id:'unicorn', name:'UNICORN MOMENT', t:'singular', desc:'Exponential growth. Everything compounds.', fx:{money:50,wealth:30,rep:20,breakthrough:15}, w:{DO:2,IO:0.7,DP:0.1,IP:0.05}, req:p=>p.planChain>=4 },
  { id:'institution', name:'INSTITUTION BORN', t:'singular', desc:'Your creation transcends you. It will outlast everything.', fx:{durability:50,impact:30,rep:20,wealth:15}, w:{DO:1,IO:0.5,DP:1.5,IP:0.2}, req:p=>p.hid.resilience>=40 },
  { id:'black_swan', name:'BLACK SWAN (GOOD)', t:'singular', desc:'Impossible luck. But was it really luck?', fx:{money:35,rep:15,breakthrough:10}, w:{DO:1,IO:1,DP:0.5,IP:0.5} },
  { id:'collapse', name:'TOTAL COLLAPSE', t:'singular', desc:'The entire ecosystem implodes.', fx:{money:-50,rep:-30,focus:-15}, w:{DO:0.8,IO:0.9,DP:0.2,IP:0.3}, req:p=>G.year>=6 },
  { id:'movement', name:'A MOVEMENT IS BORN', t:'singular', desc:'People rally behind your cause.', fx:{impact:40,rep:25,focus:10}, w:{DO:1.2,IO:0.8,DP:0.3,IP:0.1}, req:p=>p.score.impact>=20 },
  { id:'mega_payoff', name:'PORTFOLIO MEGA-PAYOFF', t:'singular', desc:'One of your many bets pays off spectacularly.', fx:{money:40,wealth:25,optionality:10}, w:{DO:0.2,IO:2,DP:0.3,IP:0.4}, req:p=>p.hid.optionality>=40 },
];

// ‚îÄ‚îÄ ENDINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ENDS = {
  DO: [
    { label:'THE VISIONARY', cond:p=>p.score.breakthrough>=50, blurb:'You saw the future and built it with your bare hands. A definite plan, executed with conviction, created something that never existed before. This is 0‚Üí1.', c:'var(--do)' },
    { label:'THE BUILDER', cond:p=>p.score.wealth>=40, blurb:'Your plan wasn\'t perfect, but you stuck with it. The compound interest of conviction paid off. Definite success born of definite thinking.', c:'var(--do)' },
    { label:'THE IDEALIST', cond:p=>p.score.breakthrough>=15, blurb:'You had the vision but the world wasn\'t ready ‚Äî or you weren\'t patient enough. Close, but the future slipped away.', c:'var(--do)' },
    { label:'THE DREAMER', cond:()=>true, blurb:'You bet everything on a specific future that never arrived. Conviction without adaptation becomes delusion. The universe doesn\'t owe you a breakthrough.', c:'var(--do)' },
  ],
  IO: [
    { label:'THE OPTIMIZER', cond:p=>p.total>=80, blurb:'You tested everything, diversified perfectly, and drifted north-east into prosperity. No breakthrough, but an optimized machine. Is this the best we can do?', c:'var(--io)' },
    { label:'THE PORTFOLIO', cond:p=>p.score.wealth>=30, blurb:'Solid returns. No moonshots, no catastrophes. A portfolio of small bets, together sufficient. But did it create anything new?', c:'var(--io)' },
    { label:'THE DRIFTER', cond:p=>p.score.durability>=15, blurb:'Spread wide but thin. Lots of activity, nothing compounded. A/B tests optimized for local maxima while big questions went unasked.', c:'var(--io)' },
    { label:'THE SPREADSHEET', cond:()=>true, blurb:'Process without substance. Testing without thesis. When everything is an option, nothing is a commitment. The future drifted ‚Äî and so did you.', c:'var(--io)' },
  ],
  DP: [
    { label:'THE FORTRESS', cond:p=>p.score.durability>=50, blurb:'You saw the darkness and prepared. While others crashed, you endured. Not glamorous ‚Äî but immortal.', c:'var(--dp)' },
    { label:'THE SURVIVOR', cond:p=>p.score.durability>=30, blurb:'Rationed, fortified, defended. Growth was slow but losses were slower. Durability is its own victory.', c:'var(--dp)' },
    { label:'THE BUNKER', cond:p=>p.res.money>=40, blurb:'You survived ‚Äî but at what cost? Your walls kept danger out but also kept opportunity out.', c:'var(--dp)' },
    { label:'THE RUIN', cond:()=>true, blurb:'Even the fortress fell. Defensive pessimism without sufficient resources is just slow failure.', c:'var(--dp)' },
  ],
  IP: [
    { label:'THE INSTITUTION', cond:p=>p.score.durability>=40, blurb:'You insured everything, followed every rule, outlasted everyone. Not through vision but bureaucratic immortality. The paperwork says: you win.', c:'var(--ip)' },
    { label:'THE BUREAUCRAT', cond:p=>p.hid.bureaucracy>=50, blurb:'Every risk covered. Every form filed. You didn\'t build anything new, but you didn\'t lose anything old.', c:'var(--ip)' },
    { label:'THE STAGNANT', cond:p=>p.res.money>=20, blurb:'Nothing ventured, nothing gained. Your hedges cancelled your bets. You existed, but did you live?', c:'var(--ip)' },
    { label:'THE VOID', cond:()=>true, blurb:'You avoided all risk and found the biggest risk: irrelevance. No vision, no plan, no agency.', c:'var(--ip)' },
  ],
};

const ACHVS = [
  { id:'0to1', name:'0‚Üí1', desc:'Trigger a breakthrough event', chk:p=>p.score.breakthrough>=50 },
  { id:'fort', name:'FORTRESS', desc:'Resilience over 60', chk:p=>p.hid.resilience>=60 },
  { id:'portfolio', name:'PORTFOLIO KING', desc:'Optionality over 70', chk:p=>p.hid.optionality>=70 },
  { id:'paper', name:'PAPER PUSHER', desc:'Bureaucracy over 80', chk:p=>p.hid.bureaucracy>=80 },
  { id:'believer', name:'TRUE BELIEVER', desc:'6+ plan chain', chk:p=>p.planChain>=6 },
  { id:'rich', name:'MONEYBAGS', desc:'End with 150+ Money', chk:p=>p.res.money>=150 },
  { id:'famous', name:'FAMOUS', desc:'Hit 90+ Reputation', chk:p=>p.res.rep>=90 },
  { id:'shipper', name:'SERIAL SHIPPER', desc:'Ship 4+ products', chk:p=>p.shipped>=4 },
];

// ‚îÄ‚îÄ SCREEN FLOW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function go(screen, mode) {
  if (screen === 'stance') {
    G.mode = mode;
    G.pendingStances = [];
    document.getElementById('stanceTitle').textContent = mode === 2 ? 'PLAYER 1: CHOOSE STANCE' : 'CHOOSE YOUR FUTURE STANCE';
    document.querySelectorAll('.stance-card').forEach(c => c.classList.remove('sel'));
    document.getElementById('goBtn').disabled = true;
    showScreen('stance-screen');
  }
}

let pickedStance = null;
function pickStance(s) {
  sfx('select');
  pickedStance = s;
  document.querySelectorAll('.stance-card').forEach(c => c.classList.remove('sel'));
  document.querySelector(`.stance-card[data-s="${s}"]`).classList.add('sel');
  document.getElementById('goBtn').disabled = false;
}

function beginRun() {
  if (!pickedStance) return;
  G.pendingStances.push(pickedStance);
  if (G.mode === 2 && G.pendingStances.length === 1) {
    document.getElementById('stanceTitle').textContent = 'PLAYER 2: CHOOSE STANCE';
    pickedStance = null;
    document.querySelectorAll('.stance-card').forEach(c => c.classList.remove('sel'));
    document.getElementById('goBtn').disabled = true;
    return;
  }
  G.year = 1; G.cp = 0; G.log = []; G.evtHist = []; G.worldTension = 50;
  G.players = G.pendingStances.map(s => mkPlayer(s));
  pickedStance = null;
  showScreen('play-screen');
  startYear();
}

// ‚îÄ‚îÄ YEAR TIMER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startTimer() {
  G.timerLeft = G.timerMax;
  const fill = document.getElementById('timerFill');
  fill.style.width = '100%';
  fill.classList.remove('low');
  clearInterval(G.timerInterval);
  G.timerInterval = setInterval(() => {
    G.timerLeft -= 0.1;
    const pct = Math.max(0, (G.timerLeft / G.timerMax) * 100);
    fill.style.width = pct + '%';
    if (pct < 25) fill.classList.add('low');
    else fill.classList.remove('low');
    if (G.timerLeft <= 5 && G.timerLeft > 0 && Math.round(G.timerLeft * 10) % 10 === 0) sfx('tick');
    if (G.timerLeft <= 0) {
      clearInterval(G.timerInterval);
      sfx('confirm');
      endYear();
    }
  }, 100);
}

// ‚îÄ‚îÄ YEAR LIFECYCLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startYear() {
  const p = cp();
  p.actUsed = 0;
  p.undos = [];
  regen(p);
  startTimer();
  renderHUD();
  renderRes();
  renderActs();
  renderLog();
  renderWorld();
  document.getElementById('btnEnd').disabled = false;
  document.getElementById('btnUndo').disabled = true;
  addLog(`‚îÄ‚îÄ YEAR ${G.year} ‚îÄ‚îÄ`, 't-year');
  if (G.mode === 2) addLog(`Player ${G.cp + 1} (${p.stance}) turn`, 't-year');
}

function regen(p) {
  p.res.time = Math.min(p.caps.time, p.res.time + 15);
  p.res.focus = Math.min(p.caps.focus, p.res.focus + 10);
  p.res.money = Math.min(p.caps.money, p.res.money + 5);
  p.res.rep = Math.max(0, p.res.rep - 2);
  if (p.stance !== 'DO') p.hid.conviction = Math.max(0, p.hid.conviction - 4);
  if (p.stance !== 'IO') p.hid.optionality = Math.max(0, p.hid.optionality - 3);
  if (p.stance !== 'DP') p.hid.resilience = Math.max(0, p.hid.resilience - 2);
  if (p.stance !== 'IP') p.hid.bureaucracy = Math.max(0, p.hid.bureaucracy - 2);
  clampRes(p);
}

function clampRes(p) {
  for (const k in p.res) p.res[k] = Math.max(0, Math.min(p.caps[k], Math.round(p.res[k])));
  for (const k in p.hid) p.hid[k] = Math.max(0, Math.min(100, Math.round(p.hid[k])));
}

function doAction(id) {
  const p = cp();
  if (p.actUsed >= p.actMax) return;
  const act = ACTS.find(a => a.id === id);
  if (!act) return;
  for (const [k,v] of Object.entries(act.cost)) if ((p.res[k]||0) < v) return;

  // Undo snapshot
  p.undos.push(JSON.parse(JSON.stringify({ res:p.res, hid:p.hid, score:p.score, actUsed:p.actUsed, planChain:p.planChain, divSet:[...p.divSet], shipped:p.shipped, protos:p.protos, insurance:p.insurance, reserve:p.reserve })));

  // Pay
  for (const [k,v] of Object.entries(act.cost)) p.res[k] -= v;

  // Immediate
  for (const [k,v] of Object.entries(act.fx)) {
    if (k in p.res) p.res[k] += v;
    else if (k in p.hid) p.hid[k] += v;
  }

  // Delayed/score
  for (const [k,v] of Object.entries(act.delayed || {})) {
    if (k in p.score) p.score[k] += v;
  }

  // Plan chain (DO)
  if (act.s.includes('DO') && p.stance === 'DO' && act.id !== 'pivot') {
    p.planChain++;
    if (p.planChain >= 3) {
      const bonus = Math.floor(p.planChain * 1.5);
      p.score.breakthrough += bonus;
      p.hid.conviction = Math.min(100, p.hid.conviction + 3);
      if (p.planChain === 3) showCombo('PLAN CHAIN √ó3!');
      else if (p.planChain === 5) showCombo('PLAN CHAIN √ó5!!');
      else if (p.planChain >= 7) showCombo('UNSTOPPABLE √ó' + p.planChain + '!!!');
    }
  } else if (p.stance === 'DO' && act.id === 'pivot') {
    p.planChain = 0;
  }

  // Diversity (IO)
  p.divSet.add(act.tag);
  if (p.stance === 'IO' && p.divSet.size >= 4) {
    p.hid.optionality = Math.min(100, p.hid.optionality + 3);
    if (p.divSet.size === 4) showCombo('DIVERSIFIED √ó4!');
    else if (p.divSet.size === 6) showCombo('MAXIMUM OPTIONALITY!');
  }

  if (act.id === 'ship') p.shipped++;
  if (act.id === 'proto') p.protos++;
  if (act.id === 'insure') p.insurance += 10;
  if (act.id === 'fortify' || act.id === 'save') p.reserve += 10;

  p.actUsed++;
  p.actHist.push(act.id);
  clampRes(p);

  // VFX
  sfx('select');
  const card = document.querySelector(`.act-card[data-id="${id}"]`);
  if (card) {
    const r = card.getBoundingClientRect();
    spawnParticles(r.left + r.width/2, r.top, 12, SC[p.stance]);
    floatPopup(r.left + r.width/2 - 20, r.top - 10, act.name.split(' ')[0], SC[p.stance]);
  }

  // Score pulse
  const scoreEl = document.getElementById('hudScore');
  scoreEl.classList.remove('pulse'); void scoreEl.offsetWidth; scoreEl.classList.add('pulse');

  addLog(`‚ñ∂ ${act.name}`, 't-action');
  renderHUD();
  renderRes(true);
  renderActs();
  renderWorld();
  document.getElementById('btnUndo').disabled = false;
}

function undo() {
  const p = cp();
  if (!p.undos.length) return;
  const s = p.undos.pop();
  Object.assign(p, { res:s.res, hid:s.hid, score:s.score, actUsed:s.actUsed, planChain:s.planChain, shipped:s.shipped, protos:s.protos, insurance:s.insurance, reserve:s.reserve });
  p.divSet = new Set(s.divSet);
  p.actHist.pop();
  G.log.pop();
  renderHUD(); renderRes(); renderActs(); renderLog(); renderWorld();
  document.getElementById('btnUndo').disabled = !p.undos.length;
}

function endYear() {
  clearInterval(G.timerInterval);
  const p = cp();
  p.yearHist.push({ y:G.year, money:p.res.money, rep:p.res.rep, conv:p.hid.conviction, opt:p.hid.optionality, res:p.hid.resilience, bur:p.hid.bureaucracy, score:{...p.score} });

  if (G.mode === 2 && G.cp === 0) {
    G.cp = 1;
    startYear();
    return;
  }

  document.getElementById('btnEnd').disabled = true;
  setTimeout(() => generateEvent(), 300);
}

// ‚îÄ‚îÄ EVENT ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateEvent() {
  const p = cp();
  const yf = G.year / G.maxYears;
  let sc = 0.25 + yf * 0.15, oc = 0.30 - yf * 0.05, hc = 0.25, gc = 0.05 + yf * 0.08;
  if (p.hid.resilience > 40) sc *= 0.7;
  if (p.hid.bureaucracy > 40) sc *= 0.8;
  if (p.hid.conviction > 50) gc *= 1.3;
  if (p.hid.optionality > 50) oc *= 1.2;
  const tot = sc+oc+hc+gc;
  sc/=tot; oc/=tot; hc/=tot; gc/=tot;
  const roll = Math.random();
  let type = roll<sc?'shock':roll<sc+oc?'opportunity':roll<sc+oc+hc?'shift':'singular';
  let cands = EVTS.filter(e => e.t===type && (!e.req||e.req(p)) && !G.evtHist.slice(-3).includes(e.id));
  if (!cands.length) cands = EVTS.filter(e => e.t==='shift' && !G.evtHist.slice(-3).includes(e.id));
  if (!cands.length) cands = EVTS.filter(e => e.t==='shift');
  const wt = cands.map(e => ({ e, w: (e.w[p.stance]||0.5) + Math.random()*0.3 }));
  wt.sort((a,b) => b.w - a.w);
  const evt = wt[0].e;
  G.evtHist.push(evt.id);

  // Compute modified effects
  const afx = { ...evt.fx };
  if (evt.t === 'shock') {
    const iProt = Math.min(0.5, p.insurance / 100);
    const rProt = Math.min(0.4, p.hid.resilience / 200);
    const prot = 1 - Math.max(iProt, rProt);
    for (const k in afx) if (afx[k] < 0) afx[k] = Math.round(afx[k] * prot);
  }

  G.pendingEvent = { evt, afx };
  showEventPopup(evt, afx);
}

function showEventPopup(evt, afx) {
  const colors = { shock:'var(--danger)', opportunity:'var(--success)', shift:'var(--io)', singular:'var(--accent)' };
  document.getElementById('evtType').textContent = evt.t.toUpperCase() + ' EVENT';
  document.getElementById('evtType').style.color = colors[evt.t];
  document.getElementById('evtName').textContent = evt.name;

  // Typewriter effect for desc
  const descEl = document.getElementById('evtDesc');
  descEl.textContent = '';
  let di = 0;
  const typewriter = setInterval(() => {
    if (di < evt.desc.length) {
      descEl.textContent += evt.desc[di];
      di++;
    } else clearInterval(typewriter);
  }, 25);

  let fxHTML = '';
  for (const [k,v] of Object.entries(afx)) {
    const sign = v>=0?'+':'';
    const cls = v>=0?'fx-pos':'fx-neg';
    const label = {time:'Time',money:'Money',focus:'Focus',rep:'Rep',conviction:'Conv',optionality:'Opt',resilience:'Res',bureaucracy:'Bur',breakthrough:'Break',wealth:'Wealth',impact:'Impact',durability:'Dur'}[k]||k;
    fxHTML += `<span class="${cls}">${sign}${v} ${label}</span>  `;
  }
  document.getElementById('evtFx').innerHTML = fxHTML;

  const overlay = document.getElementById('event-overlay');
  overlay.classList.add('show');

  // SFX + VFX
  sfx(evt.t === 'singular' ? 'singular' : evt.t === 'shock' ? 'shock' : 'opportunity');
  if (evt.t === 'shock') shake();
  if (evt.t === 'singular') {
    spawnParticles(window.innerWidth/2, window.innerHeight/2, 60, '#ffcc00', 200);
    spawnParticles(window.innerWidth/2, window.innerHeight/2, 40, '#fff', 150);
  }
  if (evt.t === 'shock') spawnParticles(window.innerWidth/2, window.innerHeight/2, 30, '#ff1744', 120);
  if (evt.t === 'opportunity') spawnParticles(window.innerWidth/2, window.innerHeight/2, 25, '#00e676', 100);
}

function resolveEvent() {
  const { evt, afx } = G.pendingEvent;
  const targets = G.mode === 2 ? G.players : [cp()];
  targets.forEach(p => {
    for (const [k,v] of Object.entries(afx)) {
      if (k in p.res) p.res[k] += v;
      else if (k in p.hid) p.hid[k] += v;
      else if (k in p.score) p.score[k] += v;
    }
    clampRes(p);
  });
  if (evt.t==='shock') G.worldTension = Math.min(100, G.worldTension+8);
  else if (evt.t==='opportunity') G.worldTension = Math.max(0, G.worldTension-5);
  addLog(`${evt.t.toUpperCase()}: ${evt.name}`, 't-' + (evt.t==='opportunity'?'opp':evt.t));

  document.getElementById('event-overlay').classList.remove('show');

  if (G.mode === 2) G.cp = 0;
  G.year++;

  if (G.year > G.maxYears) {
    sfx('endgame');
    setTimeout(endRun, 500);
  } else {
    renderWorld();
    startYear();
  }
}

// ‚îÄ‚îÄ END RUN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function endRun() {
  G.players.forEach(p => {
    p.score.breakthrough += Math.floor(p.hid.conviction / 5);
    p.score.durability += Math.floor(p.hid.resilience / 4) + Math.floor(p.hid.bureaucracy / 6);
    p.score.wealth += Math.floor(p.res.money / 5);
    p.score.impact += Math.floor(p.res.rep / 5);
    p.total = p.score.breakthrough + p.score.wealth + p.score.impact + p.score.durability;
  });
  renderSummary();
}

function getEnding(p) {
  for (const e of ENDS[p.stance]) if (e.cond(p)) return e;
  return ENDS[p.stance].slice(-1)[0];
}

function renderSummary() {
  const c = document.getElementById('summary-screen');
  let h = '<div class="sum-title">RUN COMPLETE</div>';
  G.players.forEach((p, idx) => {
    const e = getEnding(p);
    if (G.mode===2) h += `<div style="font-size:9px;color:${SC[p.stance]};text-align:center;margin:10px 0 4px;">PLAYER ${idx+1} ‚Äî ${p.stance}</div>`;
    h += `<div class="sum-ending" style="color:${e.c}">${e.label}</div>`;
    h += `<div class="sum-blurb">${e.blurb}</div>`;
    h += `<div class="sum-grid">
      <div class="sum-stat"><div class="sl">TOTAL</div><div class="sv" style="color:var(--accent)">${p.total}</div></div>
      <div class="sum-stat"><div class="sl">BREAKTHROUGH</div><div class="sv" style="color:var(--do)">${p.score.breakthrough}</div></div>
      <div class="sum-stat"><div class="sl">WEALTH</div><div class="sv" style="color:#ffee58">${p.score.wealth}</div></div>
      <div class="sum-stat"><div class="sl">IMPACT</div><div class="sv" style="color:var(--io)">${p.score.impact}</div></div>
      <div class="sum-stat"><div class="sl">DURABILITY</div><div class="sv" style="color:var(--dp)">${p.score.durability}</div></div>
      <div class="sum-stat"><div class="sl">CONVICTION</div><div class="sv">${p.hid.conviction}</div></div>
      <div class="sum-stat"><div class="sl">PLAN CHAIN</div><div class="sv">${p.planChain}</div></div>
      <div class="sum-stat"><div class="sl">PRODUCTS</div><div class="sv">${p.shipped}</div></div>
    </div>`;
    const achvs = ACHVS.filter(a => a.chk(p));
    if (achvs.length) {
      h += '<div class="sum-achv">';
      achvs.forEach((a,i) => { h += `<div class="achv-item" style="animation-delay:${i*0.15}s">‚òÖ ${a.name} ‚Äî ${a.desc}</div>`; });
      h += '</div>';
    }
    h += `<div class="sum-chart"><canvas id="chart${idx}" width="600" height="140"></canvas></div>`;
  });
  h += `<div style="display:flex;gap:12px;justify-content:center;margin:16px 0;">
    <button class="g-btn" onclick="sfx('start');go('stance',${G.mode})">PLAY AGAIN</button>
    <button class="g-btn sec" onclick="sfx('back');showScreen('title-screen')">TITLE</button>
  </div>`;
  c.innerHTML = h;
  showScreen('summary-screen');
  setTimeout(() => G.players.forEach((p,i) => drawChart(`chart${i}`, p)), 200);
}

function drawChart(id, p) {
  const cv = document.getElementById(id);
  if (!cv || !p.yearHist.length) return;
  const ctx = cv.getContext('2d');
  const W = cv.width, H = cv.height;
  ctx.fillStyle = '#0a0a14'; ctx.fillRect(0,0,W,H);
  // Grid
  ctx.strokeStyle = '#1a1a2a'; ctx.lineWidth = 1;
  for (let i=0;i<5;i++) { const y=H*0.1+i*(H*0.75/4); ctx.beginPath(); ctx.moveTo(20,y); ctx.lineTo(W-10,y); ctx.stroke(); }
  if (p.yearHist.length < 2) return;
  const maxM = Math.max(...p.yearHist.map(y=>y.money),1);
  function line(data, max, color) {
    ctx.strokeStyle=color; ctx.lineWidth=2.5; ctx.beginPath();
    data.forEach((v,i) => {
      const x=(i/(data.length-1))*(W-40)+25, y=H-20-(v/max)*(H-40);
      i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    });
    ctx.stroke();
    // Glow
    ctx.strokeStyle=color; ctx.lineWidth=6; ctx.globalAlpha=0.15;
    ctx.beginPath();
    data.forEach((v,i) => {
      const x=(i/(data.length-1))*(W-40)+25, y=H-20-(v/max)*(H-40);
      i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    }); ctx.stroke(); ctx.globalAlpha=1;
  }
  line(p.yearHist.map(y=>y.money),maxM,'#ffee58');
  line(p.yearHist.map(y=>y.conv),100,'#00e5ff');
  line(p.yearHist.map(y=>y.opt),100,'#ff6ec7');
  line(p.yearHist.map(y=>y.res),100,'#76ff03');
  ctx.font='8px "Press Start 2P"';
  ctx.fillStyle='#ffee58'; ctx.fillText('$',10,14);
  ctx.fillStyle='#00e5ff'; ctx.fillText('C',30,14);
  ctx.fillStyle='#ff6ec7'; ctx.fillText('O',50,14);
  ctx.fillStyle='#76ff03'; ctx.fillText('R',70,14);
  ctx.fillStyle='#444'; ctx.font='7px monospace';
  p.yearHist.forEach((y,i) => { ctx.fillText('Y'+y.y,(i/(p.yearHist.length-1))*(W-40)+20,H-4); });
}

// ‚îÄ‚îÄ RENDERING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHUD() {
  const p = cp();
  const badge = document.getElementById('hudStance');
  badge.textContent = p.stance;
  badge.style.background = SC[p.stance];
  document.getElementById('hudYear').textContent = `YEAR ${G.year} / ${G.maxYears}`;
  document.getElementById('hudScore').textContent = p.score.breakthrough+p.score.wealth+p.score.impact+p.score.durability;
  const pi = document.getElementById('hudPlayer');
  if (G.mode===2) { pi.style.display='inline'; pi.textContent=`P${G.cp+1}`; pi.style.color=SC[p.stance]; }
  else pi.style.display='none';
}

let prevRes = {};
function renderRes(flash) {
  const p = cp();
  const defs = [
    {k:'time',icon:'‚è±',l:'TIME',c:'#42a5f5'},
    {k:'money',icon:'üí∞',l:'MONEY',c:'#ffee58'},
    {k:'focus',icon:'üéØ',l:'FOCUS',c:'#ce93d8'},
    {k:'rep',icon:'‚≠ê',l:'REP',c:'#ef5350'},
  ];
  const hvMap = {DO:{k:'conviction',l:'CONVICTION',c:'var(--do)'},IO:{k:'optionality',l:'OPTIONALITY',c:'var(--io)'},DP:{k:'resilience',l:'RESILIENCE',c:'var(--dp)'},IP:{k:'bureaucracy',l:'BUREAUCRACY',c:'var(--ip)'}};
  let h = '';
  defs.forEach(d => {
    const pct = Math.round((p.res[d.k]/p.caps[d.k])*100);
    const diff = (prevRes[d.k]||0) !== p.res[d.k];
    const dir = p.res[d.k] > (prevRes[d.k]||0) ? 'up' : p.res[d.k] < (prevRes[d.k]||0) ? 'down' : '';
    h += `<div class="res-item">
      <span style="font-size:10px">${d.icon}</span>
      <span>${d.l}</span>
      <div class="res-bar"><div class="res-fill ${flash&&diff?'flash':''}" style="width:${pct}%;background:${d.c}"></div></div>
      <span class="res-val ${flash?dir:''}">${p.res[d.k]}</span>
    </div>`;
  });
  const hv = hvMap[p.stance];
  h += `<div class="hv-item"><span>${hv.l}</span><div class="hv-bar"><div class="hv-fill" style="width:${p.hid[hv.k]}%;background:${hv.c}"></div></div><span>${p.hid[hv.k]}</span></div>`;
  document.getElementById('resRow').innerHTML = h;
  prevRes = { ...p.res };
  // Clear flash classes after animation
  if (flash) setTimeout(() => document.querySelectorAll('.res-val').forEach(el => { el.classList.remove('up','down'); }), 600);
}

function renderActs() {
  const p = cp();
  const rem = p.actMax - p.actUsed;
  document.getElementById('actCount').textContent = `ACTIONS: ${rem} / ${p.actMax}`;
  document.getElementById('actCount').style.color = rem > 0 ? 'var(--accent)' : 'var(--dim)';
  const avail = ACTS.filter(a => a.s.includes(p.stance));
  let h = '';
  avail.forEach(a => {
    let canAfford = true;
    for (const [k,v] of Object.entries(a.cost)) if ((p.res[k]||0)<v) { canAfford=false; break; }
    const off = !canAfford || rem<=0;
    const costStr = Object.entries(a.cost).map(([k,v])=>`-${v}${k[0].toUpperCase()}`).join(' ');
    h += `<div class="act-card ${off?'off':''}" data-id="${a.id}" onclick="${off?'':`doAction('${a.id}')`}">
      <div class="act-tag" style="background:${SC[a.s[0]]}">${a.tag}</div>
      <div class="act-name">${a.name}</div>
      <div class="act-cost">${costStr}</div>
      <div class="act-fx">${a.desc}</div>
    </div>`;
  });
  document.getElementById('actGrid').innerHTML = h;
}

function addLog(text, cls='') {
  G.log.push({text,cls});
  renderLog();
}

function renderLog() {
  const list = document.getElementById('logList');
  let h = '';
  G.log.slice(-25).reverse().forEach(l => {
    h += `<div class="log-entry ${l.cls}">${l.text}</div>`;
  });
  list.innerHTML = h;
}

// ‚îÄ‚îÄ WORLD CANVAS (Pixel City!) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let worldCtx;
function renderWorld() {
  const canvas = document.getElementById('world-canvas');
  if (!canvas) return;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = Math.floor(rect.width);
  canvas.height = Math.floor(Math.max(120, rect.height - 260));
  worldCtx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  const p = cp();

  // Sky gradient based on stance + world tension
  const skyColors = {
    DO: [`#0a1628`,`#1a3a6a`],
    IO: [`#1a0a28`,`#3a1a5a`],
    DP: [`#0a140a`,`#1a3a1a`],
    IP: [`#1a1408`,`#3a2a10`],
  };
  const [skyTop, skyBot] = skyColors[p.stance] || skyColors.DO;
  const skyGrad = worldCtx.createLinearGradient(0,0,0,H);
  skyGrad.addColorStop(0, skyTop);
  skyGrad.addColorStop(1, skyBot);
  worldCtx.fillStyle = skyGrad;
  worldCtx.fillRect(0,0,W,H);

  // Stars
  const starSeed = 42;
  for (let i=0;i<40;i++) {
    const sx = ((starSeed*i*137)%W);
    const sy = ((starSeed*i*73)%(H*0.6));
    const bright = 0.3 + Math.sin(Date.now()*0.002 + i) * 0.3;
    worldCtx.globalAlpha = bright;
    worldCtx.fillStyle = '#fff';
    worldCtx.fillRect(Math.floor(sx), Math.floor(sy), 1, 1);
  }
  worldCtx.globalAlpha = 1;

  // Ground
  const groundY = H * 0.75;
  worldCtx.fillStyle = '#0a0a0a';
  worldCtx.fillRect(0, groundY, W, H - groundY);
  worldCtx.fillStyle = '#1a1a2a';
  worldCtx.fillRect(0, groundY, W, 2);

  // Buildings based on game state
  const wealth = p.score.wealth + p.res.money * 0.3;
  const buildCount = Math.min(20, Math.floor(3 + wealth / 15));
  const maxBuildH = H * 0.55;

  for (let i = 0; i < buildCount; i++) {
    const bx = 15 + i * (W - 30) / buildCount;
    const seed = (i * 7 + 13) * 37;
    const bw = 12 + (seed % 20);
    let bh = 15 + (seed % 30) + (wealth / 8) + (p.score.breakthrough * 1.5);
    bh = Math.min(maxBuildH, bh);

    // Building color by stance
    const bColors = { DO:'#1a4a6a', IO:'#4a1a4a', DP:'#1a3a1a', IP:'#3a2a0a' };
    worldCtx.fillStyle = bColors[p.stance];
    worldCtx.fillRect(Math.floor(bx), Math.floor(groundY - bh), Math.floor(bw), Math.floor(bh));

    // Windows
    const winColor = SC[p.stance];
    for (let wy = groundY - bh + 4; wy < groundY - 4; wy += 8) {
      for (let wx = bx + 3; wx < bx + bw - 3; wx += 6) {
        if (Math.random() > 0.4) {
          worldCtx.globalAlpha = 0.3 + Math.random() * 0.5;
          worldCtx.fillStyle = winColor;
          worldCtx.fillRect(Math.floor(wx), Math.floor(wy), 3, 4);
        }
      }
    }
    worldCtx.globalAlpha = 1;

    // Antenna on tall buildings
    if (bh > maxBuildH * 0.6) {
      worldCtx.fillStyle = '#444';
      worldCtx.fillRect(Math.floor(bx + bw/2), Math.floor(groundY - bh - 8), 1, 8);
      // Blinking light
      if (Math.sin(Date.now() * 0.003 + i) > 0) {
        worldCtx.fillStyle = '#ff0000';
        worldCtx.fillRect(Math.floor(bx + bw/2), Math.floor(groundY - bh - 9), 2, 2);
      }
    }
  }

  // Conviction beam (DO)
  if (p.stance === 'DO' && p.hid.conviction > 30) {
    const beamAlpha = (p.hid.conviction / 100) * 0.3;
    worldCtx.globalAlpha = beamAlpha;
    worldCtx.fillStyle = SC.DO;
    worldCtx.fillRect(W/2 - 2, 0, 4, groundY);
    worldCtx.globalAlpha = 1;
  }

  // Network nodes (IO)
  if (p.stance === 'IO' && p.hid.optionality > 20) {
    const nodes = Math.floor(p.hid.optionality / 10);
    worldCtx.strokeStyle = SC.IO;
    worldCtx.globalAlpha = 0.3;
    worldCtx.lineWidth = 1;
    const pts = [];
    for (let i=0;i<nodes;i++) {
      const nx = 30 + ((i * 97 + 31) % (W - 60));
      const ny = 20 + ((i * 53 + 17) % (groundY - 40));
      pts.push([nx,ny]);
      worldCtx.fillStyle = SC.IO;
      worldCtx.fillRect(nx-1, ny-1, 3, 3);
    }
    for (let i=0;i<pts.length;i++) for (let j=i+1;j<pts.length;j++) {
      if (Math.abs(pts[i][0]-pts[j][0]) + Math.abs(pts[i][1]-pts[j][1]) < 150) {
        worldCtx.beginPath(); worldCtx.moveTo(pts[i][0],pts[i][1]); worldCtx.lineTo(pts[j][0],pts[j][1]); worldCtx.stroke();
      }
    }
    worldCtx.globalAlpha = 1;
  }

  // Fortress walls (DP)
  if (p.stance === 'DP' && p.hid.resilience > 15) {
    const wallH = 5 + p.hid.resilience * 0.3;
    worldCtx.fillStyle = '#2a4a2a';
    worldCtx.fillRect(0, groundY - wallH, W, wallH);
    // Battlements
    for (let i=0;i<W;i+=12) {
      worldCtx.fillRect(i, groundY - wallH - 4, 6, 4);
    }
  }

  // Bureaucracy fog (IP)
  if (p.stance === 'IP' && p.hid.bureaucracy > 20) {
    const fogAlpha = Math.min(0.4, p.hid.bureaucracy / 200);
    worldCtx.globalAlpha = fogAlpha;
    worldCtx.fillStyle = '#4a3a20';
    worldCtx.fillRect(0, 0, W, H);
    worldCtx.globalAlpha = 1;
  }

  // Shock lightning if world tension high
  if (G.worldTension > 70 && Math.random() > 0.7) {
    worldCtx.strokeStyle = '#fff';
    worldCtx.globalAlpha = 0.6;
    worldCtx.lineWidth = 2;
    worldCtx.beginPath();
    let lx = Math.random() * W, ly = 0;
    ctx_moveTo(worldCtx, lx, ly);
    for (let s=0;s<5;s++) {
      lx += (Math.random()-0.5)*30;
      ly += 15 + Math.random()*20;
      worldCtx.lineTo(lx, ly);
    }
    worldCtx.stroke();
    worldCtx.globalAlpha = 1;
  }

  // Year label
  worldCtx.fillStyle = '#ffffff';
  worldCtx.globalAlpha = 0.2;
  worldCtx.font = '40px "Press Start 2P"';
  worldCtx.fillText('Y' + G.year, W - 110, H - 15);
  worldCtx.globalAlpha = 1;
}

function ctx_moveTo(ctx, x, y) { ctx.moveTo(x, y); }

// ‚îÄ‚îÄ ANIMATION LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function animLoop() {
  tickParticles();
  requestAnimationFrame(animLoop);
}
animLoop();

// ‚îÄ‚îÄ WINDOW RESIZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('resize', () => {
  if (document.getElementById('play-screen').classList.contains('active')) renderWorld();
});

// ‚îÄ‚îÄ KEYBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', e => {
  if (e.key === 'Escape' && document.getElementById('event-overlay').classList.contains('show')) {
    sfx('confirm'); resolveEvent();
  }
});

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
showScreen('title-screen');
</script>



</body></html>
